{"version":3,"sources":["src/glsl.ts","../../node_modules/promise-polyfill/src/index.js","../../node_modules/promise-polyfill/src/finally.js","../../src/logger/logger.ts","../../src/core/common.ts","../../src/context/context.ts","../../src/buffers/buffers.ts","../../src/core/iterable.ts","../../src/textures/textures.ts","../../src/core/subscriber.ts","../../src/uniforms/uniforms.ts","../../src/canvas/canvas-timer.ts","../../src/canvas/canvas.ts"],"names":["glsl","exports","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_inheritsLoose","subClass","superClass","prototype","create","constructor","__proto__","_assertThisInitialized","self","ReferenceError","setTimeoutFunc","setTimeout","isArray","x","Boolean","noop","Promise","fn","this","TypeError","_state","_handled","_value","undefined","_deferreds","doResolve","handle","deferred","_immediateFn","cb","onFulfilled","onRejected","ret","e","reject","promise","resolve","push","newValue","then","finale","thisArg","apply","arguments","_unhandledRejectionFn","len","Handler","done","value","reason","ex","prom","callback","all","arr","args","Array","slice","call","remaining","res","val","race","setImmediate","err","console","warn","LoggerLevel","Common","fetch","url","xhr","XMLHttpRequest","onload","response","responseText","onerror","error","Error","ontimeout","onabort","open","send","Logger","log","_console","enabled","level","Log","_console2","Warn","_console3","ContextVersion","ContextError","ContextDefaultVertex","ContextDefaultFragment","ContextDefaultVertex2","ContextDefaultFragment2","ContextVertexBuffers","Context","getContext_","canvas","options","names","context","getContext","getContext2_","getIncludes","input","match","regex","promises","exec","index","chunks","join","isWebGl","WebGLRenderingContext","isWebGl2","window","WebGL2RenderingContext","inferVersion","vertexString","fragmentString","source","indexOf","WebGl2","WebGl","versionDiffers","gl","currentVersion","getVertex","getFragment","tryInferContext","attributes","extensions","errorCallback","handleError","errorCode","html","container","parentNode","innerHTML","BrowserSupport","inferContext","supportedExtensions","getSupportedExtensions","forEach","getExtension","Other","tryGetContext","createShader","type","offset","shader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","lastError","getShaderInfoLog","deleteShader","createProgram","shaders","locations","program","attachShader","bindAttribLocation","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","deleteProgram","createVertexBuffers","vertexBuffers","texcoordIndex","getAttribLocation","texcoord","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","Float32Array","STATIC_DRAW","enableVertexAttribArray","vertexAttribPointer","FLOAT","positionIndex","position","BufferFloatType","StringMap","IterableStringMap","values","_proto","has","hasOwnProperty","set","item","get","callbackfn","reduce","initialValue","previous","BuffersDefaultFragment2","Buffer","BW","BH","buffer","createFramebuffer","texture","getTexture","texParameteri","TEXTURE_2D","TEXTURE_MIN_FILTER","NEAREST","TEXTURE_MAG_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","getFloatType","floatType","extension","extensionName","HALF_FLOAT","HALF_FLOAT_OES","createTexture","activeTexture","TEXTURE0","bindTexture","texImage2D","RGBA16F","RGBA","checkFramebufferStatus","FRAMEBUFFER","FRAMEBUFFER_COMPLETE","resize","bindFramebuffer","pixels","status","minW","Math","min","minH","readPixels","newIndex","newTexture","texSubImage2D","newBuffer","deleteTexture","TextureSourceType","TextureFilteringType","IOBuffer","isValid","_proto2","vertexShader","VERTEX_SHADER","fragmentShader","FRAGMENT_SHADER","output","render","useProgram","viewport","framebufferTexture2D","COLOR_ATTACHMENT0","drawArrays","TRIANGLES","destroy","Buffers","_IterableStringMap","Constructor","protoProps","staticProps","getBuffers","buffers","count","replace","matches","regexp","bufferFragmentString","drawingBufferWidth","drawingBufferHeight","keys","Listener","event","Subscriber","listeners","Set","logListeners","subscribe","listener","add","unsubscribe","delete","unsubscribeAll","clear","on","off","_this","trigger","_len","data","TextureImageExtensions","TextureVideoExtensions","TextureExtensions","concat","isTextureData","object","UniformMethod","UniformType","Texture","_Subscriber","workpath","filtering","Linear","valid","dirty","animated","powerOf2","isPowerOf2","isSafari","test","navigator","userAgent","isTextureUrl","text","split","isTexture","urlElementOrData","getTextureOptions","getMaxTextureSize","getParameter","MAX_TEXTURE_SIZE","prev","curr","params","decodeURIComponent","Number","document","querySelector","HTMLCanvasElement","HTMLImageElement","HTMLVideoElement","element","width","height","setData","Uint8Array","load","setUrl","setElement","sourceType","Url","assign","src","String","ext","pop","toLowerCase","createElement","setAttribute","loop","muted","addEventListener","play","crossOrigin","_this2","originalElement","Element","video","update","setFiltering","message","JSON","stringify","Data","pixelStorei","UNPACK_FLIP_Y_WEBGL","UNPACK_PREMULTIPLY_ALPHA_WEBGL","naturalWidth","naturalHeight","UNSIGNED_BYTE","videoWidth","videoHeight","imageBuffer","tryUpdate","MipMap","wrapS","repeat","REPEAT","wrapT","LINEAR_MIPMAP_LINEAR","LINEAR","generateMipmap","Nearest","Textures","_this3","clean","createOrUpdate","_this4","textureOptions","flag","METHODS_INT","Uniform1i","Uniform2i","Uniform3i","Uniform4i","METHODS_FLOAT","Uniform1f","Uniform2f","Uniform3f","Uniform4f","METHODS_INTV","Uniform1iv","Uniform2iv","Uniform3iv","Uniform4iv","METHODS_FLOATV","Uniform1fv","Uniform2fv","Uniform3fv","Uniform4fv","Uniform","location","getUniformLocation","method","UniformTexture","_Uniform","Uniforms","isDifferent","a","b","f","v","isArrayOfInteger","array","isInteger","isArrayOfNumber","isArrayOfBoolean","isArrayOfTexture","isArrayOfSampler2D","Sampler2D","getType_","Unknown","subject","Float","Bool","getMethod_","isVector","Int","parseUniform","uniform","map","CanvasTimer","delay","current","delta","paused","start","now","performance","pause","next","Canvas","mouse","y","uniforms","textures","textureList","visible","rect","getBoundingClientRect","devicePixelRatio","style","backgroundColor","getShaders_","success","addListeners_","onLoop","items","version","of","find","loadAll","getElementsByClassName","filter","urls","hasAttribute","vertex","getAttribute","fragment","body","onScroll","bind","onClick","onMove","onMousemove","onMouseover","onMouseout","onTouchmove","onTouchend","onTouchstart","addCanvasListeners_","removeCanvasListeners_","removeEventListener","removeListeners_","cancelAnimationFrame","rafId","toggle","mx","my","left","top","clientX","pageX","clientY","pageY","touch","touches","p","time","checkRender","requestAnimationFrame","setUniform_","loadTexture","parseTextures_","createUniforms_","_this5","timer","hasDelta","hasTime","hasDate","hasMouse","hasTextures","classList","remove","date","Date","getFullYear","getMonth","getDate","getHours","getMinutes","getSeconds","getMilliseconds","setTexture","updateUniforms_","isVisible_","innerHeight","documentElement","clientHeight","isAnimated_","isDirty_","sizeDidChanged_","W","ceil","clientWidth","H","_this6","createContext_","destroyContext_","swapCanvas_","onError","_this7","query","createQueryEXT","wasValid","beginQueryEXT","TIME_ELAPSED_EXT","endQueryEXT","waitForTest","available","getQueryObjectEXT","QUERY_RESULT_AVAILABLE_EXT","disjoint","GPU_DISJOINT_EXT","result","timeElapsedMs","QUERY_RESULT_EXT","canvas_","cloneNode","replaceChild","splice","_this8","keyResolution","path","setUniform","setUniformOfInt","setUniforms","BuffersDefaultFragment"],"mappings":"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","file":"docs/js/glsl-canvas.min.js","sourcesContent":[null,"import promiseFinally from './finally';\n\n// Store setTimeout reference so promise-polyfill will be unaffected by\n// other code modifying setTimeout (like sinon.useFakeTimers())\nvar setTimeoutFunc = setTimeout;\n\nfunction isArray(x) {\n  return Boolean(x && typeof x.length !== 'undefined');\n}\n\nfunction noop() {}\n\n// Polyfill for Function.prototype.bind\nfunction bind(fn, thisArg) {\n  return function() {\n    fn.apply(thisArg, arguments);\n  };\n}\n\n/**\n * @constructor\n * @param {Function} fn\n */\nfunction Promise(fn) {\n  if (!(this instanceof Promise))\n    throw new TypeError('Promises must be constructed via new');\n  if (typeof fn !== 'function') throw new TypeError('not a function');\n  /** @type {!number} */\n  this._state = 0;\n  /** @type {!boolean} */\n  this._handled = false;\n  /** @type {Promise|undefined} */\n  this._value = undefined;\n  /** @type {!Array<!Function>} */\n  this._deferreds = [];\n\n  doResolve(fn, this);\n}\n\nfunction handle(self, deferred) {\n  while (self._state === 3) {\n    self = self._value;\n  }\n  if (self._state === 0) {\n    self._deferreds.push(deferred);\n    return;\n  }\n  self._handled = true;\n  Promise._immediateFn(function() {\n    var cb = self._state === 1 ? deferred.onFulfilled : deferred.onRejected;\n    if (cb === null) {\n      (self._state === 1 ? resolve : reject)(deferred.promise, self._value);\n      return;\n    }\n    var ret;\n    try {\n      ret = cb(self._value);\n    } catch (e) {\n      reject(deferred.promise, e);\n      return;\n    }\n    resolve(deferred.promise, ret);\n  });\n}\n\nfunction resolve(self, newValue) {\n  try {\n    // Promise Resolution Procedure: https://github.com/promises-aplus/promises-spec#the-promise-resolution-procedure\n    if (newValue === self)\n      throw new TypeError('A promise cannot be resolved with itself.');\n    if (\n      newValue &&\n      (typeof newValue === 'object' || typeof newValue === 'function')\n    ) {\n      var then = newValue.then;\n      if (newValue instanceof Promise) {\n        self._state = 3;\n        self._value = newValue;\n        finale(self);\n        return;\n      } else if (typeof then === 'function') {\n        doResolve(bind(then, newValue), self);\n        return;\n      }\n    }\n    self._state = 1;\n    self._value = newValue;\n    finale(self);\n  } catch (e) {\n    reject(self, e);\n  }\n}\n\nfunction reject(self, newValue) {\n  self._state = 2;\n  self._value = newValue;\n  finale(self);\n}\n\nfunction finale(self) {\n  if (self._state === 2 && self._deferreds.length === 0) {\n    Promise._immediateFn(function() {\n      if (!self._handled) {\n        Promise._unhandledRejectionFn(self._value);\n      }\n    });\n  }\n\n  for (var i = 0, len = self._deferreds.length; i < len; i++) {\n    handle(self, self._deferreds[i]);\n  }\n  self._deferreds = null;\n}\n\n/**\n * @constructor\n */\nfunction Handler(onFulfilled, onRejected, promise) {\n  this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;\n  this.onRejected = typeof onRejected === 'function' ? onRejected : null;\n  this.promise = promise;\n}\n\n/**\n * Take a potentially misbehaving resolver function and make sure\n * onFulfilled and onRejected are only called once.\n *\n * Makes no guarantees about asynchrony.\n */\nfunction doResolve(fn, self) {\n  var done = false;\n  try {\n    fn(\n      function(value) {\n        if (done) return;\n        done = true;\n        resolve(self, value);\n      },\n      function(reason) {\n        if (done) return;\n        done = true;\n        reject(self, reason);\n      }\n    );\n  } catch (ex) {\n    if (done) return;\n    done = true;\n    reject(self, ex);\n  }\n}\n\nPromise.prototype['catch'] = function(onRejected) {\n  return this.then(null, onRejected);\n};\n\nPromise.prototype.then = function(onFulfilled, onRejected) {\n  // @ts-ignore\n  var prom = new this.constructor(noop);\n\n  handle(this, new Handler(onFulfilled, onRejected, prom));\n  return prom;\n};\n\nPromise.prototype['finally'] = promiseFinally;\n\nPromise.all = function(arr) {\n  return new Promise(function(resolve, reject) {\n    if (!isArray(arr)) {\n      return reject(new TypeError('Promise.all accepts an array'));\n    }\n\n    var args = Array.prototype.slice.call(arr);\n    if (args.length === 0) return resolve([]);\n    var remaining = args.length;\n\n    function res(i, val) {\n      try {\n        if (val && (typeof val === 'object' || typeof val === 'function')) {\n          var then = val.then;\n          if (typeof then === 'function') {\n            then.call(\n              val,\n              function(val) {\n                res(i, val);\n              },\n              reject\n            );\n            return;\n          }\n        }\n        args[i] = val;\n        if (--remaining === 0) {\n          resolve(args);\n        }\n      } catch (ex) {\n        reject(ex);\n      }\n    }\n\n    for (var i = 0; i < args.length; i++) {\n      res(i, args[i]);\n    }\n  });\n};\n\nPromise.resolve = function(value) {\n  if (value && typeof value === 'object' && value.constructor === Promise) {\n    return value;\n  }\n\n  return new Promise(function(resolve) {\n    resolve(value);\n  });\n};\n\nPromise.reject = function(value) {\n  return new Promise(function(resolve, reject) {\n    reject(value);\n  });\n};\n\nPromise.race = function(arr) {\n  return new Promise(function(resolve, reject) {\n    if (!isArray(arr)) {\n      return reject(new TypeError('Promise.race accepts an array'));\n    }\n\n    for (var i = 0, len = arr.length; i < len; i++) {\n      Promise.resolve(arr[i]).then(resolve, reject);\n    }\n  });\n};\n\n// Use polyfill for setImmediate for performance gains\nPromise._immediateFn =\n  // @ts-ignore\n  (typeof setImmediate === 'function' &&\n    function(fn) {\n      // @ts-ignore\n      setImmediate(fn);\n    }) ||\n  function(fn) {\n    setTimeoutFunc(fn, 0);\n  };\n\nPromise._unhandledRejectionFn = function _unhandledRejectionFn(err) {\n  if (typeof console !== 'undefined' && console) {\n    console.warn('Possible Unhandled Promise Rejection:', err); // eslint-disable-line no-console\n  }\n};\n\nexport default Promise;\n","/**\n * @this {Promise}\n */\nfunction finallyConstructor(callback) {\n  var constructor = this.constructor;\n  return this.then(\n    function(value) {\n      // @ts-ignore\n      return constructor.resolve(callback()).then(function() {\n        return value;\n      });\n    },\n    function(reason) {\n      // @ts-ignore\n      return constructor.resolve(callback()).then(function() {\n        // @ts-ignore\n        return constructor.reject(reason);\n      });\n    }\n  );\n}\n\nexport default finallyConstructor;\n","export enum LoggerLevel {\n\tNone = 0,\n\tError = 1,\n\tWarn = 2,\n\tLog = 3,\n}\n\nexport default class Logger {\n\n\tstatic level: LoggerLevel = LoggerLevel.Warn;\n\n\tstatic enabled: boolean = true;\n\n\tstatic log(...datas: any[]) {\n\t\tif (Logger.enabled && Logger.level >= LoggerLevel.Log) {\n\t\t\tconsole.log(...datas);\n\t\t}\n\t}\n\n\tstatic warn(...datas: any[]) {\n\t\tif (Logger.enabled && Logger.level >= LoggerLevel.Warn) {\n\t\t\tconsole.warn(...datas);\n\t\t}\n\t}\n\n\tstatic error(...datas: any[]) {\n\t\tif (Logger.enabled && Logger.level >= LoggerLevel.Error) {\n\t\t\tconsole.error(...datas);\n\t\t}\n\t}\n\n}\n","import 'promise-polyfill';\n\nexport default class Common {\n\tstatic fetch(url: string): Promise<string> {\n\t\t// console.log('fetch', url);\n\t\treturn new Promise(function (resolve, reject) {\n\t\t\tconst xhr: XMLHttpRequest = new XMLHttpRequest();\n\t\t\txhr.onload = function () {\n\t\t\t\tresolve(xhr.response || xhr.responseText);\n\t\t\t};\n\t\t\txhr.onerror = function (error) {\n\t\t\t\t// console.log(error);\n\t\t\t\treject(new Error(`Network request failed for url ${url}`));\n\t\t\t};\n\t\t\txhr.ontimeout = function (error) {\n\t\t\t\t// console.log(error);\n\t\t\t\treject(new Error(`Network request failed for url ${url}`));\n\t\t\t};\n\t\t\txhr.onabort = function () {\n\t\t\t\treject(new Error('Aborted'));\n\t\t\t};\n\t\t\txhr.open('GET', url, true);\n\t\t\txhr.send(null);\n\t\t})\n\t}\n}\n","import Common from '../core/common';\nimport Logger from '../logger/logger';\n\nexport const ContextDefaultVertex = `\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nvarying vec2 v_texcoord;\n\nvoid main(){\n\tgl_Position = vec4(a_position, 0.0, 1.0);\n\tv_texcoord = a_texcoord;\n}\n`;\n\nexport const ContextDefaultFragment = `\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvoid main(){\n\tgl_FragColor = vec4(0.0);\n}\n`;\n\nexport const ContextDefaultVertex2 = `#version 300 es\n\nin vec2 a_position;\nin vec2 a_texcoord;\n\nout vec2 v_texcoord;\n\nvoid main() {\n\tgl_Position = vec4(a_position, 0.0, 1.0);\n\tv_texcoord = a_texcoord;\n}\n`;\n\nexport const ContextDefaultFragment2 = `#version 300 es\n\nprecision mediump float;\n\nout vec4 outColor;\n\nvoid main() {\n\toutColor = vec4(0.0);\n}\n`;\n\nexport enum ContextVersion {\n\tWebGl = 1,\n\tWebGl2 = 2,\n}\n\nexport enum ContextError {\n\tBrowserSupport = 1,\n\tOther = 2,\n}\n\nexport interface IContextOptions {\n\talpha?: GLboolean;\n\tantialias?: GLboolean;\n\tdepth?: GLboolean;\n\tfailIfMajorPerformanceCaveat?: boolean;\n\t// powerPreference?: WebGLPowerPreference;\n\tpremultipliedAlpha?: GLboolean;\n\tpreserveDrawingBuffer?: GLboolean;\n\tstencil?: GLboolean;\n}\n\nexport class ContextVertexBuffers {\n\ttexcoord: WebGLBuffer;\n\tposition: WebGLBuffer;\n}\n\nexport default class Context {\n\n\tstatic lastError: string = '';\n\n\tstatic getContext_(canvas: HTMLCanvasElement, options?: WebGLContextAttributes): WebGLRenderingContext {\n\t\tconst names = ['webgl', 'experimental-webgl'];\n\t\tlet context = null;\n\t\tfor (let i = 0; i < names.length; ++i) {\n\t\t\ttry {\n\t\t\t\tcontext = canvas.getContext(names[i], options) as WebGLRenderingContext;\n\t\t\t} catch (e) {\n\t\t\t\tif (context) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn context;\n\t}\n\n\tstatic getContext2_(canvas: HTMLCanvasElement, options?: WebGLContextAttributes): WebGL2RenderingContext {\n\t\tlet context = null;\n\t\ttry {\n\t\t\tcontext = canvas.getContext('webgl2', options) as WebGL2RenderingContext;\n\t\t} catch (e) {\n\t\t\t// console.error('GlslCanvas.Context.getContext2_.error', e);\n\t\t}\n\t\treturn context;\n\t}\n\n\tstatic getIncludes(input: string | undefined): Promise<string | undefined> {\n\t\tif (input === undefined) {\n\t\t\treturn Promise.resolve(input);\n\t\t}\n\t\tconst regex = /#include\\s*['|\"](.*.glsl)['|\"]/gm;\n\t\tconst promises = [];\n\t\tlet i = 0;\n\t\tlet match;\n\t\twhile ((match = regex.exec(input)) !== null) {\n\t\t\tpromises.push(Promise.resolve(input.slice(i, match.index)));\n\t\t\ti = match.index + match[0].length;\n\t\t\tpromises.push(Common.fetch(match[1]));\n\t\t}\n\t\tpromises.push(Promise.resolve(input.slice(i)));\n\t\treturn Promise.all(promises).then(chunks => {\n\t\t\treturn chunks.join('');\n\t\t});\n\t}\n\n\tstatic isWebGl(context: WebGLRenderingContext | WebGL2RenderingContext): boolean {\n\t\treturn context instanceof WebGLRenderingContext;\n\t}\n\n\tstatic isWebGl2(context: WebGLRenderingContext | WebGL2RenderingContext): boolean {\n\t\t// console.log(context);\n\t\t// return context !== undefined && typeof (context as any).bindBufferRange === 'function';\n\t\treturn (window as any).WebGL2RenderingContext && context instanceof WebGL2RenderingContext;\n\t}\n\n\tstatic inferVersion(vertexString?: string, fragmentString?: string): ContextVersion {\n\t\tconst source: string = vertexString || fragmentString;\n\t\tif (source) {\n\t\t\treturn source.indexOf('#version 300 es') === 0 ? ContextVersion.WebGl2 : ContextVersion.WebGl;\n\t\t} else {\n\t\t\treturn ContextVersion.WebGl;\n\t\t}\n\t}\n\n\tstatic versionDiffers(gl: WebGLRenderingContext | WebGL2RenderingContext, vertexString?: string, fragmentString?: string): boolean {\n\t\tif (gl) {\n\t\t\tconst currentVersion = this.isWebGl2(gl) ? ContextVersion.WebGl2 : ContextVersion.WebGl;\n\t\t\tconst newVersion = Context.inferVersion(vertexString, fragmentString);\n\t\t\treturn newVersion !== currentVersion;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tstatic getVertex(vertexString?: string, fragmentString?: string): string {\n\t\tif (vertexString) {\n\t\t\treturn vertexString;\n\t\t} else {\n\t\t\tconst version: ContextVersion = this.inferVersion(vertexString, fragmentString);\n\t\t\treturn version === ContextVersion.WebGl2 ? ContextDefaultVertex2 : ContextDefaultVertex;\n\t\t}\n\t}\n\n\tstatic getFragment(vertexString?: string, fragmentString?: string): string {\n\t\tif (fragmentString) {\n\t\t\treturn fragmentString;\n\t\t} else {\n\t\t\tconst version: ContextVersion = this.inferVersion(vertexString, fragmentString);\n\t\t\treturn version === ContextVersion.WebGl2 ? ContextDefaultFragment2 : ContextDefaultFragment;\n\t\t}\n\t}\n\n\tstatic tryInferContext(vertexString: string, fragmentString: string, canvas: HTMLCanvasElement, attributes: WebGLContextAttributes, extensions: string[] = [], errorCallback: Function): WebGLRenderingContext | WebGL2RenderingContext {\n\t\tfunction handleError(errorCode: number, html: string) {\n\t\t\tif (typeof errorCallback === 'function') {\n\t\t\t\terrorCallback(errorCode);\n\t\t\t} else {\n\t\t\t\tconst container = canvas.parentNode;\n\t\t\t\tif (container) {\n\t\t\t\t\t(container as HTMLElement).innerHTML = `<div class=\"glsl-canvas--error\">${html}</div>`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!WebGLRenderingContext) {\n\t\t\thandleError(ContextError.BrowserSupport, `This page requires a browser that supports WebGL.<br/>\n\t\t\t<a href=\"http://get.webgl.org\">Click here to upgrade your browser.</a>`);\n\t\t\treturn null;\n\t\t}\n\t\tconst context: WebGLRenderingContext | WebGL2RenderingContext = Context.inferContext(vertexString, fragmentString, canvas, attributes);\n\t\tif (!context) {\n\t\t\thandleError(ContextError.Other, `It does not appear your computer can support WebGL.<br/>\n\t\t\t<a href=\"http://get.webgl.org/troubleshooting/\">Click here for more information.</a>`);\n\t\t} else {\n\t\t\tif (!(this.isWebGl2(context)) && extensions.indexOf('OES_standard_derivatives') === -1) {\n\t\t\t\textensions.push('OES_standard_derivatives');\n\t\t\t}\n\t\t\tconst supportedExtensions = context.getSupportedExtensions();\n\t\t\textensions.forEach(key => {\n\t\t\t\tif (supportedExtensions.indexOf(key) !== -1) {\n\t\t\t\t\tcontext.getExtension(key);\n\t\t\t\t} else {\n\t\t\t\t\tLogger.warn(`GlslCanvas ${key} not supported`);\n\t\t\t\t}\n\t\t\t});\n\t\t\t// context.getExtension('OES_standard_derivatives');\n\t\t}\n\t\treturn context;\n\t}\n\n\tstatic tryGetContext(canvas: HTMLCanvasElement, attributes: WebGLContextAttributes, errorCallback: Function): WebGLRenderingContext {\n\t\tfunction handleError(errorCode: number, html: string) {\n\t\t\tif (typeof errorCallback === 'function') {\n\t\t\t\terrorCallback(errorCode);\n\t\t\t} else {\n\t\t\t\tconst container = canvas.parentNode;\n\t\t\t\tif (container) {\n\t\t\t\t\t(container as HTMLElement).innerHTML = `<div class=\"glsl-canvas--error\">${html}</div>`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!WebGLRenderingContext) {\n\t\t\thandleError(ContextError.BrowserSupport, `This page requires a browser that supports WebGL.<br/>\n\t\t\t<a href=\"http://get.webgl.org\">Click here to upgrade your browser.</a>`);\n\t\t\treturn null;\n\t\t}\n\t\tconst context: WebGLRenderingContext = Context.getContext_(canvas, attributes);\n\t\tif (!context) {\n\t\t\thandleError(ContextError.Other, `It does not appear your computer can support WebGL.<br/>\n\t\t\t<a href=\"http://get.webgl.org/troubleshooting/\">Click here for more information.</a>`);\n\t\t} else {\n\t\t\tcontext.getExtension('OES_standard_derivatives');\n\t\t}\n\t\treturn context;\n\t}\n\n\tstatic inferContext(vertexString: string, fragmentString: string, canvas: HTMLCanvasElement, options?: WebGLContextAttributes): WebGLRenderingContext | WebGL2RenderingContext {\n\t\tconst version: ContextVersion = this.inferVersion(vertexString, fragmentString);\n\t\treturn version === ContextVersion.WebGl2 ? this.getContext2_(canvas, options) : this.getContext_(canvas, options);\n\t}\n\n\tstatic createShader(gl: WebGLRenderingContext | WebGL2RenderingContext, source: string, type: number, offset: number = 0): WebGLShader {\n\t\tconst shader = gl.createShader(type);\n\t\tgl.shaderSource(shader, source);\n\t\tgl.compileShader(shader);\n\t\tconst compiled = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\n\t\tif (!compiled) {\n\t\t\t// Something went wrong during compilation; get the error\n\t\t\tContext.lastError = gl.getShaderInfoLog(shader);\n\t\t\t// console.log('lastError', Context.lastError);\n\t\t\tLogger.error(`*** Error compiling shader ${shader}: ${Context.lastError}`);\n\t\t\t// main.trigger('error', {\n\t\t\tgl.deleteShader(shader);\n\t\t\tthrow ({\n\t\t\t\tshader: shader,\n\t\t\t\tsource: source,\n\t\t\t\ttype: type,\n\t\t\t\terror: Context.lastError,\n\t\t\t\toffset: offset\n\t\t\t});\n\t\t}\n\t\treturn shader;\n\t}\n\n\tstatic createProgram(gl: WebGLRenderingContext | WebGL2RenderingContext, shaders: WebGLShader[], attributes?: any[], locations?: number[]): WebGLProgram {\n\t\tconst program = gl.createProgram();\n\t\tfor (let i = 0; i < shaders.length; ++i) {\n\t\t\tgl.attachShader(program, shaders[i]);\n\t\t}\n\t\tif (attributes && locations) {\n\t\t\tfor (let i = 0; i < attributes.length; ++i) {\n\t\t\t\tgl.bindAttribLocation(program, locations ? locations[i] : i, attributes[i]);\n\t\t\t}\n\t\t}\n\t\tgl.linkProgram(program);\n\t\t// Check the link status\n\t\tconst linked = gl.getProgramParameter(program, gl.LINK_STATUS);\n\t\tif (!linked) {\n\t\t\t// something went wrong with the link\n\t\t\tContext.lastError = gl.getProgramInfoLog(program);\n\t\t\tLogger.log(`Error in program linking: ${Context.lastError}`);\n\t\t\tgl.deleteProgram(program);\n\t\t\treturn null;\n\t\t}\n\t\treturn program;\n\t}\n\n\tstatic createVertexBuffers(gl: WebGLRenderingContext | WebGL2RenderingContext, program: WebGLProgram): ContextVertexBuffers {\n\t\tconst vertexBuffers: ContextVertexBuffers = new ContextVertexBuffers();\n\t\tconst texcoordIndex: number = gl.getAttribLocation(program, 'a_texcoord');\n\t\tvertexBuffers.texcoord = gl.createBuffer();\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffers.texcoord);\n\t\tgl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 0.0, 1.0, 1.0]), gl.STATIC_DRAW);\n\t\tgl.enableVertexAttribArray(texcoordIndex);\n\t\tgl.vertexAttribPointer(texcoordIndex, 2, gl.FLOAT, false, 0, 0);\n\t\tconst positionIndex: number = gl.getAttribLocation(program, 'a_position');\n\t\tvertexBuffers.position = gl.createBuffer();\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffers.position);\n\t\tgl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1.0, -1.0, 1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 1.0, -1.0, 1.0, 1.0]), gl.STATIC_DRAW);\n\t\tgl.enableVertexAttribArray(positionIndex);\n\t\tgl.vertexAttribPointer(positionIndex, 2, gl.FLOAT, false, 0, 0);\n\t\treturn vertexBuffers;\n\t}\n\n}\n","import Context from '../context/context';\nimport IterableStringMap from '../core/iterable';\n\nexport const BuffersDefaultFragment = `\nvoid main(){\n\tgl_FragColor = vec4(1.0);\n}`;\n\nexport const BuffersDefaultFragment2 = `#version 300 es\n\nprecision mediump float;\n\nout vec4 outColor;\n\nvoid main() {\n\toutColor = vec4(1.0);\n}\n`;\n\nexport enum BufferFloatType {\n\tFLOAT = 0,\n\tHALF_FLOAT,\n}\n\nexport class Buffer {\n\n\tstatic floatType: BufferFloatType = BufferFloatType.HALF_FLOAT;\n\ttexture: WebGLTexture;\n\tbuffer: WebGLFramebuffer;\n\tBW: number;\n\tBH: number;\n\tindex: number;\n\n\tconstructor(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number, index: number) {\n\t\tconst buffer = gl.createFramebuffer();\n\t\tconst texture = this.getTexture(gl, BW, BH, index);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\t\tthis.texture = texture;\n\t\tthis.buffer = buffer;\n\t\tthis.BW = BW;\n\t\tthis.BH = BH;\n\t\tthis.index = index;\n\t}\n\n\tgetFloatType(gl: WebGLRenderingContext | WebGL2RenderingContext): number {\n\t\tlet floatType: number, extension;\n\t\tif (Buffer.floatType === BufferFloatType.FLOAT) {\n\t\t\tconst extensionName = Context.isWebGl2(gl) ? 'EXT_color_buffer_float' : 'OES_texture_float';\n\t\t\textension = gl.getExtension(extensionName);\n\t\t\tif (extension) {\n\t\t\t\tfloatType = gl.FLOAT;\n\t\t\t} else {\n\t\t\t\tBuffer.floatType = BufferFloatType.HALF_FLOAT;\n\t\t\t\treturn this.getFloatType(gl);\n\t\t\t}\n\t\t} else {\n\t\t\tconst extensionName = Context.isWebGl2(gl) ? 'EXT_color_buffer_half_float' : 'OES_texture_half_float';\n\t\t\textension = gl.getExtension(extensionName);\n\t\t\tif (extension) {\n\t\t\t\tfloatType = extension.HALF_FLOAT_OES;\n\t\t\t} else {\n\t\t\t\tBuffer.floatType = BufferFloatType.FLOAT;\n\t\t\t\treturn this.getFloatType(gl);\n\t\t\t}\n\t\t}\n\t\treturn floatType;\n\t}\n\n\tgetTexture(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number, index: number): WebGLTexture {\n\t\tconst floatType = this.getFloatType(gl);\n\t\tconst texture = gl.createTexture();\n\t\tgl.activeTexture(gl.TEXTURE0 + index);\n\t\tgl.bindTexture(gl.TEXTURE_2D, texture);\n\t\tgl.texImage2D(gl.TEXTURE_2D, 0, (Context.isWebGl2(gl) ? (gl as WebGL2RenderingContext).RGBA16F : gl.RGBA), BW, BH, 0, gl.RGBA, floatType, null);\n\t\tconst status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n\t\tif (status !== gl.FRAMEBUFFER_COMPLETE) {\n\t\t\tif (Buffer.floatType === BufferFloatType.FLOAT) {\n\t\t\t\tBuffer.floatType = BufferFloatType.HALF_FLOAT;\n\t\t\t} else {\n\t\t\t\tBuffer.floatType = BufferFloatType.FLOAT;\n\t\t\t}\n\t\t\treturn this.getTexture(gl, BW, BH, index);\n\t\t}\n\t\treturn texture;\n\t}\n\n\tresize(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number) {\n\t\tif (BW !== this.BW || BH !== this.BH) {\n\t\t\tconst buffer = this.buffer;\n\t\t\tconst texture = this.texture;\n\t\t\tconst index = this.index;\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, buffer);\n\t\t\tconst status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n\t\t\tconst minW = Math.min(BW, this.BW);\n\t\t\tconst minH = Math.min(BH, this.BH);\n\t\t\tlet pixels: Float32Array;\n\t\t\tlet floatType = this.getFloatType(gl);\n\t\t\tif (status === gl.FRAMEBUFFER_COMPLETE) {\n\t\t\t\tpixels = new Float32Array(minW * minH * 4);\n\t\t\t\tgl.readPixels(0, 0, minW, minH, gl.RGBA, floatType, pixels);\n\t\t\t}\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\t\t\tconst newIndex = index + 1; // temporary index\n\t\t\tconst newTexture = this.getTexture(gl, BW, BH, newIndex);\n\t\t\tfloatType = this.getFloatType(gl);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\t\t\tif (pixels) {\n\t\t\t\tgl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, minW, minH, gl.RGBA, floatType, pixels);\n\t\t\t}\n\t\t\tconst newBuffer = gl.createFramebuffer();\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\t\t\tgl.deleteTexture(texture);\n\t\t\tgl.activeTexture(gl.TEXTURE0 + index);\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, newTexture);\n\t\t\tthis.index = index;\n\t\t\tthis.texture = newTexture;\n\t\t\tthis.buffer = newBuffer;\n\t\t\tthis.BW = BW;\n\t\t\tthis.BH = BH;\n\t\t}\n\t}\n\n}\n\nexport class IOBuffer {\n\n\tprogram: WebGLProgram;\n\tinput: Buffer;\n\toutput: Buffer;\n\tindex: number;\n\tkey: string;\n\tvertexString: string;\n\tfragmentString: string;\n\tBW: number;\n\tBH: number;\n\tisValid: boolean = false;\n\n\tconstructor(index: number, key: string, vertexString: string, fragmentString: string) {\n\t\tthis.index = index;\n\t\tthis.key = key;\n\t\tthis.vertexString = vertexString;\n\t\tthis.fragmentString = fragmentString;\n\t}\n\n\tcreate(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number) {\n\t\t// console.log('create', this.vertexString, this.fragmentString);\n\t\tconst vertexShader = Context.createShader(gl, this.vertexString, gl.VERTEX_SHADER);\n\t\tlet fragmentShader = Context.createShader(gl, this.fragmentString, gl.FRAGMENT_SHADER, 1);\n\t\tif (!fragmentShader) {\n\t\t\tfragmentShader = Context.createShader(gl, Context.isWebGl2(gl) ?\n\t\t\t\tBuffersDefaultFragment2 : BuffersDefaultFragment, gl.FRAGMENT_SHADER);\n\t\t\tthis.isValid = false;\n\t\t} else {\n\t\t\tthis.isValid = true;\n\t\t}\n\t\tconst program = Context.createProgram(gl, [vertexShader, fragmentShader]);\n\t\tgl.linkProgram(program);\n\t\tconst input = new Buffer(gl, BW, BH, this.index + 0);\n\t\tconst output = new Buffer(gl, BW, BH, this.index + 2);\n\t\tthis.program = program;\n\t\tthis.input = input;\n\t\tthis.output = output;\n\t\tgl.deleteShader(vertexShader);\n\t\tgl.deleteShader(fragmentShader);\n\t}\n\n\trender(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number) {\n\t\tgl.useProgram(this.program);\n\t\tgl.viewport(0, 0, BW, BH);\n\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, this.output.buffer);\n\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, this.output.texture, 0);\n\t\tgl.drawArrays(gl.TRIANGLES, 0, 6);\n\t\t// swap\n\t\tconst input = this.input;\n\t\tconst output = this.output;\n\t\tthis.input = output;\n\t\tthis.output = input;\n\t}\n\n\tresize(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number) {\n\t\tgl.useProgram(this.program);\n\t\tgl.viewport(0, 0, BW, BH);\n\t\tthis.input.resize(gl, BW, BH);\n\t\tthis.output.resize(gl, BW, BH);\n\t}\n\n\tdestroy(gl: WebGLRenderingContext | WebGL2RenderingContext) {\n\t\tgl.deleteProgram(this.program);\n\t\tthis.program = null;\n\t\tthis.input = null;\n\t\tthis.output = null;\n\t}\n\n}\n\nexport default class Buffers extends IterableStringMap<IOBuffer> {\n\n\tget count(): number {\n\t\treturn Object.keys(this.values).length * 4;\n\t}\n\n\tstatic getBuffers(gl: WebGLRenderingContext | WebGL2RenderingContext, fragmentString: string, vertexString: string): Buffers {\n\t\tconst buffers: Buffers = new Buffers();\n\t\tlet count = 0;\n\t\tif (fragmentString) {\n\t\t\tif (Context.isWebGl2(gl)) {\n\t\t\t\tfragmentString = fragmentString.replace(/^\\#version\\s*300\\s*es\\s*\\n/, '');\n\t\t\t}\n\t\t\tconst regexp = /(?:^\\s*)((?:#if|#elif)(?:\\s*)(defined\\s*\\(\\s*BUFFER_)(\\d+)(?:\\s*\\))|(?:#ifdef)(?:\\s*BUFFER_)(\\d+)(?:\\s*))/gm;\n\t\t\tlet matches;\n\t\t\twhile ((matches = regexp.exec(fragmentString)) !== null) {\n\t\t\t\tconst i = matches[3] || matches[4];\n\t\t\t\tconst key = 'u_buffer' + i;\n\t\t\t\tconst bufferFragmentString = Context.isWebGl2(gl) ? `#version 300 es\n#define BUFFER_${i}\n${fragmentString}` : `#define BUFFER_${i}\n${fragmentString}`;\n\t\t\t\tconst buffer = new IOBuffer(count, key, vertexString, bufferFragmentString);\n\t\t\t\tbuffer.create(gl, gl.drawingBufferWidth, gl.drawingBufferHeight);\n\t\t\t\tbuffers.set(key, buffer);\n\t\t\t\tcount += 4;\n\t\t\t}\n\t\t}\n\t\treturn buffers;\n\t}\n\n}\n","export class NumberMap<T> { [key: number]: T; };\nexport class StringMap<T> { [key: string]: T; };\n\nexport default class IterableStringMap<T> {\n\n\tvalues: StringMap<T> = new StringMap<T>();\n\n\thas(key: string) {\n\t\treturn this.values.hasOwnProperty(key);\n\t}\n\n\tset(key: string, item: T) {\n\t\tthis.values[key] = item;\n\t}\n\n\tget(key: string): T {\n\t\treturn this.values[key];\n\t}\n\n\tforEach(callbackfn: Function) {\n\t\tlet i = 0;\n\t\tfor (const key in this.values) {\n\t\t\tcallbackfn(this.values[key], i, this.values);\n\t\t\ti++;\n\t\t}\n\t}\n\n\treduce(callbackfn: Function, initialValue?: any) {\n\t\tlet previous = initialValue, i = 0;\n\t\tfor (const key in this.values) {\n\t\t\tprevious = callbackfn(previous, this.values[key], i, this.values);\n\t\t\ti++;\n\t\t}\n\t\treturn previous;\n\t}\n\n}\n","// import 'promise-polyfill';\nimport IterableStringMap from '../core/iterable';\nimport Subscriber from '../core/subscriber';\nimport Logger from '../logger/logger';\n\nexport const TextureImageExtensions = ['jpg', 'jpeg', 'png'];\nexport const TextureVideoExtensions = ['ogv', 'webm', 'mp4'];\nexport const TextureExtensions = TextureImageExtensions.concat(TextureVideoExtensions);\n\nexport enum TextureSourceType {\n\tData = 0,\n\tElement = 1,\n\tUrl = 2,\n}\n\nexport enum TextureFilteringType {\n\tMipMap = 'mipmap',\n\tLinear = 'linear',\n\tNearest = 'nearest',\n}\n\nexport interface ITextureData {\n\tdata: Uint8Array;\n\twidth: number;\n\theight: number;\n}\n\nexport interface ITextureOptions {\n\turl?: string;\n\telement?: HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | HTMLElement | Element;\n\tdata?: Uint8Array;\n\twidth?: number;\n\theight?: number;\n\tfiltering?: TextureFilteringType;\n\trepeat?: boolean;\n\tUNPACK_FLIP_Y_WEBGL?: boolean;\n\tUNPACK_PREMULTIPLY_ALPHA_WEBGL?: number;\n\tTEXTURE_WRAP_S?: number; // gl.REPEAT | gl.CLAMP_TO_EDGE | gl.MIRRORED_REPEAT;\n\tTEXTURE_WRAP_T?: number; // gl.REPEAT | gl.CLAMP_TO_EDGE | gl.MIRRORED_REPEAT;\n}\n\nexport interface ITextureInput {\n\tkey: string;\n\turl: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData;\n\toptions?: ITextureOptions;\n}\n\nexport function isTextureData(object: any): object is ITextureData {\n\treturn 'data' in object && 'width' in object && 'height' in object;\n}\n\n// GL texture wrapper object for keeping track of a global set of textures, keyed by a unique user-defined name\nexport class Texture extends Subscriber {\n\n\tkey: string;\n\tindex: number;\n\toptions: ITextureOptions;\n\tworkpath: string;\n\twidth: number;\n\theight: number;\n\n\ttexture: WebGLTexture;\n\tsource: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | Uint8Array;\n\tsourceType: TextureSourceType;\n\tfiltering: TextureFilteringType;\n\turl: string;\n\tvalid: boolean = false;\n\tdirty: boolean = false;\n\tanimated: boolean = false;\n\tpowerOf2: boolean = false;\n\n\tconstructor(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\tkey: string,\n\t\tindex: number,\n\t\toptions: ITextureOptions = { filtering: TextureFilteringType.Linear },\n\t\tworkpath?: string,\n\t) {\n\t\tsuper();\n\t\tthis.key = key;\n\t\tthis.index = index;\n\t\tthis.options = options;\n\t\tthis.workpath = workpath;\n\t\tthis.create(gl);\n\t}\n\n\tstatic isPowerOf2(value: number): boolean {\n\t\treturn (value & (value - 1)) === 0;\n\t}\n\n\tstatic isSafari(): boolean {\n\t\treturn /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n\t}\n\n\tstatic isTextureUrl(text: string): boolean {\n\t\treturn text && (/\\.(jpg|jpeg|png|ogv|webm|mp4)$/i).test(text.split('?')[0]);\n\t}\n\n\tstatic isTexture(\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t): boolean {\n\t\tconst options = Texture.getTextureOptions(urlElementOrData);\n\t\treturn options !== undefined;\n\t}\n\n\tstatic getMaxTextureSize(gl: WebGLRenderingContext | WebGL2RenderingContext): number {\n\t\treturn gl.getParameter(gl.MAX_TEXTURE_SIZE);\n\t};\n\n\tstatic getTextureOptions(\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t\toptions: ITextureOptions = {}\n\t): ITextureOptions {\n\t\tif (typeof urlElementOrData === 'string' && urlElementOrData !== '') {\n\t\t\tif (Texture.isTextureUrl(urlElementOrData)) {\n\t\t\t\toptions.url = urlElementOrData;\n\t\t\t\tif (urlElementOrData.indexOf('?') !== -1) {\n\t\t\t\t\toptions = urlElementOrData.split('?')[1].split('&').reduce(function (prev: ITextureOptions, curr) {\n\t\t\t\t\t\tconst params = curr.split('=');\n\t\t\t\t\t\tconst key = decodeURIComponent(params[0]);\n\t\t\t\t\t\tconst value = decodeURIComponent(params[1]);\n\t\t\t\t\t\tswitch (key) {\n\t\t\t\t\t\t\tcase 'filtering':\n\t\t\t\t\t\t\t\tprev[key] = value as TextureFilteringType;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'repeat':\n\t\t\t\t\t\t\tcase 'UNPACK_FLIP_Y_WEBGL':\n\t\t\t\t\t\t\t\tprev[key] = Boolean(value);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'UNPACK_PREMULTIPLY_ALPHA_WEBGL':\n\t\t\t\t\t\t\tcase 'TEXTURE_WRAP_S':\n\t\t\t\t\t\t\tcase 'TEXTURE_WRAP_T':\n\t\t\t\t\t\t\t\tprev[key] = Number(value);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn prev;\n\t\t\t\t\t}, options);\n\t\t\t\t}\n\t\t\t\treturn options;\n\t\t\t}\n\t\t\tif (document) {\n\t\t\t\turlElementOrData = document.querySelector(urlElementOrData);\n\t\t\t\t// Logger.log(urlElementOrData);\n\t\t\t}\n\t\t}\n\t\tif (urlElementOrData instanceof HTMLCanvasElement || urlElementOrData instanceof HTMLImageElement || urlElementOrData instanceof HTMLVideoElement) {\n\t\t\toptions.element = urlElementOrData;\n\t\t\treturn options;\n\t\t} else if (isTextureData(urlElementOrData)) {\n\t\t\toptions.data = urlElementOrData.data;\n\t\t\toptions.width = urlElementOrData.width;\n\t\t\toptions.height = urlElementOrData.height;\n\t\t\treturn options;\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tcreate(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext\n\t): void {\n\t\tthis.texture = gl.createTexture();\n\t\tif (this.texture) {\n\t\t\tthis.valid = true;\n\t\t}\n\t\t// Default to a 1-pixel black texture so we can safely render while we wait for an image to load\n\t\t// See: http://stackoverflow.com/questions/19722247/webgl-wait-for-texture-to-load\n\t\t// [255, 255, 255, 255]\n\t\tthis.setData(gl, 1, 1, new Uint8Array([0, 0, 0, 0]), this.options);\n\t\t// this.bindTexture();\n\t\t// this.load(options);\n\t}\n\n\tload(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\toptions: ITextureOptions = {}\n\t): Promise<Texture> {\n\t\tthis.options = options;\n\t\tif (typeof options.url === 'string') {\n\t\t\tif (this.url === undefined || options.url !== this.url) {\n\t\t\t\treturn this.setUrl(gl, options.url, options);\n\t\t\t} else {\n\t\t\t\treturn Promise.resolve(this);\n\t\t\t}\n\t\t} else if (options.element) {\n\t\t\treturn this.setElement(gl, options.element, options);\n\t\t} else if (options.data && options.width && options.height) {\n\t\t\treturn this.setData(gl, options.width, options.height, options.data, options);\n\t\t} else {\n\t\t\treturn Promise.reject(this);\n\t\t}\n\t}\n\n\tsetUrl(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\turl: string,\n\t\toptions: ITextureOptions = {}\n\t): Promise<Texture> {\n\t\tif (!this.valid) {\n\t\t\treturn Promise.reject(this);\n\t\t}\n\t\tthis.url = url; // save URL reference (will be overwritten when element is loaded below)\n\t\tthis.source = url;\n\t\tthis.sourceType = TextureSourceType.Url;\n\t\tthis.options = Object.assign(this.options, options);\n\t\tconst src = String((url.indexOf(':/') === -1 && this.workpath !== undefined) ? `${this.workpath}/${url}` : url);\n\t\tconst ext = url.split('?')[0].split('.').pop().toLowerCase();\n\t\tconst isVideo = TextureVideoExtensions.indexOf(ext) !== -1;\n\t\tlet element: HTMLVideoElement | HTMLImageElement;\n\t\tlet promise: Promise<Texture>;\n\t\tif (isVideo) {\n\t\t\tLogger.log('GlslCanvas.setUrl video', src);\n\t\t\telement = document.createElement('video'); // new HTMLVideoElement();\n\t\t\telement.setAttribute('preload', 'auto');\n\t\t\t// element.setAttribute('autoplay', 'true');\n\t\t\telement.setAttribute('loop', 'true');\n\t\t\telement.setAttribute('muted', 'true');\n\t\t\telement.setAttribute('playsinline', 'true');\n\t\t\t// element.autoplay = true;\n\t\t\telement.loop = true;\n\t\t\telement.muted = true;\n\t\t\t/*\n\t\t\tif (!(Texture.isSafari() && /(?<!http|https):\\//.test(url))) {\n\t\t\t\telement.crossOrigin = 'anonymous';\n\t\t\t}\n\t\t\t*/\n\t\t\tpromise = this.setElement(gl, element, options);\n\t\t\telement.src = src;\n\t\t\telement.addEventListener('canplay', () => {\n\t\t\t\t(element as HTMLVideoElement).play();\n\t\t\t});\n\t\t} else {\n\t\t\tLogger.log('GlslCanvas.setUrl image', src);\n\t\t\telement = document.createElement('img'); // new HTMLImageElement();\n\t\t\tpromise = this.setElement(gl, element, options);\n\t\t\tif (!(Texture.isSafari() && url.slice(0, 5) === 'data:')) {\n\t\t\t\telement.crossOrigin = 'anonymous';\n\t\t\t}\n\t\t\telement.src = src;\n\t\t}\n\t\treturn promise;\n\t}\n\n\tsetElement(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\telement: HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | HTMLElement | Element,\n\t\toptions: ITextureOptions = {}\n\t): Promise<Texture> {\n\t\toptions = this.options = Object.assign(this.options, options);\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst originalElement = element;\n\t\t\t// a string element is interpeted as a CSS selector\n\t\t\tif (typeof element === 'string') {\n\t\t\t\telement = document.querySelector(element);\n\t\t\t}\n\t\t\tif (element instanceof HTMLCanvasElement ||\n\t\t\t\telement instanceof HTMLImageElement ||\n\t\t\t\telement instanceof HTMLVideoElement) {\n\t\t\t\tthis.source = element;\n\t\t\t\tthis.sourceType = TextureSourceType.Element;\n\t\t\t\tif (element instanceof HTMLVideoElement) {\n\t\t\t\t\tconst video = element as HTMLVideoElement;\n\t\t\t\t\tvideo.addEventListener('loadeddata', (event) => {\n\t\t\t\t\t\tthis.update(gl, options);\n\t\t\t\t\t\tthis.setFiltering(gl, options);\n\t\t\t\t\t\tresolve(this);\n\t\t\t\t\t});\n\t\t\t\t\tvideo.addEventListener('error', (error) => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t});\n\t\t\t\t\tvideo.load();\n\t\t\t\t} else if (element instanceof HTMLImageElement) {\n\t\t\t\t\telement.addEventListener('load', () => {\n\t\t\t\t\t\tthis.update(gl, options);\n\t\t\t\t\t\tthis.setFiltering(gl, options);\n\t\t\t\t\t\tresolve(this);\n\t\t\t\t\t});\n\t\t\t\t\telement.addEventListener('error', (error) => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tthis.update(gl, options);\n\t\t\t\t\tthis.setFiltering(gl, options);\n\t\t\t\t\tresolve(this);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tlet message = `the 'element' parameter (\\`element: ${JSON.stringify(originalElement)}\\`) must be a CSS selector string, or a <canvas>, <image> or <video> object`;\n\t\t\t\tLogger.log(`Texture '${this.key}': ${message}`, options);\n\t\t\t\treject(message);\n\t\t\t}\n\t\t});\n\t}\n\n\tsetData(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\twidth: number,\n\t\theight: number,\n\t\tdata: Uint8Array,\n\t\toptions: ITextureOptions = {}\n\t): Promise<Texture> {\n\t\tthis.width = width;\n\t\tthis.height = height;\n\t\tthis.options = Object.assign(this.options, options);\n\t\tthis.source = data;\n\t\tthis.sourceType = TextureSourceType.Data;\n\t\tthis.update(gl, options);\n\t\tthis.setFiltering(gl, options);\n\t\treturn Promise.resolve(this);\n\t}\n\n\t// Uploads current image or buffer to the GPU (can be used to update animated textures on the fly)\n\tupdate(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\toptions: ITextureOptions\n\t): void {\n\t\tif (!this.valid) {\n\t\t\treturn;\n\t\t}\n\t\tgl.activeTexture(gl.TEXTURE0 + this.index);\n\t\tgl.bindTexture(gl.TEXTURE_2D, this.texture);\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, (options.UNPACK_FLIP_Y_WEBGL === false ? 0 : 1));\n\t\tgl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, options.UNPACK_PREMULTIPLY_ALPHA_WEBGL || 0);\n\t\tif (this.sourceType === TextureSourceType.Element) {\n\t\t\tif (this.source instanceof HTMLImageElement && this.source.naturalWidth && this.source.naturalHeight) {\n\t\t\t\tthis.width = this.source.naturalWidth;\n\t\t\t\tthis.height = this.source.naturalHeight;\n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, this.source);\n\t\t\t} else if (this.source instanceof HTMLVideoElement && this.source.videoWidth && this.source.videoHeight) {\n\t\t\t\tthis.width = this.source.videoWidth;\n\t\t\t\tthis.height = this.source.videoHeight;\n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, this.source);\n\t\t\t} else if (this.source instanceof HTMLCanvasElement) {\n\t\t\t\tthis.width = this.source.width;\n\t\t\t\tthis.height = this.source.height;\n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, this.source);\n\t\t\t}\n\t\t} else if (this.sourceType === TextureSourceType.Data) {\n\t\t\tconst imageBuffer: ArrayBufferView = this.source as ArrayBufferView;\n\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, imageBuffer);\n\t\t}\n\t\tthis.trigger('loaded', this);\n\t}\n\n\ttryUpdate(gl: WebGLRenderingContext | WebGL2RenderingContext): boolean {\n\t\tlet dirty = false;\n\t\tif (this.animated) {\n\t\t\tdirty = true;\n\t\t\tthis.update(gl, this.options);\n\t\t}\n\t\treturn dirty;\n\t}\n\n\tdestroy(gl: WebGLRenderingContext | WebGL2RenderingContext): void {\n\t\tif (!this.valid) {\n\t\t\treturn;\n\t\t}\n\t\tgl.deleteTexture(this.texture);\n\t\tthis.texture = null;\n\t\tdelete this.source;\n\t\tthis.source = null;\n\t\tthis.valid = false;\n\t}\n\n\tsetFiltering(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\toptions: ITextureOptions\n\t): void {\n\t\tif (!this.valid) {\n\t\t\treturn;\n\t\t}\n\t\tconst powerOf2 = Texture.isPowerOf2(this.width) && Texture.isPowerOf2(this.height);\n\t\tlet filtering = options.filtering || TextureFilteringType.MipMap;\n\t\tlet wrapS = options.TEXTURE_WRAP_S || (options.repeat ? gl.REPEAT : gl.CLAMP_TO_EDGE);\n\t\tlet wrapT = options.TEXTURE_WRAP_T || (options.repeat ? gl.REPEAT : gl.CLAMP_TO_EDGE);\n\t\tif (!powerOf2) {\n\t\t\tfiltering = filtering === TextureFilteringType.MipMap ? TextureFilteringType.Linear : filtering;\n\t\t\twrapS = wrapT = gl.CLAMP_TO_EDGE;\n\t\t\tif (options.repeat || options.TEXTURE_WRAP_S || options.TEXTURE_WRAP_T) {\n\t\t\t\tLogger.warn(`GlslCanvas: cannot repeat texture ${options.url} cause is not power of 2.`);\n\t\t\t}\n\t\t}\n\t\tthis.powerOf2 = powerOf2;\n\t\tthis.filtering = filtering;\n\t\t// this.bindTexture();\n\t\t// WebGL has strict requirements on non-power-of-2 textures:\n\t\t// No mipmaps and must clamp to edge\n\t\t// For power-of-2 textures, the following presets are available:\n\t\t// mipmap: linear blend from nearest mip\n\t\t// linear: linear blend from original image (no mips)\n\t\t// nearest: nearest pixel from original image (no mips, 'blocky' look)\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, wrapS);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, wrapT);\n\t\tif (this.filtering === TextureFilteringType.MipMap) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR); // TODO: use trilinear filtering by defualt instead?\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\t\t\tgl.generateMipmap(gl.TEXTURE_2D);\n\t\t} else if (this.filtering === TextureFilteringType.Nearest) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\t\t} else if (this.filtering === TextureFilteringType.Linear) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\t\t}\n\t}\n}\n\nexport default class Textures extends IterableStringMap<Texture> {\n\n\tcount: number = 0;\n\tdirty: boolean = false;\n\tanimated: boolean = false;\n\n\tclean() {\n\t\tfor (const key in this.values) {\n\t\t\tthis.values[key].dirty = false;\n\t\t}\n\t\tthis.dirty = false;\n\t}\n\n\tcreateOrUpdate(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\tkey: string,\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t\tindex: number = 0,\n\t\toptions: ITextureOptions = {},\n\t\tworkpath: string,\n\t): Promise<Texture> {\n\t\tlet texture;\n\t\tconst textureOptions = Texture.getTextureOptions(urlElementOrData, options);\n\t\ttexture = this.get(key);\n\t\tif (!texture) {\n\t\t\ttexture = new Texture(gl, key, index + this.count, textureOptions, workpath);\n\t\t\tthis.count++;\n\t\t\tthis.set(key, texture);\n\t\t}\n\t\tif (textureOptions !== undefined) {\n\t\t\treturn texture.load(gl, textureOptions).then(\n\t\t\t\t(texture) => {\n\t\t\t\t\tif (texture.source instanceof HTMLVideoElement) {\n\t\t\t\t\t\tconst video = texture.source as HTMLVideoElement;\n\t\t\t\t\t\t// Logger.log('video', video);\n\t\t\t\t\t\tvideo.addEventListener('play', () => {\n\t\t\t\t\t\t\t// Logger.log('play', texture.key);\n\t\t\t\t\t\t\ttexture.animated = true;\n\t\t\t\t\t\t\tthis.animated = true;\n\t\t\t\t\t\t});\n\t\t\t\t\t\tvideo.addEventListener('pause', () => {\n\t\t\t\t\t\t\t// Logger.log('pause', texture.key);\n\t\t\t\t\t\t\ttexture.animated = false;\n\t\t\t\t\t\t\tthis.animated = this.reduce((flag: boolean, texture: Texture) => {\n\t\t\t\t\t\t\t\treturn flag || texture.animated;\n\t\t\t\t\t\t\t}, false);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tvideo.addEventListener('seeked', () => {\n\t\t\t\t\t\t\t// Logger.log('seeked');\n\t\t\t\t\t\t\ttexture.update(gl, texture.options);\n\t\t\t\t\t\t\tthis.dirty = true;\n\t\t\t\t\t\t});\n\t\t\t\t\t\t// Logger.log('video');\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tvideo.addEventListener('canplaythrough', () => {\n\t\t\t\t\t\t\t// !!!\n\t\t\t\t\t\t\tthis.intervalID = setInterval(() => {\n\t\t\t\t\t\t\t\tthis.update(gl, options);\n\t\t\t\t\t\t\t}, 15);\n\t\t\t\t\t\t}, true);\n\t\t\t\t\t\tvideo.addEventListener('ended', () => {\n\t\t\t\t\t\t\tvideo.currentTime = 0;\n\t\t\t\t\t\t\tvideo.play();\n\t\t\t\t\t\t}, true);\n\t\t\t\t\t\t*/\n\t\t\t\t\t}\n\t\t\t\t\treturn texture;\n\t\t\t\t}\n\t\t\t);\n\t\t} else {\n\t\t\treturn Promise.resolve(texture);\n\t\t}\n\t}\n}\n","import Logger from '../logger/logger';\n\nexport class Listener {\n\tevent: string;\n\tcallback: Function;\n\n\tconstructor(\n\t\tevent: string,\n\t\tcallback: Function\n\t) {\n\t\tthis.event = event;\n\t\tthis.callback = callback;\n\t}\n}\n\nexport default class Subscriber {\n\tprivate listeners: Set<Listener> = new Set<Listener>();\n\n\tlogListeners() {\n\t\tthis.listeners.forEach(x => Logger.log(x));\n\t}\n\n\tsubscribe(listener: Listener) {\n\t\tthis.listeners.add(listener);\n\t}\n\n\tunsubscribe(listener: Listener) {\n\t\tthis.listeners.delete(listener);\n\t}\n\n\tunsubscribeAll() {\n\t\tthis.listeners.clear();\n\t}\n\n\ton(event: string, callback: Function) {\n\t\tthis.listeners.add(new Listener(event, callback));\n\t\treturn this;\n\t}\n\n\toff(event: string, callback?: Function) {\n\t\tif (callback) {\n\t\t\tthis.listeners.delete(new Listener(event, callback));\n\t\t} else {\n\t\t\tthis.listeners.forEach(x => {\n\t\t\t\tif (x.event === event) {\n\t\t\t\t\tthis.listeners.delete(x);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\treturn this;\n\t}\n\n\ttrigger(event: string, ...data: any[]) {\n\t\tthis.listeners.forEach(x => {\n\t\t\tif (x.event === event && typeof x.callback === 'function') {\n\t\t\t\tx.callback(...data);\n\t\t\t}\n\t\t});\n\t\treturn this;\n\t}\n\n}\n","\nimport IterableStringMap from '../core/iterable';\nimport Logger from '../logger/logger';\nimport { Texture } from '../textures/textures';\n\nexport enum UniformMethod {\n\tUnknown = 0,\n\tUniform1i = 'uniform1i', // (intUniformLoc,   v);                 // for int\n\t// Uniform1i  = 'uniform1i', // (boolUniformLoc,   v);                // for bool\n\t// Uniform1i  = 'uniform1i', // (sampler2DUniformLoc,   v);           // for sampler2D\n\t// Uniform1i  = 'uniform1i', // (samplerCubeUniformLoc,   v);         // for samplerCube\n\tUniform2i = 'uniform2i', // (ivec2UniformLoc, v0, v1);            // for ivec2\n\tUniform3i = 'uniform3i', // (ivec3UniformLoc, v0, v1, v2);        // for ivec3\n\tUniform4i = 'uniform4i', // (ivec4UniformLoc, v0, v1, v2, v4);    // for ivec4\n\tUniform1f = 'uniform1f', // (floatUniformLoc, v);                 // for float\n\tUniform2f = 'uniform2f', // (vec2UniformLoc,  v0, v1);            // for vec2\n\tUniform3f = 'uniform3f', // (vec3UniformLoc,  v0, v1, v2);        // for vec3\n\tUniform4f = 'uniform4f', // (vec4UniformLoc,  v0, v1, v2, v4);    // for vec4\n\t//\n\tUniform1iv = 'uniform1iv', // (intUniformLoc, [v]);                 // for int or int array\n\t// Uniform1iv = 'uniform1iv', // (boolUniformLoc, [v]);                // for bool or bool array\n\t// Uniform1iv = 'uniform1iv', // (sampler2DUniformLoc, [v]);           // for sampler2D or sampler2D array\n\t// Uniform1iv = 'uniform1iv', // (samplerCubeUniformLoc, [v]);         // for samplerCube or samplerCube array\n\tUniform2iv = 'uniform2iv', // (ivec2UniformLoc, [v0, v1]);          // for ivec2 or ivec2 array\n\tUniform3iv = 'uniform3iv', // (ivec3UniformLoc, [v0, v1, v2]);      // for ivec3 or ivec3 array\n\tUniform4iv = 'uniform4iv', // (ivec4UniformLoc, [v0, v1, v2, v4]);  // for ivec4 or ivec4 array\n\t//\n\tUniform1fv = 'uniform1fv', // (floatUniformLoc, [v]);               // for float or float array\n\tUniform2fv = 'uniform2fv', // (vec2UniformLoc,  [v0, v1]);          // for vec2 or vec2 array\n\tUniform3fv = 'uniform3fv', // (vec3UniformLoc,  [v0, v1, v2]);      // for vec3 or vec3 array\n\tUniform4fv = 'uniform4fv', // (vec4UniformLoc,  [v0, v1, v2, v4]);  // for vec4 or vec4 array\n\t//\n\tUniformMatrix2fv = 'uniformMatrix2fv', // (mat2UniformLoc, false, [  4x element array ])  // for mat2 or mat2 array\n\tUniformMatrix3fv = 'uniformMatrix3fv', // (mat3UniformLoc, false, [  9x element array ])  // for mat3 or mat3 array\n\tUniformMatrix4fv = 'uniformMatrix4fv', // (mat4UniformLoc, false, [ 16x element array ])  // for mat4 or mat4 array\n}\n\nexport enum UniformType {\n\tUnknown = 0,\n\tFloat,\n\tInt,\n\tBool,\n\tSampler2D,\n\tSamplerCube,\n\tMatrix2fv,\n\tMatrix3fv,\n\tMatrix4fv,\n}\n\nexport const METHODS_INT = [UniformMethod.Uniform1i, UniformMethod.Uniform2i, UniformMethod.Uniform3i, UniformMethod.Uniform4i];\nexport const METHODS_FLOAT = [UniformMethod.Uniform1f, UniformMethod.Uniform2f, UniformMethod.Uniform3f, UniformMethod.Uniform4f];\nexport const METHODS_INTV = [UniformMethod.Uniform1iv, UniformMethod.Uniform2iv, UniformMethod.Uniform3iv, UniformMethod.Uniform4iv];\nexport const METHODS_FLOATV = [UniformMethod.Uniform1fv, UniformMethod.Uniform2fv, UniformMethod.Uniform3fv, UniformMethod.Uniform4fv];\n\nexport interface IUniformOption { [key: string]: any[]; }\n\nexport class Uniform {\n\tmethod: UniformMethod;\n\ttype: UniformType;\n\tkey: string;\n\tvalues: any[];\n\tlocation?: WebGLUniformLocation;\n\tdirty?: boolean = true;\n\tapply?: Function;\n\n\tconstructor(options?: Uniform) {\n\t\tif (options) {\n\t\t\tObject.assign(this, options);\n\t\t}\n\t\tthis.apply = (gl: WebGLRenderingContext | WebGL2RenderingContext, program: WebGLProgram) => {\n\t\t\tif (this.dirty) {\n\t\t\t\tgl.useProgram(program);\n\t\t\t\tconst location = gl.getUniformLocation(program, this.key);\n\t\t\t\t// Logger.log(this.key, this.method, this.values);\n\t\t\t\t// (gl as any)[this.method].apply(gl, [location].concat(this.values));\n\t\t\t\t(gl as any)[this.method].apply(gl, [location].concat(this.values));\n\t\t\t}\n\t\t}\n\t}\n\n}\n\nexport class UniformTexture extends Uniform {\n\n\ttexture: Texture;\n\n\tconstructor(options?: Uniform) {\n\t\tsuper(options);\n\t}\n\n}\n\nexport default class Uniforms extends IterableStringMap<Uniform> {\n\n\tdirty: boolean = false;\n\n\t/*\n\t// slow\n\tstatic isDifferent(a: any, b: any): boolean {\n        return JSON.stringify(a) !== JSON.stringify(b);\n    }\n\t*/\n\n\tstatic isDifferent(a: any[], b: any[]) {\n\t\treturn a.length !== b.length ||\n\t\t\ta.reduce((f: boolean, v: any, i: number) => {\n\t\t\t\treturn f || v !== b[i];\n\t\t\t}, false);\n\t}\n\n\tstatic isArrayOfInteger(array: any[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: any) => {\n\t\t\treturn flag && Number.isInteger(value);\n\t\t}, true);\n\t}\n\n\tstatic isArrayOfNumber(array: any[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: any) => {\n\t\t\treturn flag && typeof value === 'number';\n\t\t}, true);\n\t}\n\n\tstatic isArrayOfBoolean(array: any[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: any) => {\n\t\t\treturn flag && typeof value === 'boolean';\n\t\t}, true);\n\t}\n\n\tstatic isArrayOfTexture(array: any[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: any) => {\n\t\t\treturn flag && Texture.isTexture(value);\n\t\t}, true);\n\t}\n\n\tstatic isArrayOfSampler2D(array: Uniform[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: Uniform) => {\n\t\t\treturn flag && value.type === UniformType.Sampler2D;\n\t\t}, true);\n\t}\n\n\tprivate static getType_(\n\t\tvalues: any[],\n\t): UniformType {\n\t\tlet type = UniformType.Unknown;\n\t\tconst isVector = values.length === 1 && Array.isArray(values[0]);\n\t\tconst subject = isVector ? values[0] : values;\n\t\tif (Uniforms.isArrayOfNumber(subject)) {\n\t\t\ttype = UniformType.Float;\n\t\t} else if (Uniforms.isArrayOfBoolean(subject)) {\n\t\t\ttype = UniformType.Bool;\n\t\t} else if (Uniforms.isArrayOfTexture(subject)) {\n\t\t\ttype = UniformType.Sampler2D;\n\t\t}\n\t\treturn type;\n\t}\n\n\tprivate static getMethod_(\n\t\ttype: UniformType,\n\t\tvalues: any[],\n\t): UniformMethod {\n\t\tlet method = UniformMethod.Unknown;\n\t\tconst isVector = values.length === 1 && Array.isArray(values[0]);\n\t\tconst subject = isVector ? values[0] : values;\n\t\tconst length = subject.length;\n\t\tconst i = length - 1;\n\t\tswitch (type) {\n\t\t\tcase UniformType.Float:\n\t\t\t\tif (isVector) {\n\t\t\t\t\tmethod = i < METHODS_FLOATV.length ? METHODS_FLOATV[i] : UniformMethod.Unknown;\n\t\t\t\t} else {\n\t\t\t\t\tmethod = i < METHODS_FLOAT.length ? METHODS_FLOAT[i] : UniformMethod.Uniform1fv;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase UniformType.Int:\n\t\t\tcase UniformType.Bool:\n\t\t\t\tif (isVector) {\n\t\t\t\t\tmethod = i < METHODS_INTV.length ? METHODS_INTV[i] : UniformMethod.Unknown;\n\t\t\t\t} else {\n\t\t\t\t\tmethod = i < METHODS_INT.length ? METHODS_INT[i] : UniformMethod.Uniform1iv;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase UniformType.Sampler2D:\n\t\t\t\tif (isVector) {\n\t\t\t\t\tmethod = UniformMethod.Uniform1iv;\n\t\t\t\t} else {\n\t\t\t\t\tmethod = length === 1 ? UniformMethod.Uniform1i : UniformMethod.Uniform1iv;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\t\treturn method;\n\t}\n\n\tstatic parseUniform(\n\t\tkey: string,\n\t\tvalues: any[],\n\t\ttype: UniformType = null\n\t): Uniform | Uniform[] {\n\t\tlet uniform: Uniform;\n\t\ttype = type || Uniforms.getType_(values);\n\t\tconst method = Uniforms.getMethod_(type, values);\n\t\tif (type !== UniformType.Unknown && method !== UniformMethod.Unknown) {\n\t\t\t// Logger.log('Uniforms.parseUniform', key, UniformType[type], method, values);\n\t\t\tif (type === UniformType.Sampler2D && method === UniformMethod.Uniform1iv) {\n\t\t\t\treturn values[0].map((texture: any, index: number) => {\n\t\t\t\t\treturn new Uniform({\n\t\t\t\t\t\tmethod: method,\n\t\t\t\t\t\ttype: type,\n\t\t\t\t\t\tkey: `${key}[${index}]`, // `${key.split('[')[0]}[${index}]`,\n\t\t\t\t\t\tvalues: [texture]\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tuniform = new Uniform({\n\t\t\t\t\tmethod: method,\n\t\t\t\t\ttype: type,\n\t\t\t\t\tkey: key,\n\t\t\t\t\tvalues: values\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tLogger.error('Uniforms.parseUniform.Unknown', key, values);\n\t\t}\n\t\t// return this.parseUniform__bak(key, values);\n\t\treturn uniform;\n\t}\n\n\tcreate(method: UniformMethod, type: UniformType, key: string, values: any[]): Uniform {\n\t\tconst uniform = new Uniform({\n\t\t\tmethod: method,\n\t\t\ttype: type,\n\t\t\tkey: key,\n\t\t\tvalues: values,\n\t\t});\n\t\tthis.set(key, uniform);\n\t\tthis.dirty = true;\n\t\treturn uniform;\n\t}\n\n\tcreateTexture(key: string, index: number): UniformTexture {\n\t\tlet uniform;\n\t\tif (key.indexOf(']') !== -1) {\n\t\t\tuniform = new UniformTexture({\n\t\t\t\tmethod: UniformMethod.Uniform1iv,\n\t\t\t\ttype: UniformType.Sampler2D,\n\t\t\t\tkey: key,\n\t\t\t\tvalues: [[index]],\n\t\t\t});\n\t\t} else {\n\t\t\tuniform = new UniformTexture({\n\t\t\t\tmethod: UniformMethod.Uniform1i,\n\t\t\t\ttype: UniformType.Sampler2D,\n\t\t\t\tkey: key,\n\t\t\t\tvalues: [index],\n\t\t\t});\n\t\t}\n\t\tthis.set(key, uniform);\n\t\tthis.dirty = true;\n\t\treturn uniform;\n\t}\n\n\tupdate(method: UniformMethod, type: UniformType, key: string, values: any[]) {\n\t\tconst uniform = this.get(key);\n\t\tif (uniform &&\n\t\t\t(uniform.method !== method ||\n\t\t\t\tuniform.type !== type ||\n\t\t\t\tUniforms.isDifferent(uniform.values, values)\n\t\t\t)) {\n\t\t\tuniform.method = method;\n\t\t\tuniform.type = type;\n\t\t\tuniform.values = values;\n\t\t\tuniform.dirty = true;\n\t\t\tthis.dirty = true;\n\t\t}\n\t}\n\n\tcreateOrUpdate(method: UniformMethod, type: UniformType, key: string, values: any[]) {\n\t\tif (this.has(key)) {\n\t\t\tthis.update(method, type, key, values);\n\t\t} else {\n\t\t\tthis.create(method, type, key, values);\n\t\t}\n\t}\n\n\tapply(gl: WebGLRenderingContext | WebGL2RenderingContext, program: WebGLProgram) {\n\t\tfor (const key in this.values) {\n\t\t\t// if (typeof this.values[key].apply === 'function') {\n\t\t\tthis.values[key].apply(gl, program);\n\t\t\t// }\n\t\t}\n\t\t// this.forEach(uniform => uniform.apply(gl, program));\n\t}\n\n\tclean() {\n\t\tfor (const key in this.values) {\n\t\t\tthis.values[key].dirty = false;\n\t\t}\n\t\tthis.dirty = false;\n\t}\n\n}\n","export default class CanvasTimer {\n\n\tstart: number;\n\tprevious: number;\n\tdelay: number = 0.0;\n\tcurrent: number = 0.0;\n\tdelta: number = 0.0;\n\tpaused: boolean = false;\n\n\tconstructor() {\n\t\tthis.start = this.previous = this.now();\n\t}\n\n\tnow() {\n\t\treturn performance.now();\n\t}\n\n\tplay() {\n\t\tif (this.previous) {\n\t\t\tconst now = this.now();\n\t\t\tthis.delay += (now - this.previous);\n\t\t\tthis.previous = now;\n\t\t}\n\t\t// Logger.log(this.delay);\n\t\tthis.paused = false;\n\t}\n\n\tpause() {\n\t\tthis.paused = true;\n\t}\n\n\tnext(): CanvasTimer {\n\t\tconst now = this.now();\n\t\tthis.delta = now - this.previous;\n\t\tthis.current = now - this.start - this.delay;\n\t\tthis.previous = now;\n\t\treturn this;\n\t}\n\n}\n","// import '@babel/polyfill';\nimport 'promise-polyfill';\nimport Buffers, { IOBuffer } from '../buffers/buffers';\nimport Context, { ContextDefaultFragment, ContextVertexBuffers, IContextOptions } from '../context/context';\nimport Common from '../core/common';\nimport Subscriber from '../core/subscriber';\nimport Logger from '../logger/logger';\nimport Textures, { ITextureData, ITextureInput, ITextureOptions, Texture } from '../textures/textures';\nimport Uniforms, { IUniformOption, Uniform, UniformMethod, UniformType } from '../uniforms/uniforms';\nimport CanvasTimer from './canvas-timer';\n\nexport interface IPoint {\n\tx: number,\n\ty: number,\n}\n\nexport interface ICanvasOptions extends IContextOptions {\n\tvertexString?: string;\n\tfragmentString?: string;\n\tbackgroundColor?: string;\n\tworkpath?: string;\n\tonError?: Function;\n\textensions?: string[];\n}\n\nexport default class Canvas extends Subscriber {\n\toptions: ICanvasOptions;\n\tcanvas: HTMLCanvasElement;\n\tgl: WebGLRenderingContext | WebGL2RenderingContext;\n\tprogram: WebGLProgram;\n\ttimer: CanvasTimer;\n\tvertexBuffers: ContextVertexBuffers;\n\trect: ClientRect | DOMRect;\n\tmouse: IPoint = { x: 0, y: 0 };\n\tuniforms: Uniforms = new Uniforms();\n\tbuffers: Buffers = new Buffers();\n\ttextures: Textures = new Textures();\n\ttextureList: ITextureInput[] = [];\n\n\tvertexString: string;\n\tfragmentString: string;\n\twidth: number;\n\theight: number;\n\tdevicePixelRatio: number;\n\n\tvalid: boolean = false;\n\tanimated: boolean = false;\n\tdirty: boolean = true;\n\tvisible: boolean = false;\n\n\trafId: number;\n\n\tconstructor(\n\t\tcanvas: HTMLCanvasElement,\n\t\toptions: ICanvasOptions = {\n\t\t\t// alpha: true,\n\t\t\t// antialias: true,\n\t\t\t// premultipliedAlpha: true\n\t\t}\n\t) {\n\t\tsuper();\n\t\tif (!canvas) {\n\t\t\treturn;\n\t\t}\n\t\tthis.options = options;\n\t\tthis.canvas = canvas;\n\t\tthis.width = 0; // canvas.clientWidth;\n\t\tthis.height = 0; // canvas.clientHeight;\n\t\tthis.rect = canvas.getBoundingClientRect();\n\t\tthis.devicePixelRatio = window.devicePixelRatio || 1;\n\t\tcanvas.style.backgroundColor = options.backgroundColor || 'rgba(0,0,0,0)';\n\t\tthis.getShaders_().then((success) => {\n\t\t\t/*\n\t\t\tconst v = this.vertexString = options.vertexString || this.vertexString;\n\t\t\tconst f = this.fragmentString = options.fragmentString || this.fragmentString;\n\t\t\tthis.vertexString = Context.getVertex(v, f);\n\t\t\tthis.fragmentString = Context.getFragment(v, f);\n\t\t\tconst gl = Context.tryInferContext(v, f, canvas, options, options.onError);\n\t\t\tif (!gl) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.gl = gl;\n\t\t\t*/\n\t\t\tthis.load().then(success => {\n\t\t\t\tif (!this.program) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.addListeners_();\n\t\t\t\tthis.onLoop();\n\t\t\t});\n\t\t}, (error) => {\n\t\t\tLogger.log('GlslCanvas.getShaders_.error', error);\n\t\t});\n\t\tCanvas.items.push(this);\n\t}\n\n\tstatic logger: Logger = Logger;\n\tstatic items: Canvas[] = [];\n\n\tstatic version(): string {\n\t\treturn '0.1.6';\n\t}\n\n\tstatic of(canvas: HTMLCanvasElement, options?: ICanvasOptions): Canvas {\n\t\treturn Canvas.items.find(x => x.canvas === canvas) || new Canvas(canvas, options);\n\t}\n\n\tstatic loadAll(): Canvas[] {\n\t\tconst canvases: HTMLCanvasElement[] = <HTMLCanvasElement[]>[].slice.call(document.getElementsByClassName('glsl-canvas')).filter((x: HTMLElement) => x instanceof HTMLCanvasElement);\n\t\treturn canvases.map(x => Canvas.of(x));\n\t}\n\n\tprivate getShaders_(): Promise<string[]> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst canvas = this.canvas;\n\t\t\tconst urls: any = {};\n\t\t\tif (canvas.hasAttribute('data-vertex-url')) {\n\t\t\t\turls.vertex = canvas.getAttribute('data-vertex-url');\n\t\t\t}\n\t\t\tif (canvas.hasAttribute('data-fragment-url')) {\n\t\t\t\turls.fragment = canvas.getAttribute('data-fragment-url');\n\t\t\t}\n\t\t\tif (canvas.hasAttribute('data-vertex')) {\n\t\t\t\tthis.vertexString = canvas.getAttribute('data-vertex');\n\t\t\t}\n\t\t\tif (canvas.hasAttribute('data-fragment')) {\n\t\t\t\tthis.fragmentString = canvas.getAttribute('data-fragment');\n\t\t\t}\n\t\t\tif (Object.keys(urls).length) {\n\t\t\t\tPromise.all(Object.keys(urls).map((key, i) => {\n\t\t\t\t\tconst url: string = urls[key];\n\t\t\t\t\treturn Common.fetch(url)\n\t\t\t\t\t\t// .then((response) => response.text())\n\t\t\t\t\t\t.then((body) => {\n\t\t\t\t\t\t\tif (key === 'vertex') {\n\t\t\t\t\t\t\t\treturn this.vertexString = body;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\treturn this.fragmentString = body;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t})).then(shaders => {\n\t\t\t\t\tresolve([this.vertexString, this.fragmentString]);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tresolve([this.vertexString, this.fragmentString]);\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate addListeners_(): void {\n        /*\n        const resize = (e: Event) => {\n            this.rect = this.canvas.getBoundingClientRect();\n            this.trigger('resize', e);\n        };\n        */\n\t\tthis.onScroll = this.onScroll.bind(this);\n\t\tthis.onClick = this.onClick.bind(this);\n\t\tthis.onMove = this.onMove.bind(this);\n\t\tthis.onMousemove = this.onMousemove.bind(this);\n\t\tthis.onMouseover = this.onMouseover.bind(this);\n\t\tthis.onMouseout = this.onMouseout.bind(this);\n\t\tthis.onTouchmove = this.onTouchmove.bind(this);\n\t\tthis.onTouchend = this.onTouchend.bind(this);\n\t\tthis.onTouchstart = this.onTouchstart.bind(this);\n\t\tthis.onLoop = this.onLoop.bind(this);\n\t\t// window.addEventListener('resize', this.onResize);\n\t\twindow.addEventListener('scroll', this.onScroll);\n\t\tdocument.addEventListener('mousemove', this.onMousemove, false);\n\t\tdocument.addEventListener('touchmove', this.onTouchmove);\n\t\tthis.addCanvasListeners_();\n\t}\n\n\tprivate addCanvasListeners_() {\n\t\tif (this.canvas.hasAttribute('controls')) {\n\t\t\tthis.canvas.addEventListener('click', this.onClick);\n\t\t\tthis.canvas.addEventListener('mouseover', this.onMouseover);\n\t\t\tthis.canvas.addEventListener('mouseout', this.onMouseout);\n\t\t\tthis.canvas.addEventListener('touchstart', this.onTouchstart);\n\t\t\tif (!this.canvas.hasAttribute('data-autoplay')) {\n\t\t\t\tthis.pause();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate removeCanvasListeners_() {\n\t\tif (this.canvas.hasAttribute('controls')) {\n\t\t\tthis.canvas.removeEventListener('click', this.onClick);\n\t\t\tthis.canvas.removeEventListener('mouseover', this.onMouseover);\n\t\t\tthis.canvas.removeEventListener('mouseout', this.onMouseout);\n\t\t\tthis.canvas.removeEventListener('touchstart', this.onTouchstart);\n\t\t}\n\t}\n\n\tprivate removeListeners_() {\n\t\twindow.cancelAnimationFrame(this.rafId);\n\t\t// window.removeEventListener('resize', this.onResize);\n\t\twindow.removeEventListener('scroll', this.onScroll);\n\t\tdocument.removeEventListener('mousemove', this.onMousemove);\n\t\tdocument.removeEventListener('touchmove', this.onTouchmove);\n\t\tthis.removeCanvasListeners_();\n\t}\n\n\tonScroll(e: Event) {\n\t\tthis.rect = this.canvas.getBoundingClientRect();\n\t}\n\n\tonClick(e: MouseEvent) {\n\t\tthis.toggle();\n\t\tthis.trigger('click', e);\n\t}\n\n\tonMove(mx: number, my: number) {\n\t\t/*\n\t\tconst rect = this.rect, gap = 20;\n\t\tconst x = Math.max(-gap, Math.min(rect.width + gap, (mx - rect.left) * this.devicePixelRatio));\n\t\tconst y = Math.max(-gap, Math.min(rect.height + gap, (this.canvas.height - (my - rect.top) * this.devicePixelRatio)));\n\t\t*/\n\t\tconst rect = this.rect;\n\t\tconst x = (mx - rect.left) * this.devicePixelRatio;\n\t\tconst y = (rect.height - (my - rect.top)) * this.devicePixelRatio;\n\t\tif (x !== this.mouse.x ||\n\t\t\ty !== this.mouse.y) {\n\t\t\tthis.mouse.x = x;\n\t\t\tthis.mouse.y = y;\n\t\t\tthis.trigger('move', this.mouse);\n\t\t}\n\t}\n\n\tonMousemove(e: MouseEvent) {\n\t\tthis.onMove(e.clientX || e.pageX, e.clientY || e.pageY);\n\t}\n\n\tonMouseover(e: MouseEvent) {\n\t\tthis.play();\n\t\tthis.trigger('over', e);\n\t}\n\n\tonMouseout(e: MouseEvent) {\n\t\tthis.pause();\n\t\tthis.trigger('out', e);\n\t}\n\n\tonTouchmove(e: TouchEvent) {\n\t\tconst touch = [].slice.call(e.touches).reduce((p: IPoint, touch: Touch) => {\n\t\t\tp = p || { x: 0, y: 0 };\n\t\t\tp.x += touch.clientX;\n\t\t\tp.y += touch.clientY;\n\t\t\treturn p;\n\t\t}, null);\n\t\tif (touch) {\n\t\t\tthis.onMove(touch.x / e.touches.length, touch.y / e.touches.length);\n\t\t}\n\t}\n\n\tonTouchend(e: TouchEvent) {\n\t\tthis.pause();\n\t\tthis.trigger('out', e);\n\t\tdocument.removeEventListener('touchend', this.onTouchend);\n\t}\n\n\tonTouchstart(e: TouchEvent) {\n\t\tthis.play();\n\t\tthis.trigger('over', e);\n\t\tdocument.addEventListener('touchend', this.onTouchend);\n\t\tdocument.removeEventListener('mousemove', this.onMousemove);\n\t\tif (this.canvas.hasAttribute('controls')) {\n\t\t\tthis.canvas.removeEventListener('mouseover', this.onMouseover);\n\t\t\tthis.canvas.removeEventListener('mouseout', this.onMouseout);\n\t\t}\n\t}\n\n\tonLoop(time?: number) {\n\t\tthis.checkRender();\n\t\tthis.rafId = window.requestAnimationFrame(this.onLoop);\n\t}\n\n\tprivate setUniform_(\n\t\tkey: string,\n\t\tvalues: any[],\n\t\toptions: ITextureOptions = {},\n\t\ttype: UniformType = null\n\t): void {\n\t\tconst uniform: Uniform | Uniform[] = Uniforms.parseUniform(key, values, type);\n\t\tif (Array.isArray(uniform)) {\n\t\t\tif (Uniforms.isArrayOfSampler2D(uniform)) {\n\t\t\t\tuniform.forEach((x) => this.loadTexture(x.key, x.values[0], options));\n\t\t\t} else {\n\t\t\t\tuniform.forEach((x) => this.uniforms.set(x.key, x.values[0]));\n\t\t\t}\n\t\t} else if (uniform) {\n\t\t\tswitch (uniform.type) {\n\t\t\t\tcase UniformType.Sampler2D:\n\t\t\t\t\tthis.loadTexture(key, values[0], options);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthis.uniforms.set(key, uniform);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate parseTextures_(fragmentString: string): boolean {\n\t\t// const regexp = /uniform\\s*sampler2D\\s*([\\w]*);(\\s*\\/\\/\\s*([\\w|\\:\\/\\/|\\.|\\-|\\_]*)|\\s*)/gm;\n\t\tconst regexp = /uniform\\s*sampler2D\\s*([\\w]*);(\\s*\\/\\/\\s*([\\w|\\:\\/\\/|\\.|\\-|\\_|\\?|\\&|\\=]*)|\\s*)/gm;\n\t\t// const regexp = /uniform\\s*sampler2D\\s*([\\w]*);(\\s*\\/\\/\\s*([\\w|\\://|\\.|\\-|\\_]*)|\\s*)((\\s*\\:\\s)(\\{(\\s*\\w*\\:\\s*['|\"]{0,1}\\w*['|\"]{0,1}\\s*[,]{0,1})+\\}))*/gm;\n\t\tlet matches;\n\t\twhile ((matches = regexp.exec(fragmentString)) !== null) {\n\t\t\tconst key = matches[1];\n\t\t\tconst url = matches[3];\n\t\t\tif (Texture.isTextureUrl(url)) {\n\t\t\t\tthis.textureList.push({ key, url });\n\t\t\t\t/*\n\t\t\t\tif (matches[3]) {\n\t\t\t\t\tconst ext = matches[3].split('?')[0].split('.').pop().toLowerCase();\n\t\t\t\t\tconst url = matches[3];\n\t\t\t\t\tif (url && TextureExtensions.indexOf(ext) !== -1) {\n\t\t\t\t\t\t// let options;\n\t\t\t\t\t\t// if (matches[6]) {\n\t\t\t\t\t\t// \ttry {\n\t\t\t\t\t\t// \t\toptions = new Function(`return ${matches[6]};`)();\n\t\t\t\t\t\t// \t} catch (e) {\n\t\t\t\t\t\t// \t\t// console.log('wrong texture options');\n\t\t\t\t\t\t// \t}\n\t\t\t\t\t\t// }\n\t\t\t\t\t\t// console.log(options, matches[6]);\n\t\t\t\t\t\t// this.textureList.push({ key, url, options });\n\t\t\t\t\t\tthis.textureList.push({ key, url });\n\t\t\t\t\t}\n\t\t\t\t*/\n\t\t\t} else if (!this.buffers.has(key)) {\n\t\t\t\t// create empty texture\n\t\t\t\tthis.textureList.push({ key, url: null });\n\t\t\t}\n\t\t}\n\t\tif (this.canvas.hasAttribute('data-textures')) {\n\t\t\tconst urls = this.canvas.getAttribute('data-textures').split(',');\n\t\t\turls.forEach((url: string, i: number) => {\n\t\t\t\tconst key = 'u_texture' + i;\n\t\t\t\tthis.textureList.push({ key, url });\n\t\t\t});\n\t\t}\n\t\treturn this.textureList.length > 0;\n\t}\n\n\tprivate createUniforms_(): void {\n\t\tconst gl = this.gl;\n\t\tconst fragmentString = this.fragmentString;\n\t\tconst BW = gl.drawingBufferWidth;\n\t\tconst BH = gl.drawingBufferHeight;\n\t\tconst timer = this.timer = new CanvasTimer();\n\t\tconst hasDelta = (fragmentString.match(/u_delta/g) || []).length > 1;\n\t\tconst hasTime = (fragmentString.match(/u_time/g) || []).length > 1;\n\t\tconst hasDate = (fragmentString.match(/u_date/g) || []).length > 1;\n\t\tconst hasMouse = (fragmentString.match(/u_mouse/g) || []).length > 1;\n\t\tconst hasTextures = this.parseTextures_(fragmentString);\n\t\tthis.animated = hasTime || hasDate || hasMouse;\n\t\tif (this.animated) {\n\t\t\tthis.canvas.classList.add('animated');\n\t\t} else {\n\t\t\tthis.canvas.classList.remove('animated');\n\t\t}\n\t\tthis.uniforms.create(UniformMethod.Uniform2f, UniformType.Float, 'u_resolution', [BW, BH]);\n\t\tif (hasDelta) {\n\t\t\tthis.uniforms.create(UniformMethod.Uniform1f, UniformType.Float, 'u_delta', [timer.delta / 1000.0]);\n\t\t}\n\t\tif (hasTime) {\n\t\t\tthis.uniforms.create(UniformMethod.Uniform1f, UniformType.Float, 'u_time', [timer.current / 1000.0]);\n\t\t}\n\t\tif (hasDate) {\n\t\t\tconst date = new Date();\n\t\t\tthis.uniforms.create(UniformMethod.Uniform4f, UniformType.Float, 'u_date', [date.getFullYear(), date.getMonth(), date.getDate(), date.getHours() * 3600 + date.getMinutes() * 60 + date.getSeconds() + date.getMilliseconds() * 0.001]);\n\t\t}\n\t\tif (hasMouse) {\n\t\t\tthis.uniforms.create(UniformMethod.Uniform2f, UniformType.Float, 'u_mouse', [0, 0]);\n\t\t}\n\t\tfor (const key in this.buffers.values) {\n\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\tthis.uniforms.create(UniformMethod.Uniform1i, UniformType.Sampler2D, buffer.key, [buffer.input.index]);\n\t\t}\n\t\tif (hasTextures) {\n\t\t\tthis.textureList.filter(x => x.url).forEach(x => {\n\t\t\t\tthis.setTexture(x.key, x.url, x.options);\n\t\t\t});\n\t\t\tthis.textureList = [];\n\t\t}\n\t}\n\n\tprivate updateUniforms_(): void {\n\t\tconst gl = this.gl;\n\t\tconst BW = gl.drawingBufferWidth;\n\t\tconst BH = gl.drawingBufferHeight;\n\t\tif (!this.timer) {\n\t\t\treturn;\n\t\t}\n\t\tconst timer = this.timer.next();\n\t\tthis.uniforms.update(UniformMethod.Uniform2f, UniformType.Float, 'u_resolution', [BW, BH]);\n\t\tif (this.uniforms.has('u_delta')) {\n\t\t\tthis.uniforms.update(UniformMethod.Uniform1f, UniformType.Float, 'u_delta', [timer.delta / 1000.0]);\n\t\t}\n\t\tif (this.uniforms.has('u_time')) {\n\t\t\tthis.uniforms.update(UniformMethod.Uniform1f, UniformType.Float, 'u_time', [timer.current / 1000.0]);\n\t\t}\n\t\tif (this.uniforms.has('u_date')) {\n\t\t\tconst date = new Date();\n\t\t\tthis.uniforms.update(UniformMethod.Uniform4f, UniformType.Float, 'u_date', [date.getFullYear(), date.getMonth(), date.getDate(), date.getHours() * 3600 + date.getMinutes() * 60 + date.getSeconds() + date.getMilliseconds() * 0.001]);\n\t\t}\n\t\tif (this.uniforms.has('u_mouse')) {\n\t\t\tconst mouse = this.mouse;\n\t\t\tthis.uniforms.update(UniformMethod.Uniform2f, UniformType.Float, 'u_mouse', [mouse.x, mouse.y]);\n            /*\n            const rect = this.rect;\n            if (mouse.x >= rect.left && mouse.x <= rect.right &&\n                mouse.y >= rect.top && mouse.y <= rect.bottom) {\n                const MX = (mouse.x - rect.left) * this.devicePixelRatio;\n                const MY = (this.canvas.height - (mouse.y - rect.top) * this.devicePixelRatio);\n                this.uniforms.update(UniformMethod.Uniform2f, UniformType.Float, 'u_mouse', [MX, MY]);\n            }\n            */\n\t\t}\n\t\tfor (const key in this.buffers.values) {\n\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\tthis.uniforms.update(UniformMethod.Uniform1i, UniformType.Sampler2D, buffer.key, [buffer.input.index]);\n\t\t}\n\t\tfor (const key in this.textures.values) {\n\t\t\tconst texture: Texture = this.textures.values[key];\n\t\t\ttexture.tryUpdate(gl);\n\t\t\tthis.uniforms.update(UniformMethod.Uniform1i, UniformType.Sampler2D, texture.key, [texture.index]);\n\t\t}\n\t}\n\n\tprivate isVisible_(): boolean {\n\t\tconst rect = this.rect;\n\t\treturn (rect.top + rect.height) > 0 && rect.top < (window.innerHeight || document.documentElement.clientHeight);\n\t}\n\n\tprivate isAnimated_(): boolean {\n\t\treturn (this.animated || this.textures.animated) && !this.timer.paused;\n\t}\n\n\tprivate isDirty_(): boolean {\n\t\treturn this.dirty || this.uniforms.dirty || this.textures.dirty;\n\t}\n\n\t// check size change at start of requestFrame\n\tprivate sizeDidChanged_(): boolean {\n\t\tconst gl = this.gl;\n\t\tconst W = Math.ceil(this.canvas.clientWidth),\n\t\t\tH = Math.ceil(this.canvas.clientHeight);\n\t\tif (this.width !== W ||\n\t\t\tthis.height !== H) {\n\t\t\tthis.width = W;\n\t\t\tthis.height = H;\n\t\t\t// Lookup the size the browser is displaying the canvas in CSS pixels\n\t\t\t// and compute a size needed to make our drawingbuffer match it in\n\t\t\t// device pixels.\n\t\t\tconst BW = Math.ceil(W * this.devicePixelRatio);\n\t\t\tconst BH = Math.ceil(H * this.devicePixelRatio);\n\t\t\tthis.canvas.width = BW;\n\t\t\tthis.canvas.height = BH;\n            /*\n            if (gl.canvas.width !== BW ||\n                gl.canvas.height !== BH) {\n                gl.canvas.width = BW;\n                gl.canvas.height = BH;\n                // Set the viewport to match\n                // gl.viewport(0, 0, BW, BH);\n            }\n            */\n\t\t\tfor (const key in this.buffers.values) {\n\t\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\t\tbuffer.resize(gl, BW, BH);\n\t\t\t}\n\t\t\tthis.rect = this.canvas.getBoundingClientRect();\n\t\t\tthis.trigger('resize');\n\t\t\t// gl.useProgram(this.program);\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tload(\n\t\tfragmentString?: string,\n\t\tvertexString?: string\n\t): Promise<boolean> {\n\t\treturn Promise.all([\n\t\t\tContext.getIncludes(fragmentString || this.fragmentString),\n\t\t\tContext.getIncludes(vertexString || this.vertexString)\n\t\t]).then(array => {\n\t\t\tthis.fragmentString = array[0];\n\t\t\tthis.vertexString = array[1];\n\t\t\treturn this.createContext_();\n\t\t});\n\t}\n\n\tgetContext_(): WebGLRenderingContext | WebGL2RenderingContext {\n\t\tconst vertexString = this.vertexString;\n\t\tconst fragmentString = this.fragmentString;\n\t\tthis.vertexString = Context.getVertex(vertexString, fragmentString);\n\t\tthis.fragmentString = Context.getFragment(vertexString, fragmentString);\n\t\tif (Context.versionDiffers(this.gl, vertexString, fragmentString)) {\n\t\t\tthis.destroyContext_();\n\t\t\tthis.swapCanvas_();\n\t\t\tthis.uniforms = new Uniforms();\n\t\t\tthis.buffers = new Buffers();\n\t\t\tthis.textures = new Textures();\n\t\t\tthis.textureList = [];\n\t\t}\n\t\tif (!this.gl) {\n\t\t\tconst gl = Context.tryInferContext(vertexString, fragmentString, this.canvas, this.options, this.options.extensions, this.options.onError);\n\t\t\tif (!gl) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tthis.gl = gl;\n\t\t}\n\t\treturn this.gl;\n\t}\n\n\tcreateContext_(): boolean {\n\t\tconst gl = this.getContext_();\n\t\tif (!gl) {\n\t\t\treturn false;\n\t\t}\n\t\tlet vertexShader, fragmentShader;\n\t\ttry {\n\t\t\tvertexShader = Context.createShader(gl, this.vertexString, gl.VERTEX_SHADER);\n\t\t\tfragmentShader = Context.createShader(gl, this.fragmentString, gl.FRAGMENT_SHADER);\n\t\t\t// If Fragment shader fails load a empty one to sign the error\n\t\t\tif (!fragmentShader) {\n\t\t\t\tfragmentShader = Context.createShader(gl, ContextDefaultFragment, gl.FRAGMENT_SHADER);\n\t\t\t\tthis.valid = false;\n\t\t\t} else {\n\t\t\t\tthis.valid = true;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t// !!!\n\t\t\t// console.error(e);\n\t\t\tthis.trigger('error', e);\n\t\t\treturn false;\n\t\t}\n\t\t// Create and use program\n\t\tconst program = Context.createProgram(gl, [vertexShader, fragmentShader]); //, [0,1],['a_texcoord','a_position']);\n\t\tgl.useProgram(program);\n\t\t// Delete shaders\n\t\t// gl.detachShader(program, vertexShader);\n\t\t// gl.detachShader(program, fragmentShader);\n\t\tgl.deleteShader(vertexShader);\n\t\tgl.deleteShader(fragmentShader);\n\t\tthis.program = program;\n\t\tif (this.valid) {\n\t\t\ttry {\n\t\t\t\tthis.buffers = Buffers.getBuffers(gl, this.fragmentString, this.vertexString);\n\t\t\t} catch (e) {\n\t\t\t\t// console.error('load', e);\n\t\t\t\tthis.valid = false;\n\t\t\t\tthis.trigger('error', e);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tthis.vertexBuffers = Context.createVertexBuffers(gl, program);\n\t\t\tthis.createUniforms_();\n\t\t}\n\t\t// Trigger event\n\t\tthis.trigger('load', this);\n\t\treturn this.valid;\n\t}\n\n\ttest(\n\t\tfragmentString?: string,\n\t\tvertexString?: string\n\t): Promise<any> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst vertex = this.vertexString;\n\t\t\tconst fragment = this.fragmentString;\n\t\t\tconst paused = this.timer.paused;\n\t\t\t// Thanks to @thespite for the help here\n\t\t\t// https://www.khronos.org/registry/webgl/extensions/EXT_disjoint_timer_query/\n\t\t\tconst extension = this.gl.getExtension('EXT_disjoint_timer_query');\n\t\t\tconst query = extension.createQueryEXT();\n\t\t\tlet wasValid = this.valid;\n\t\t\tif (fragmentString || vertexString) {\n\t\t\t\tthis.load(fragmentString, vertexString);\n\t\t\t\twasValid = this.valid;\n\t\t\t\tthis.render();\n\t\t\t}\n\t\t\tthis.timer.paused = true;\n\t\t\textension.beginQueryEXT(extension.TIME_ELAPSED_EXT, query);\n\t\t\tthis.render();\n\t\t\textension.endQueryEXT(extension.TIME_ELAPSED_EXT);\n\t\t\tconst waitForTest = () => {\n\t\t\t\tthis.render();\n\t\t\t\tconst available = extension.getQueryObjectEXT(query, extension.QUERY_RESULT_AVAILABLE_EXT);\n\t\t\t\tconst disjoint = this.gl.getParameter(extension.GPU_DISJOINT_EXT);\n\t\t\t\tif (available && !disjoint) {\n\t\t\t\t\tconst result = {\n\t\t\t\t\t\twasValid: wasValid,\n\t\t\t\t\t\tfragment: fragmentString || this.fragmentString,\n\t\t\t\t\t\tvertex: vertexString || this.vertexString,\n\t\t\t\t\t\ttimeElapsedMs: extension.getQueryObjectEXT(query, extension.QUERY_RESULT_EXT) / 1000000.0\n\t\t\t\t\t};\n\t\t\t\t\tthis.timer.paused = paused;\n\t\t\t\t\tif (fragmentString || vertexString) {\n\t\t\t\t\t\tthis.load(fragment, vertex);\n\t\t\t\t\t}\n\t\t\t\t\tresolve(result);\n\t\t\t\t} else {\n\t\t\t\t\twindow.requestAnimationFrame(waitForTest);\n\t\t\t\t}\n\t\t\t}\n\t\t\twaitForTest();\n\t\t});\n\t}\n\n\tdestroyContext_(): void {\n\t\tconst gl = this.gl;\n\t\tgl.useProgram(null);\n\t\tif (this.program) {\n\t\t\tgl.deleteProgram(this.program);\n\t\t}\n\t\tfor (const key in this.buffers.values) {\n\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\tbuffer.destroy(gl);\n\t\t}\n\t\tfor (const key in this.textures.values) {\n\t\t\tconst texture: Texture = this.textures.values[key];\n\t\t\ttexture.destroy(gl);\n\t\t}\n\t\tthis.buffers = null;\n\t\tthis.textures = null;\n\t\tthis.uniforms = null;\n\t\tthis.program = null;\n\t\tthis.gl = null;\n\t}\n\n\tswapCanvas_(): void {\n\t\tconst canvas = this.canvas;\n\t\tconst canvas_ = canvas.cloneNode() as HTMLCanvasElement;\n\t\tcanvas.parentNode.replaceChild(canvas_, canvas);\n\t\tthis.canvas = canvas_;\n\t\tthis.addCanvasListeners_();\n\t}\n\n\tdestroy(): void {\n\t\tthis.removeListeners_();\n\t\tthis.destroyContext_();\n\t\tthis.animated = false;\n\t\tthis.valid = false;\n\t\tCanvas.items.splice(Canvas.items.indexOf(this), 1);\n\t}\n\n\tloadTexture(\n\t\tkey: string,\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t\toptions: ITextureOptions = {}\n\t) {\n\t\tif (this.valid) {\n\t\t\t// Logger.log('GlslCanvas.loadTexture', key, urlElementOrData);\n\t\t\tthis.textures.createOrUpdate(this.gl, key, urlElementOrData, this.buffers.count, options, this.options.workpath).then(\n\t\t\t\ttexture => {\n\t\t\t\t\tconst index = texture.index;\n\t\t\t\t\tconst uniform = this.uniforms.createTexture(key, index);\n\t\t\t\t\tuniform.texture = texture;\n\t\t\t\t\tconst keyResolution = key.indexOf('[') !== -1 ? key.replace('[', 'Resolution[') : key + 'Resolution';\n\t\t\t\t\t// const uniformResolution = ;\n\t\t\t\t\tthis.uniforms.create(UniformMethod.Uniform2f, UniformType.Float, keyResolution, [texture.width, texture.height]);\n\t\t\t\t\t// Logger.log('loadTexture', key, url, index, texture.width, texture.height);\n\t\t\t\t\treturn texture;\n\t\t\t\t},\n\t\t\t\terror => {\n\t\t\t\t\tconst message = Array.isArray(error.path) ? error.path.map((x: any) => x.error ? x.error.message : '').join(', ') : error.message;\n\t\t\t\t\tLogger.log('GlslCanvas.loadTexture.error', key, urlElementOrData, message);\n\t\t\t\t\tthis.trigger('textureError', { key, urlElementOrData, message });\n\t\t\t\t});\n\t\t} else {\n\t\t\tthis.textureList.push({ key, url: urlElementOrData, options });\n\t\t}\n\t}\n\n\tsetTexture(\n\t\tkey: string,\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t\toptions: ITextureOptions = {}\n\t): void {\n\t\treturn this.setUniform_(key, [urlElementOrData], options);\n\t}\n\n\tsetUniform(key: string, ...values: any[]): void {\n\t\treturn this.setUniform_(key, values);\n\t}\n\n\tsetUniformOfInt(key: string, values: any[]): void {\n\t\treturn this.setUniform_(key, values, null, UniformType.Int);\n\t}\n\n\tsetUniforms(values: IUniformOption): void {\n\t\tfor (const key in values) {\n\t\t\tthis.setUniform(key, values[key]);\n\t\t}\n\t}\n\n\tpause(): void {\n\t\tif (this.valid) {\n\t\t\tthis.timer.pause();\n\t\t\tthis.canvas.classList.add('paused');\n\t\t\tthis.trigger('pause');\n\t\t}\n\t}\n\n\tplay(): void {\n\t\tif (this.valid) {\n\t\t\tthis.timer.play();\n\t\t\tthis.canvas.classList.remove('paused');\n\t\t\tthis.trigger('play');\n\t\t}\n\t}\n\n\ttoggle(): void {\n\t\tif (this.valid) {\n\t\t\tif (this.timer.paused) {\n\t\t\t\tthis.play();\n\t\t\t} else {\n\t\t\t\tthis.pause();\n\t\t\t}\n\t\t}\n\t}\n\n\tcheckRender(): void {\n\t\tif (this.isVisible_() && (this.sizeDidChanged_() || this.isAnimated_() || this.isDirty_())) {\n\t\t\tthis.render();\n\t\t\tthis.canvas.classList.add('playing');\n\t\t} else {\n\t\t\tthis.canvas.classList.remove('playing');\n\t\t}\n\t}\n\n\trender(): void {\n\t\tconst gl = this.gl;\n\t\tif (!gl) {\n\t\t\treturn;\n\t\t}\n\t\tconst BW = gl.drawingBufferWidth;\n\t\tconst BH = gl.drawingBufferHeight;\n\t\tthis.updateUniforms_();\n\t\tfor (const key in this.buffers.values) {\n\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\tthis.uniforms.apply(gl, buffer.program);\n\t\t\tbuffer.render(gl, BW, BH);\n\t\t}\n\t\tgl.useProgram(this.program);\n\t\tthis.uniforms.apply(gl, this.program);\n\t\tgl.viewport(0, 0, BW, BH);\n\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\t\tgl.drawArrays(gl.TRIANGLES, 0, 6);\n\t\tthis.uniforms.clean();\n\t\tthis.textures.clean();\n\t\tthis.dirty = false;\n\t\tthis.trigger('render', this);\n\t}\n\n}\n\nif (document) {\n\tdocument.addEventListener(\"DOMContentLoaded\", () => {\n\t\tCanvas.loadAll();\n\t});\n}\n"]}