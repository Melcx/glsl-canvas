{"version":3,"sources":["src/glsl.ts","../../node_modules/promise-polyfill/src/index.js","../../node_modules/promise-polyfill/src/finally.js","../../src/logger/logger.ts","../../src/core/common.ts","../../src/context/context.ts","../../src/buffers/buffers.ts","../../src/core/iterable.ts","../../src/textures/textures.ts","../../src/core/subscriber.ts","../../src/uniforms/uniforms.ts","../../src/canvas/canvas-timer.ts","../../src/canvas/canvas.ts"],"names":["global","factory","exports","module","define","amd","self","glsl","this","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","_inheritsLoose","subClass","superClass","prototype","create","constructor","__proto__","_assertThisInitialized","ReferenceError","setTimeoutFunc","setTimeout","isArray","x","Boolean","noop","Promise","fn","TypeError","_state","_handled","_value","undefined","_deferreds","doResolve","handle","deferred","_immediateFn","cb","onFulfilled","onRejected","ret","e","reject","promise","resolve","push","newValue","then","finale","thisArg","apply","arguments","_unhandledRejectionFn","len","Handler","done","value","reason","ex","prom","callback","all","arr","args","Array","slice","call","remaining","res","val","race","setImmediate","err","console","warn","LoggerLevel","Common","fetch","url","xhr","XMLHttpRequest","onload","response","responseText","onerror","error","Error","ontimeout","onabort","open","send","Logger","log","_console","enabled","level","Log","_console2","Warn","_console3","ContextVersion","ContextError","ContextDefaultVertex","ContextDefaultFragment","ContextDefaultVertex2","ContextDefaultFragment2","ContextVertexBuffers","Context","getContext_","canvas","options","names","context","getContext","getContext2_","getIncludes","input","match","regex","promises","exec","index","chunks","join","isWebGl","WebGLRenderingContext","isWebGl2","window","WebGL2RenderingContext","inferVersion","vertexString","fragmentString","source","indexOf","WebGl2","WebGl","versionDiffers","gl","currentVersion","getVertex","getFragment","tryInferContext","attributes","extensions","errorCallback","handleError","errorCode","html","container","parentNode","innerHTML","BrowserSupport","inferContext","supportedExtensions","getSupportedExtensions","forEach","getExtension","Other","tryGetContext","createShader","type","offset","shader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","lastError","getShaderInfoLog","deleteShader","createProgram","shaders","locations","program","attachShader","bindAttribLocation","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","deleteProgram","createVertexBuffers","vertexBuffers","texcoordIndex","getAttribLocation","texcoord","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","Float32Array","STATIC_DRAW","enableVertexAttribArray","vertexAttribPointer","FLOAT","positionIndex","position","BufferFloatType","StringMap","IterableStringMap","values","_proto","has","hasOwnProperty","set","item","get","callbackfn","reduce","initialValue","previous","BuffersDefaultFragment2","Buffer","BW","BH","buffer","createFramebuffer","texture","getTexture","texParameteri","TEXTURE_2D","TEXTURE_MIN_FILTER","NEAREST","TEXTURE_MAG_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","getFloatType","floatType","extension","extensionName","HALF_FLOAT","HALF_FLOAT_OES","createTexture","activeTexture","TEXTURE0","bindTexture","texImage2D","RGBA16F","RGBA","checkFramebufferStatus","FRAMEBUFFER","FRAMEBUFFER_COMPLETE","resize","bindFramebuffer","pixels","status","minW","Math","min","minH","readPixels","newIndex","newTexture","texSubImage2D","newBuffer","deleteTexture","TextureSourceType","TextureFilteringType","IOBuffer","isValid","_proto2","vertexShader","VERTEX_SHADER","fragmentShader","FRAGMENT_SHADER","output","render","useProgram","viewport","framebufferTexture2D","COLOR_ATTACHMENT0","drawArrays","TRIANGLES","destroy","Buffers","_IterableStringMap","Constructor","protoProps","staticProps","getBuffers","buffers","count","replace","matches","regexp","bufferFragmentString","drawingBufferWidth","drawingBufferHeight","keys","Listener","event","Subscriber","listeners","Set","logListeners","subscribe","listener","add","unsubscribe","delete","unsubscribeAll","clear","on","off","_this","trigger","_len","data","TextureImageExtensions","TextureVideoExtensions","TextureExtensions","concat","isTextureData","object","UniformMethod","UniformType","Texture","_Subscriber","workpath","filtering","Linear","valid","dirty","animated","powerOf2","isPowerOf2","isSafari","test","navigator","userAgent","isTextureUrl","text","split","isTexture","urlElementOrData","getTextureOptions","getMaxTextureSize","getParameter","MAX_TEXTURE_SIZE","prev","curr","params","decodeURIComponent","Number","document","querySelector","HTMLCanvasElement","HTMLImageElement","HTMLVideoElement","element","width","height","setData","Uint8Array","load","setUrl","setElement","sourceType","Url","assign","src","String","ext","pop","toLowerCase","createElement","setAttribute","loop","muted","addEventListener","play","crossOrigin","_this2","originalElement","Element","video","update","setFiltering","message","JSON","stringify","Data","pixelStorei","UNPACK_FLIP_Y_WEBGL","UNPACK_PREMULTIPLY_ALPHA_WEBGL","naturalWidth","naturalHeight","UNSIGNED_BYTE","videoWidth","videoHeight","imageBuffer","tryUpdate","MipMap","wrapS","repeat","REPEAT","wrapT","LINEAR_MIPMAP_LINEAR","LINEAR","generateMipmap","Nearest","Textures","_this3","clean","createOrUpdate","_this4","textureOptions","flag","METHODS_INT","Uniform1i","Uniform2i","Uniform3i","Uniform4i","METHODS_FLOAT","Uniform1f","Uniform2f","Uniform3f","Uniform4f","METHODS_INTV","Uniform1iv","Uniform2iv","Uniform3iv","Uniform4iv","METHODS_FLOATV","Uniform1fv","Uniform2fv","Uniform3fv","Uniform4fv","Uniform","location","getUniformLocation","method","UniformTexture","_Uniform","Uniforms","isDifferent","a","b","f","v","isArrayOfInteger","array","isInteger","isArrayOfNumber","isArrayOfBoolean","isArrayOfTexture","isArrayOfSampler2D","Sampler2D","getType_","Unknown","subject","Float","Bool","getMethod_","isVector","Int","parseUniform","uniform","map","CanvasTimer","delay","current","delta","paused","start","now","performance","pause","next","Canvas","mouse","y","uniforms","textures","textureList","visible","rect","getBoundingClientRect","devicePixelRatio","style","backgroundColor","getShaders_","success","addListeners_","onLoop","items","version","of","find","loadAll","getElementsByClassName","filter","urls","hasAttribute","vertex","getAttribute","fragment","body","onScroll","bind","onClick","onMove","onMousemove","onMouseover","onMouseout","onTouchmove","onTouchend","onTouchstart","addCanvasListeners_","removeCanvasListeners_","removeEventListener","removeListeners_","cancelAnimationFrame","rafId","toggle","mx","my","left","top","clientX","pageX","clientY","pageY","touch","touches","p","time","checkRender","requestAnimationFrame","setUniform_","loadTexture","parseTextures_","createUniforms_","_this5","timer","hasDelta","hasTime","hasDate","hasMouse","hasTextures","classList","remove","date","Date","getFullYear","getMonth","getDate","getHours","getMinutes","getSeconds","getMilliseconds","setTexture","updateUniforms_","isVisible_","innerHeight","documentElement","clientHeight","isAnimated_","isDirty_","sizeDidChanged_","W","ceil","clientWidth","H","_this6","createContext_","destroyContext_","swapCanvas_","onError","_this7","query","createQueryEXT","wasValid","beginQueryEXT","TIME_ELAPSED_EXT","endQueryEXT","waitForTest","available","getQueryObjectEXT","QUERY_RESULT_AVAILABLE_EXT","disjoint","GPU_DISJOINT_EXT","result","timeElapsedMs","QUERY_RESULT_EXT","canvas_","cloneNode","replaceChild","splice","_this8","keyResolution","path","setUniform","setUniformOfInt","setUniforms","BuffersDefaultFragment"],"mappings":"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","file":"dist/umd/glsl-canvas.min.js","sourcesContent":[null,"import promiseFinally from './finally';\n\n// Store setTimeout reference so promise-polyfill will be unaffected by\n// other code modifying setTimeout (like sinon.useFakeTimers())\nvar setTimeoutFunc = setTimeout;\n\nfunction isArray(x) {\n  return Boolean(x && typeof x.length !== 'undefined');\n}\n\nfunction noop() {}\n\n// Polyfill for Function.prototype.bind\nfunction bind(fn, thisArg) {\n  return function() {\n    fn.apply(thisArg, arguments);\n  };\n}\n\n/**\n * @constructor\n * @param {Function} fn\n */\nfunction Promise(fn) {\n  if (!(this instanceof Promise))\n    throw new TypeError('Promises must be constructed via new');\n  if (typeof fn !== 'function') throw new TypeError('not a function');\n  /** @type {!number} */\n  this._state = 0;\n  /** @type {!boolean} */\n  this._handled = false;\n  /** @type {Promise|undefined} */\n  this._value = undefined;\n  /** @type {!Array<!Function>} */\n  this._deferreds = [];\n\n  doResolve(fn, this);\n}\n\nfunction handle(self, deferred) {\n  while (self._state === 3) {\n    self = self._value;\n  }\n  if (self._state === 0) {\n    self._deferreds.push(deferred);\n    return;\n  }\n  self._handled = true;\n  Promise._immediateFn(function() {\n    var cb = self._state === 1 ? deferred.onFulfilled : deferred.onRejected;\n    if (cb === null) {\n      (self._state === 1 ? resolve : reject)(deferred.promise, self._value);\n      return;\n    }\n    var ret;\n    try {\n      ret = cb(self._value);\n    } catch (e) {\n      reject(deferred.promise, e);\n      return;\n    }\n    resolve(deferred.promise, ret);\n  });\n}\n\nfunction resolve(self, newValue) {\n  try {\n    // Promise Resolution Procedure: https://github.com/promises-aplus/promises-spec#the-promise-resolution-procedure\n    if (newValue === self)\n      throw new TypeError('A promise cannot be resolved with itself.');\n    if (\n      newValue &&\n      (typeof newValue === 'object' || typeof newValue === 'function')\n    ) {\n      var then = newValue.then;\n      if (newValue instanceof Promise) {\n        self._state = 3;\n        self._value = newValue;\n        finale(self);\n        return;\n      } else if (typeof then === 'function') {\n        doResolve(bind(then, newValue), self);\n        return;\n      }\n    }\n    self._state = 1;\n    self._value = newValue;\n    finale(self);\n  } catch (e) {\n    reject(self, e);\n  }\n}\n\nfunction reject(self, newValue) {\n  self._state = 2;\n  self._value = newValue;\n  finale(self);\n}\n\nfunction finale(self) {\n  if (self._state === 2 && self._deferreds.length === 0) {\n    Promise._immediateFn(function() {\n      if (!self._handled) {\n        Promise._unhandledRejectionFn(self._value);\n      }\n    });\n  }\n\n  for (var i = 0, len = self._deferreds.length; i < len; i++) {\n    handle(self, self._deferreds[i]);\n  }\n  self._deferreds = null;\n}\n\n/**\n * @constructor\n */\nfunction Handler(onFulfilled, onRejected, promise) {\n  this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;\n  this.onRejected = typeof onRejected === 'function' ? onRejected : null;\n  this.promise = promise;\n}\n\n/**\n * Take a potentially misbehaving resolver function and make sure\n * onFulfilled and onRejected are only called once.\n *\n * Makes no guarantees about asynchrony.\n */\nfunction doResolve(fn, self) {\n  var done = false;\n  try {\n    fn(\n      function(value) {\n        if (done) return;\n        done = true;\n        resolve(self, value);\n      },\n      function(reason) {\n        if (done) return;\n        done = true;\n        reject(self, reason);\n      }\n    );\n  } catch (ex) {\n    if (done) return;\n    done = true;\n    reject(self, ex);\n  }\n}\n\nPromise.prototype['catch'] = function(onRejected) {\n  return this.then(null, onRejected);\n};\n\nPromise.prototype.then = function(onFulfilled, onRejected) {\n  // @ts-ignore\n  var prom = new this.constructor(noop);\n\n  handle(this, new Handler(onFulfilled, onRejected, prom));\n  return prom;\n};\n\nPromise.prototype['finally'] = promiseFinally;\n\nPromise.all = function(arr) {\n  return new Promise(function(resolve, reject) {\n    if (!isArray(arr)) {\n      return reject(new TypeError('Promise.all accepts an array'));\n    }\n\n    var args = Array.prototype.slice.call(arr);\n    if (args.length === 0) return resolve([]);\n    var remaining = args.length;\n\n    function res(i, val) {\n      try {\n        if (val && (typeof val === 'object' || typeof val === 'function')) {\n          var then = val.then;\n          if (typeof then === 'function') {\n            then.call(\n              val,\n              function(val) {\n                res(i, val);\n              },\n              reject\n            );\n            return;\n          }\n        }\n        args[i] = val;\n        if (--remaining === 0) {\n          resolve(args);\n        }\n      } catch (ex) {\n        reject(ex);\n      }\n    }\n\n    for (var i = 0; i < args.length; i++) {\n      res(i, args[i]);\n    }\n  });\n};\n\nPromise.resolve = function(value) {\n  if (value && typeof value === 'object' && value.constructor === Promise) {\n    return value;\n  }\n\n  return new Promise(function(resolve) {\n    resolve(value);\n  });\n};\n\nPromise.reject = function(value) {\n  return new Promise(function(resolve, reject) {\n    reject(value);\n  });\n};\n\nPromise.race = function(arr) {\n  return new Promise(function(resolve, reject) {\n    if (!isArray(arr)) {\n      return reject(new TypeError('Promise.race accepts an array'));\n    }\n\n    for (var i = 0, len = arr.length; i < len; i++) {\n      Promise.resolve(arr[i]).then(resolve, reject);\n    }\n  });\n};\n\n// Use polyfill for setImmediate for performance gains\nPromise._immediateFn =\n  // @ts-ignore\n  (typeof setImmediate === 'function' &&\n    function(fn) {\n      // @ts-ignore\n      setImmediate(fn);\n    }) ||\n  function(fn) {\n    setTimeoutFunc(fn, 0);\n  };\n\nPromise._unhandledRejectionFn = function _unhandledRejectionFn(err) {\n  if (typeof console !== 'undefined' && console) {\n    console.warn('Possible Unhandled Promise Rejection:', err); // eslint-disable-line no-console\n  }\n};\n\nexport default Promise;\n","/**\n * @this {Promise}\n */\nfunction finallyConstructor(callback) {\n  var constructor = this.constructor;\n  return this.then(\n    function(value) {\n      // @ts-ignore\n      return constructor.resolve(callback()).then(function() {\n        return value;\n      });\n    },\n    function(reason) {\n      // @ts-ignore\n      return constructor.resolve(callback()).then(function() {\n        // @ts-ignore\n        return constructor.reject(reason);\n      });\n    }\n  );\n}\n\nexport default finallyConstructor;\n","export enum LoggerLevel {\n\tNone = 0,\n\tError = 1,\n\tWarn = 2,\n\tLog = 3,\n}\n\nexport default class Logger {\n\n\tstatic level: LoggerLevel = LoggerLevel.Warn;\n\n\tstatic enabled: boolean = true;\n\n\tstatic log(...datas: any[]) {\n\t\tif (Logger.enabled && Logger.level >= LoggerLevel.Log) {\n\t\t\tconsole.log(...datas);\n\t\t}\n\t}\n\n\tstatic warn(...datas: any[]) {\n\t\tif (Logger.enabled && Logger.level >= LoggerLevel.Warn) {\n\t\t\tconsole.warn(...datas);\n\t\t}\n\t}\n\n\tstatic error(...datas: any[]) {\n\t\tif (Logger.enabled && Logger.level >= LoggerLevel.Error) {\n\t\t\tconsole.error(...datas);\n\t\t}\n\t}\n\n}\n","import 'promise-polyfill';\n\nexport default class Common {\n\tstatic fetch(url: string): Promise<string> {\n\t\t// console.log('fetch', url);\n\t\treturn new Promise(function (resolve, reject) {\n\t\t\tconst xhr: XMLHttpRequest = new XMLHttpRequest();\n\t\t\txhr.onload = function () {\n\t\t\t\tresolve(xhr.response || xhr.responseText);\n\t\t\t};\n\t\t\txhr.onerror = function (error) {\n\t\t\t\t// console.log(error);\n\t\t\t\treject(new Error(`Network request failed for url ${url}`));\n\t\t\t};\n\t\t\txhr.ontimeout = function (error) {\n\t\t\t\t// console.log(error);\n\t\t\t\treject(new Error(`Network request failed for url ${url}`));\n\t\t\t};\n\t\t\txhr.onabort = function () {\n\t\t\t\treject(new Error('Aborted'));\n\t\t\t};\n\t\t\txhr.open('GET', url, true);\n\t\t\txhr.send(null);\n\t\t})\n\t}\n}\n","import Common from '../core/common';\nimport Logger from '../logger/logger';\n\nexport const ContextDefaultVertex = `\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nvarying vec2 v_texcoord;\n\nvoid main(){\n\tgl_Position = vec4(a_position, 0.0, 1.0);\n\tv_texcoord = a_texcoord;\n}\n`;\n\nexport const ContextDefaultFragment = `\n#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvoid main(){\n\tgl_FragColor = vec4(0.0);\n}\n`;\n\nexport const ContextDefaultVertex2 = `#version 300 es\n\nin vec2 a_position;\nin vec2 a_texcoord;\n\nout vec2 v_texcoord;\n\nvoid main() {\n\tgl_Position = vec4(a_position, 0.0, 1.0);\n\tv_texcoord = a_texcoord;\n}\n`;\n\nexport const ContextDefaultFragment2 = `#version 300 es\n\nprecision mediump float;\n\nout vec4 outColor;\n\nvoid main() {\n\toutColor = vec4(0.0);\n}\n`;\n\nexport enum ContextVersion {\n\tWebGl = 1,\n\tWebGl2 = 2,\n}\n\nexport enum ContextError {\n\tBrowserSupport = 1,\n\tOther = 2,\n}\n\nexport interface IContextOptions {\n\talpha?: GLboolean;\n\tantialias?: GLboolean;\n\tdepth?: GLboolean;\n\tfailIfMajorPerformanceCaveat?: boolean;\n\t// powerPreference?: WebGLPowerPreference;\n\tpremultipliedAlpha?: GLboolean;\n\tpreserveDrawingBuffer?: GLboolean;\n\tstencil?: GLboolean;\n}\n\nexport class ContextVertexBuffers {\n\ttexcoord: WebGLBuffer;\n\tposition: WebGLBuffer;\n}\n\nexport default class Context {\n\n\tstatic lastError: string = '';\n\n\tstatic getContext_(canvas: HTMLCanvasElement, options?: WebGLContextAttributes): WebGLRenderingContext {\n\t\tconst names = ['webgl', 'experimental-webgl'];\n\t\tlet context = null;\n\t\tfor (let i = 0; i < names.length; ++i) {\n\t\t\ttry {\n\t\t\t\tcontext = canvas.getContext(names[i], options) as WebGLRenderingContext;\n\t\t\t} catch (e) {\n\t\t\t\tif (context) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn context;\n\t}\n\n\tstatic getContext2_(canvas: HTMLCanvasElement, options?: WebGLContextAttributes): WebGL2RenderingContext {\n\t\tlet context = null;\n\t\ttry {\n\t\t\tcontext = canvas.getContext('webgl2', options) as WebGL2RenderingContext;\n\t\t} catch (e) {\n\t\t\t// console.error('GlslCanvas.Context.getContext2_.error', e);\n\t\t}\n\t\treturn context;\n\t}\n\n\tstatic getIncludes(input: string | undefined): Promise<string | undefined> {\n\t\tif (input === undefined) {\n\t\t\treturn Promise.resolve(input);\n\t\t}\n\t\tconst regex = /#include\\s*['|\"](.*.glsl)['|\"]/gm;\n\t\tconst promises = [];\n\t\tlet i = 0;\n\t\tlet match;\n\t\twhile ((match = regex.exec(input)) !== null) {\n\t\t\tpromises.push(Promise.resolve(input.slice(i, match.index)));\n\t\t\ti = match.index + match[0].length;\n\t\t\tpromises.push(Common.fetch(match[1]));\n\t\t}\n\t\tpromises.push(Promise.resolve(input.slice(i)));\n\t\treturn Promise.all(promises).then(chunks => {\n\t\t\treturn chunks.join('');\n\t\t});\n\t}\n\n\tstatic isWebGl(context: WebGLRenderingContext | WebGL2RenderingContext): boolean {\n\t\treturn context instanceof WebGLRenderingContext;\n\t}\n\n\tstatic isWebGl2(context: WebGLRenderingContext | WebGL2RenderingContext): boolean {\n\t\t// console.log(context);\n\t\t// return context !== undefined && typeof (context as any).bindBufferRange === 'function';\n\t\treturn (window as any).WebGL2RenderingContext && context instanceof WebGL2RenderingContext;\n\t}\n\n\tstatic inferVersion(vertexString?: string, fragmentString?: string): ContextVersion {\n\t\tconst source: string = vertexString || fragmentString;\n\t\tif (source) {\n\t\t\treturn source.indexOf('#version 300 es') === 0 ? ContextVersion.WebGl2 : ContextVersion.WebGl;\n\t\t} else {\n\t\t\treturn ContextVersion.WebGl;\n\t\t}\n\t}\n\n\tstatic versionDiffers(gl: WebGLRenderingContext | WebGL2RenderingContext, vertexString?: string, fragmentString?: string): boolean {\n\t\tif (gl) {\n\t\t\tconst currentVersion = this.isWebGl2(gl) ? ContextVersion.WebGl2 : ContextVersion.WebGl;\n\t\t\tconst newVersion = Context.inferVersion(vertexString, fragmentString);\n\t\t\treturn newVersion !== currentVersion;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tstatic getVertex(vertexString?: string, fragmentString?: string): string {\n\t\tif (vertexString) {\n\t\t\treturn vertexString;\n\t\t} else {\n\t\t\tconst version: ContextVersion = this.inferVersion(vertexString, fragmentString);\n\t\t\treturn version === ContextVersion.WebGl2 ? ContextDefaultVertex2 : ContextDefaultVertex;\n\t\t}\n\t}\n\n\tstatic getFragment(vertexString?: string, fragmentString?: string): string {\n\t\tif (fragmentString) {\n\t\t\treturn fragmentString;\n\t\t} else {\n\t\t\tconst version: ContextVersion = this.inferVersion(vertexString, fragmentString);\n\t\t\treturn version === ContextVersion.WebGl2 ? ContextDefaultFragment2 : ContextDefaultFragment;\n\t\t}\n\t}\n\n\tstatic tryInferContext(vertexString: string, fragmentString: string, canvas: HTMLCanvasElement, attributes: WebGLContextAttributes, extensions: string[] = [], errorCallback: Function): WebGLRenderingContext | WebGL2RenderingContext {\n\t\tfunction handleError(errorCode: number, html: string) {\n\t\t\tif (typeof errorCallback === 'function') {\n\t\t\t\terrorCallback(errorCode);\n\t\t\t} else {\n\t\t\t\tconst container = canvas.parentNode;\n\t\t\t\tif (container) {\n\t\t\t\t\t(container as HTMLElement).innerHTML = `<div class=\"glsl-canvas--error\">${html}</div>`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!WebGLRenderingContext) {\n\t\t\thandleError(ContextError.BrowserSupport, `This page requires a browser that supports WebGL.<br/>\n\t\t\t<a href=\"http://get.webgl.org\">Click here to upgrade your browser.</a>`);\n\t\t\treturn null;\n\t\t}\n\t\tconst context: WebGLRenderingContext | WebGL2RenderingContext = Context.inferContext(vertexString, fragmentString, canvas, attributes);\n\t\tif (!context) {\n\t\t\thandleError(ContextError.Other, `It does not appear your computer can support WebGL.<br/>\n\t\t\t<a href=\"http://get.webgl.org/troubleshooting/\">Click here for more information.</a>`);\n\t\t} else {\n\t\t\tif (!(this.isWebGl2(context)) && extensions.indexOf('OES_standard_derivatives') === -1) {\n\t\t\t\textensions.push('OES_standard_derivatives');\n\t\t\t}\n\t\t\tconst supportedExtensions = context.getSupportedExtensions();\n\t\t\textensions.forEach(key => {\n\t\t\t\tif (supportedExtensions.indexOf(key) !== -1) {\n\t\t\t\t\tcontext.getExtension(key);\n\t\t\t\t} else {\n\t\t\t\t\tLogger.warn(`GlslCanvas ${key} not supported`);\n\t\t\t\t}\n\t\t\t});\n\t\t\t// context.getExtension('OES_standard_derivatives');\n\t\t}\n\t\treturn context;\n\t}\n\n\tstatic tryGetContext(canvas: HTMLCanvasElement, attributes: WebGLContextAttributes, errorCallback: Function): WebGLRenderingContext {\n\t\tfunction handleError(errorCode: number, html: string) {\n\t\t\tif (typeof errorCallback === 'function') {\n\t\t\t\terrorCallback(errorCode);\n\t\t\t} else {\n\t\t\t\tconst container = canvas.parentNode;\n\t\t\t\tif (container) {\n\t\t\t\t\t(container as HTMLElement).innerHTML = `<div class=\"glsl-canvas--error\">${html}</div>`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!WebGLRenderingContext) {\n\t\t\thandleError(ContextError.BrowserSupport, `This page requires a browser that supports WebGL.<br/>\n\t\t\t<a href=\"http://get.webgl.org\">Click here to upgrade your browser.</a>`);\n\t\t\treturn null;\n\t\t}\n\t\tconst context: WebGLRenderingContext = Context.getContext_(canvas, attributes);\n\t\tif (!context) {\n\t\t\thandleError(ContextError.Other, `It does not appear your computer can support WebGL.<br/>\n\t\t\t<a href=\"http://get.webgl.org/troubleshooting/\">Click here for more information.</a>`);\n\t\t} else {\n\t\t\tcontext.getExtension('OES_standard_derivatives');\n\t\t}\n\t\treturn context;\n\t}\n\n\tstatic inferContext(vertexString: string, fragmentString: string, canvas: HTMLCanvasElement, options?: WebGLContextAttributes): WebGLRenderingContext | WebGL2RenderingContext {\n\t\tconst version: ContextVersion = this.inferVersion(vertexString, fragmentString);\n\t\treturn version === ContextVersion.WebGl2 ? this.getContext2_(canvas, options) : this.getContext_(canvas, options);\n\t}\n\n\tstatic createShader(gl: WebGLRenderingContext | WebGL2RenderingContext, source: string, type: number, offset: number = 0): WebGLShader {\n\t\tconst shader = gl.createShader(type);\n\t\tgl.shaderSource(shader, source);\n\t\tgl.compileShader(shader);\n\t\tconst compiled = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\n\t\tif (!compiled) {\n\t\t\t// Something went wrong during compilation; get the error\n\t\t\tContext.lastError = gl.getShaderInfoLog(shader);\n\t\t\t// console.log('lastError', Context.lastError);\n\t\t\tLogger.error(`*** Error compiling shader ${shader}: ${Context.lastError}`);\n\t\t\t// main.trigger('error', {\n\t\t\tgl.deleteShader(shader);\n\t\t\tthrow ({\n\t\t\t\tshader: shader,\n\t\t\t\tsource: source,\n\t\t\t\ttype: type,\n\t\t\t\terror: Context.lastError,\n\t\t\t\toffset: offset\n\t\t\t});\n\t\t}\n\t\treturn shader;\n\t}\n\n\tstatic createProgram(gl: WebGLRenderingContext | WebGL2RenderingContext, shaders: WebGLShader[], attributes?: any[], locations?: number[]): WebGLProgram {\n\t\tconst program = gl.createProgram();\n\t\tfor (let i = 0; i < shaders.length; ++i) {\n\t\t\tgl.attachShader(program, shaders[i]);\n\t\t}\n\t\tif (attributes && locations) {\n\t\t\tfor (let i = 0; i < attributes.length; ++i) {\n\t\t\t\tgl.bindAttribLocation(program, locations ? locations[i] : i, attributes[i]);\n\t\t\t}\n\t\t}\n\t\tgl.linkProgram(program);\n\t\t// Check the link status\n\t\tconst linked = gl.getProgramParameter(program, gl.LINK_STATUS);\n\t\tif (!linked) {\n\t\t\t// something went wrong with the link\n\t\t\tContext.lastError = gl.getProgramInfoLog(program);\n\t\t\tLogger.log(`Error in program linking: ${Context.lastError}`);\n\t\t\tgl.deleteProgram(program);\n\t\t\treturn null;\n\t\t}\n\t\treturn program;\n\t}\n\n\tstatic createVertexBuffers(gl: WebGLRenderingContext | WebGL2RenderingContext, program: WebGLProgram): ContextVertexBuffers {\n\t\tconst vertexBuffers: ContextVertexBuffers = new ContextVertexBuffers();\n\t\tconst texcoordIndex: number = gl.getAttribLocation(program, 'a_texcoord');\n\t\tvertexBuffers.texcoord = gl.createBuffer();\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffers.texcoord);\n\t\tgl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0.0, 0.0, 1.0, 0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 0.0, 1.0, 1.0]), gl.STATIC_DRAW);\n\t\tgl.enableVertexAttribArray(texcoordIndex);\n\t\tgl.vertexAttribPointer(texcoordIndex, 2, gl.FLOAT, false, 0, 0);\n\t\tconst positionIndex: number = gl.getAttribLocation(program, 'a_position');\n\t\tvertexBuffers.position = gl.createBuffer();\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffers.position);\n\t\tgl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1.0, -1.0, 1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 1.0, -1.0, 1.0, 1.0]), gl.STATIC_DRAW);\n\t\tgl.enableVertexAttribArray(positionIndex);\n\t\tgl.vertexAttribPointer(positionIndex, 2, gl.FLOAT, false, 0, 0);\n\t\treturn vertexBuffers;\n\t}\n\n}\n","import Context from '../context/context';\nimport IterableStringMap from '../core/iterable';\n\nexport const BuffersDefaultFragment = `\nvoid main(){\n\tgl_FragColor = vec4(1.0);\n}`;\n\nexport const BuffersDefaultFragment2 = `#version 300 es\n\nprecision mediump float;\n\nout vec4 outColor;\n\nvoid main() {\n\toutColor = vec4(1.0);\n}\n`;\n\nexport enum BufferFloatType {\n\tFLOAT = 0,\n\tHALF_FLOAT,\n}\n\nexport class Buffer {\n\n\tstatic floatType: BufferFloatType = BufferFloatType.HALF_FLOAT;\n\ttexture: WebGLTexture;\n\tbuffer: WebGLFramebuffer;\n\tBW: number;\n\tBH: number;\n\tindex: number;\n\n\tconstructor(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number, index: number) {\n\t\tconst buffer = gl.createFramebuffer();\n\t\tconst texture = this.getTexture(gl, BW, BH, index);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\t\tthis.texture = texture;\n\t\tthis.buffer = buffer;\n\t\tthis.BW = BW;\n\t\tthis.BH = BH;\n\t\tthis.index = index;\n\t}\n\n\tgetFloatType(gl: WebGLRenderingContext | WebGL2RenderingContext): number {\n\t\tlet floatType: number, extension;\n\t\tif (Buffer.floatType === BufferFloatType.FLOAT) {\n\t\t\tconst extensionName = Context.isWebGl2(gl) ? 'EXT_color_buffer_float' : 'OES_texture_float';\n\t\t\textension = gl.getExtension(extensionName);\n\t\t\tif (extension) {\n\t\t\t\tfloatType = gl.FLOAT;\n\t\t\t} else {\n\t\t\t\tBuffer.floatType = BufferFloatType.HALF_FLOAT;\n\t\t\t\treturn this.getFloatType(gl);\n\t\t\t}\n\t\t} else {\n\t\t\tconst extensionName = Context.isWebGl2(gl) ? 'EXT_color_buffer_half_float' : 'OES_texture_half_float';\n\t\t\textension = gl.getExtension(extensionName);\n\t\t\tif (extension) {\n\t\t\t\tfloatType = extension.HALF_FLOAT_OES;\n\t\t\t} else {\n\t\t\t\tBuffer.floatType = BufferFloatType.FLOAT;\n\t\t\t\treturn this.getFloatType(gl);\n\t\t\t}\n\t\t}\n\t\treturn floatType;\n\t}\n\n\tgetTexture(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number, index: number): WebGLTexture {\n\t\tconst floatType = this.getFloatType(gl);\n\t\tconst texture = gl.createTexture();\n\t\tgl.activeTexture(gl.TEXTURE0 + index);\n\t\tgl.bindTexture(gl.TEXTURE_2D, texture);\n\t\tgl.texImage2D(gl.TEXTURE_2D, 0, (Context.isWebGl2(gl) ? (gl as WebGL2RenderingContext).RGBA16F : gl.RGBA), BW, BH, 0, gl.RGBA, floatType, null);\n\t\tconst status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n\t\tif (status !== gl.FRAMEBUFFER_COMPLETE) {\n\t\t\tif (Buffer.floatType === BufferFloatType.FLOAT) {\n\t\t\t\tBuffer.floatType = BufferFloatType.HALF_FLOAT;\n\t\t\t} else {\n\t\t\t\tBuffer.floatType = BufferFloatType.FLOAT;\n\t\t\t}\n\t\t\treturn this.getTexture(gl, BW, BH, index);\n\t\t}\n\t\treturn texture;\n\t}\n\n\tresize(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number) {\n\t\tif (BW !== this.BW || BH !== this.BH) {\n\t\t\tconst buffer = this.buffer;\n\t\t\tconst texture = this.texture;\n\t\t\tconst index = this.index;\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, buffer);\n\t\t\tconst status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n\t\t\tconst minW = Math.min(BW, this.BW);\n\t\t\tconst minH = Math.min(BH, this.BH);\n\t\t\tlet pixels: Float32Array;\n\t\t\tlet floatType = this.getFloatType(gl);\n\t\t\tif (status === gl.FRAMEBUFFER_COMPLETE) {\n\t\t\t\tpixels = new Float32Array(minW * minH * 4);\n\t\t\t\tgl.readPixels(0, 0, minW, minH, gl.RGBA, floatType, pixels);\n\t\t\t}\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\t\t\tconst newIndex = index + 1; // temporary index\n\t\t\tconst newTexture = this.getTexture(gl, BW, BH, newIndex);\n\t\t\tfloatType = this.getFloatType(gl);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\t\t\tif (pixels) {\n\t\t\t\tgl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, minW, minH, gl.RGBA, floatType, pixels);\n\t\t\t}\n\t\t\tconst newBuffer = gl.createFramebuffer();\n\t\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\t\t\tgl.deleteTexture(texture);\n\t\t\tgl.activeTexture(gl.TEXTURE0 + index);\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, newTexture);\n\t\t\tthis.index = index;\n\t\t\tthis.texture = newTexture;\n\t\t\tthis.buffer = newBuffer;\n\t\t\tthis.BW = BW;\n\t\t\tthis.BH = BH;\n\t\t}\n\t}\n\n}\n\nexport class IOBuffer {\n\n\tprogram: WebGLProgram;\n\tinput: Buffer;\n\toutput: Buffer;\n\tindex: number;\n\tkey: string;\n\tvertexString: string;\n\tfragmentString: string;\n\tBW: number;\n\tBH: number;\n\tisValid: boolean = false;\n\n\tconstructor(index: number, key: string, vertexString: string, fragmentString: string) {\n\t\tthis.index = index;\n\t\tthis.key = key;\n\t\tthis.vertexString = vertexString;\n\t\tthis.fragmentString = fragmentString;\n\t}\n\n\tcreate(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number) {\n\t\t// console.log('create', this.vertexString, this.fragmentString);\n\t\tconst vertexShader = Context.createShader(gl, this.vertexString, gl.VERTEX_SHADER);\n\t\tlet fragmentShader = Context.createShader(gl, this.fragmentString, gl.FRAGMENT_SHADER, 1);\n\t\tif (!fragmentShader) {\n\t\t\tfragmentShader = Context.createShader(gl, Context.isWebGl2(gl) ?\n\t\t\t\tBuffersDefaultFragment2 : BuffersDefaultFragment, gl.FRAGMENT_SHADER);\n\t\t\tthis.isValid = false;\n\t\t} else {\n\t\t\tthis.isValid = true;\n\t\t}\n\t\tconst program = Context.createProgram(gl, [vertexShader, fragmentShader]);\n\t\tgl.linkProgram(program);\n\t\tconst input = new Buffer(gl, BW, BH, this.index + 0);\n\t\tconst output = new Buffer(gl, BW, BH, this.index + 2);\n\t\tthis.program = program;\n\t\tthis.input = input;\n\t\tthis.output = output;\n\t\tgl.deleteShader(vertexShader);\n\t\tgl.deleteShader(fragmentShader);\n\t}\n\n\trender(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number) {\n\t\tgl.useProgram(this.program);\n\t\tgl.viewport(0, 0, BW, BH);\n\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, this.output.buffer);\n\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, this.output.texture, 0);\n\t\tgl.drawArrays(gl.TRIANGLES, 0, 6);\n\t\t// swap\n\t\tconst input = this.input;\n\t\tconst output = this.output;\n\t\tthis.input = output;\n\t\tthis.output = input;\n\t}\n\n\tresize(gl: WebGLRenderingContext | WebGL2RenderingContext, BW: number, BH: number) {\n\t\tgl.useProgram(this.program);\n\t\tgl.viewport(0, 0, BW, BH);\n\t\tthis.input.resize(gl, BW, BH);\n\t\tthis.output.resize(gl, BW, BH);\n\t}\n\n\tdestroy(gl: WebGLRenderingContext | WebGL2RenderingContext) {\n\t\tgl.deleteProgram(this.program);\n\t\tthis.program = null;\n\t\tthis.input = null;\n\t\tthis.output = null;\n\t}\n\n}\n\nexport default class Buffers extends IterableStringMap<IOBuffer> {\n\n\tget count(): number {\n\t\treturn Object.keys(this.values).length * 4;\n\t}\n\n\tstatic getBuffers(gl: WebGLRenderingContext | WebGL2RenderingContext, fragmentString: string, vertexString: string): Buffers {\n\t\tconst buffers: Buffers = new Buffers();\n\t\tlet count = 0;\n\t\tif (fragmentString) {\n\t\t\tif (Context.isWebGl2(gl)) {\n\t\t\t\tfragmentString = fragmentString.replace(/^\\#version\\s*300\\s*es\\s*\\n/, '');\n\t\t\t}\n\t\t\tconst regexp = /(?:^\\s*)((?:#if|#elif)(?:\\s*)(defined\\s*\\(\\s*BUFFER_)(\\d+)(?:\\s*\\))|(?:#ifdef)(?:\\s*BUFFER_)(\\d+)(?:\\s*))/gm;\n\t\t\tlet matches;\n\t\t\twhile ((matches = regexp.exec(fragmentString)) !== null) {\n\t\t\t\tconst i = matches[3] || matches[4];\n\t\t\t\tconst key = 'u_buffer' + i;\n\t\t\t\tconst bufferFragmentString = Context.isWebGl2(gl) ? `#version 300 es\n#define BUFFER_${i}\n${fragmentString}` : `#define BUFFER_${i}\n${fragmentString}`;\n\t\t\t\tconst buffer = new IOBuffer(count, key, vertexString, bufferFragmentString);\n\t\t\t\tbuffer.create(gl, gl.drawingBufferWidth, gl.drawingBufferHeight);\n\t\t\t\tbuffers.set(key, buffer);\n\t\t\t\tcount += 4;\n\t\t\t}\n\t\t}\n\t\treturn buffers;\n\t}\n\n}\n","export class NumberMap<T> { [key: number]: T; };\nexport class StringMap<T> { [key: string]: T; };\n\nexport default class IterableStringMap<T> {\n\n\tvalues: StringMap<T> = new StringMap<T>();\n\n\thas(key: string) {\n\t\treturn this.values.hasOwnProperty(key);\n\t}\n\n\tset(key: string, item: T) {\n\t\tthis.values[key] = item;\n\t}\n\n\tget(key: string): T {\n\t\treturn this.values[key];\n\t}\n\n\tforEach(callbackfn: Function) {\n\t\tlet i = 0;\n\t\tfor (const key in this.values) {\n\t\t\tcallbackfn(this.values[key], i, this.values);\n\t\t\ti++;\n\t\t}\n\t}\n\n\treduce(callbackfn: Function, initialValue?: any) {\n\t\tlet previous = initialValue, i = 0;\n\t\tfor (const key in this.values) {\n\t\t\tprevious = callbackfn(previous, this.values[key], i, this.values);\n\t\t\ti++;\n\t\t}\n\t\treturn previous;\n\t}\n\n}\n","// import 'promise-polyfill';\nimport IterableStringMap from '../core/iterable';\nimport Subscriber from '../core/subscriber';\nimport Logger from '../logger/logger';\n\nexport const TextureImageExtensions = ['jpg', 'jpeg', 'png'];\nexport const TextureVideoExtensions = ['ogv', 'webm', 'mp4'];\nexport const TextureExtensions = TextureImageExtensions.concat(TextureVideoExtensions);\n\nexport enum TextureSourceType {\n\tData = 0,\n\tElement = 1,\n\tUrl = 2,\n}\n\nexport enum TextureFilteringType {\n\tMipMap = 'mipmap',\n\tLinear = 'linear',\n\tNearest = 'nearest',\n}\n\nexport interface ITextureData {\n\tdata: Uint8Array;\n\twidth: number;\n\theight: number;\n}\n\nexport interface ITextureOptions {\n\turl?: string;\n\telement?: HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | HTMLElement | Element;\n\tdata?: Uint8Array;\n\twidth?: number;\n\theight?: number;\n\tfiltering?: TextureFilteringType;\n\trepeat?: boolean;\n\tUNPACK_FLIP_Y_WEBGL?: boolean;\n\tUNPACK_PREMULTIPLY_ALPHA_WEBGL?: number;\n\tTEXTURE_WRAP_S?: number; // gl.REPEAT | gl.CLAMP_TO_EDGE | gl.MIRRORED_REPEAT;\n\tTEXTURE_WRAP_T?: number; // gl.REPEAT | gl.CLAMP_TO_EDGE | gl.MIRRORED_REPEAT;\n}\n\nexport interface ITextureInput {\n\tkey: string;\n\turl: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData;\n\toptions?: ITextureOptions;\n}\n\nexport function isTextureData(object: any): object is ITextureData {\n\treturn 'data' in object && 'width' in object && 'height' in object;\n}\n\n// GL texture wrapper object for keeping track of a global set of textures, keyed by a unique user-defined name\nexport class Texture extends Subscriber {\n\n\tkey: string;\n\tindex: number;\n\toptions: ITextureOptions;\n\tworkpath: string;\n\twidth: number;\n\theight: number;\n\n\ttexture: WebGLTexture;\n\tsource: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | Uint8Array;\n\tsourceType: TextureSourceType;\n\tfiltering: TextureFilteringType;\n\turl: string;\n\tvalid: boolean = false;\n\tdirty: boolean = false;\n\tanimated: boolean = false;\n\tpowerOf2: boolean = false;\n\n\tconstructor(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\tkey: string,\n\t\tindex: number,\n\t\toptions: ITextureOptions = { filtering: TextureFilteringType.Linear },\n\t\tworkpath?: string,\n\t) {\n\t\tsuper();\n\t\tthis.key = key;\n\t\tthis.index = index;\n\t\tthis.options = options;\n\t\tthis.workpath = workpath;\n\t\tthis.create(gl);\n\t}\n\n\tstatic isPowerOf2(value: number): boolean {\n\t\treturn (value & (value - 1)) === 0;\n\t}\n\n\tstatic isSafari(): boolean {\n\t\treturn /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n\t}\n\n\tstatic isTextureUrl(text: string): boolean {\n\t\treturn text && (/\\.(jpg|jpeg|png|ogv|webm|mp4)$/i).test(text.split('?')[0]);\n\t}\n\n\tstatic isTexture(\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t): boolean {\n\t\tconst options = Texture.getTextureOptions(urlElementOrData);\n\t\treturn options !== undefined;\n\t}\n\n\tstatic getMaxTextureSize(gl: WebGLRenderingContext | WebGL2RenderingContext): number {\n\t\treturn gl.getParameter(gl.MAX_TEXTURE_SIZE);\n\t};\n\n\tstatic getTextureOptions(\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t\toptions: ITextureOptions = {}\n\t): ITextureOptions {\n\t\tif (typeof urlElementOrData === 'string' && urlElementOrData !== '') {\n\t\t\tif (Texture.isTextureUrl(urlElementOrData)) {\n\t\t\t\toptions.url = urlElementOrData;\n\t\t\t\tif (urlElementOrData.indexOf('?') !== -1) {\n\t\t\t\t\toptions = urlElementOrData.split('?')[1].split('&').reduce(function (prev: ITextureOptions, curr) {\n\t\t\t\t\t\tconst params = curr.split('=');\n\t\t\t\t\t\tconst key = decodeURIComponent(params[0]);\n\t\t\t\t\t\tconst value = decodeURIComponent(params[1]);\n\t\t\t\t\t\tswitch (key) {\n\t\t\t\t\t\t\tcase 'filtering':\n\t\t\t\t\t\t\t\tprev[key] = value as TextureFilteringType;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'repeat':\n\t\t\t\t\t\t\tcase 'UNPACK_FLIP_Y_WEBGL':\n\t\t\t\t\t\t\t\tprev[key] = Boolean(value);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'UNPACK_PREMULTIPLY_ALPHA_WEBGL':\n\t\t\t\t\t\t\tcase 'TEXTURE_WRAP_S':\n\t\t\t\t\t\t\tcase 'TEXTURE_WRAP_T':\n\t\t\t\t\t\t\t\tprev[key] = Number(value);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn prev;\n\t\t\t\t\t}, options);\n\t\t\t\t}\n\t\t\t\treturn options;\n\t\t\t}\n\t\t\tif (document) {\n\t\t\t\turlElementOrData = document.querySelector(urlElementOrData);\n\t\t\t\t// Logger.log(urlElementOrData);\n\t\t\t}\n\t\t}\n\t\tif (urlElementOrData instanceof HTMLCanvasElement || urlElementOrData instanceof HTMLImageElement || urlElementOrData instanceof HTMLVideoElement) {\n\t\t\toptions.element = urlElementOrData;\n\t\t\treturn options;\n\t\t} else if (isTextureData(urlElementOrData)) {\n\t\t\toptions.data = urlElementOrData.data;\n\t\t\toptions.width = urlElementOrData.width;\n\t\t\toptions.height = urlElementOrData.height;\n\t\t\treturn options;\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tcreate(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext\n\t): void {\n\t\tthis.texture = gl.createTexture();\n\t\tif (this.texture) {\n\t\t\tthis.valid = true;\n\t\t}\n\t\t// Default to a 1-pixel black texture so we can safely render while we wait for an image to load\n\t\t// See: http://stackoverflow.com/questions/19722247/webgl-wait-for-texture-to-load\n\t\t// [255, 255, 255, 255]\n\t\tthis.setData(gl, 1, 1, new Uint8Array([0, 0, 0, 0]), this.options);\n\t\t// this.bindTexture();\n\t\t// this.load(options);\n\t}\n\n\tload(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\toptions: ITextureOptions = {}\n\t): Promise<Texture> {\n\t\tthis.options = options;\n\t\tif (typeof options.url === 'string') {\n\t\t\tif (this.url === undefined || options.url !== this.url) {\n\t\t\t\treturn this.setUrl(gl, options.url, options);\n\t\t\t} else {\n\t\t\t\treturn Promise.resolve(this);\n\t\t\t}\n\t\t} else if (options.element) {\n\t\t\treturn this.setElement(gl, options.element, options);\n\t\t} else if (options.data && options.width && options.height) {\n\t\t\treturn this.setData(gl, options.width, options.height, options.data, options);\n\t\t} else {\n\t\t\treturn Promise.reject(this);\n\t\t}\n\t}\n\n\tsetUrl(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\turl: string,\n\t\toptions: ITextureOptions = {}\n\t): Promise<Texture> {\n\t\tif (!this.valid) {\n\t\t\treturn Promise.reject(this);\n\t\t}\n\t\tthis.url = url; // save URL reference (will be overwritten when element is loaded below)\n\t\tthis.source = url;\n\t\tthis.sourceType = TextureSourceType.Url;\n\t\tthis.options = Object.assign(this.options, options);\n\t\tconst src = String((url.indexOf(':/') === -1 && this.workpath !== undefined) ? `${this.workpath}/${url}` : url);\n\t\tconst ext = url.split('?')[0].split('.').pop().toLowerCase();\n\t\tconst isVideo = TextureVideoExtensions.indexOf(ext) !== -1;\n\t\tlet element: HTMLVideoElement | HTMLImageElement;\n\t\tlet promise: Promise<Texture>;\n\t\tif (isVideo) {\n\t\t\tLogger.log('GlslCanvas.setUrl video', src);\n\t\t\telement = document.createElement('video'); // new HTMLVideoElement();\n\t\t\telement.setAttribute('preload', 'auto');\n\t\t\t// element.setAttribute('autoplay', 'true');\n\t\t\telement.setAttribute('loop', 'true');\n\t\t\telement.setAttribute('muted', 'true');\n\t\t\telement.setAttribute('playsinline', 'true');\n\t\t\t// element.autoplay = true;\n\t\t\telement.loop = true;\n\t\t\telement.muted = true;\n\t\t\t/*\n\t\t\tif (!(Texture.isSafari() && /(?<!http|https):\\//.test(url))) {\n\t\t\t\telement.crossOrigin = 'anonymous';\n\t\t\t}\n\t\t\t*/\n\t\t\tpromise = this.setElement(gl, element, options);\n\t\t\telement.src = src;\n\t\t\telement.addEventListener('canplay', () => {\n\t\t\t\t(element as HTMLVideoElement).play();\n\t\t\t});\n\t\t} else {\n\t\t\tLogger.log('GlslCanvas.setUrl image', src);\n\t\t\telement = document.createElement('img'); // new HTMLImageElement();\n\t\t\tpromise = this.setElement(gl, element, options);\n\t\t\tif (!(Texture.isSafari() && url.slice(0, 5) === 'data:')) {\n\t\t\t\telement.crossOrigin = 'anonymous';\n\t\t\t}\n\t\t\telement.src = src;\n\t\t}\n\t\treturn promise;\n\t}\n\n\tsetElement(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\telement: HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | HTMLElement | Element,\n\t\toptions: ITextureOptions = {}\n\t): Promise<Texture> {\n\t\toptions = this.options = Object.assign(this.options, options);\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst originalElement = element;\n\t\t\t// a string element is interpeted as a CSS selector\n\t\t\tif (typeof element === 'string') {\n\t\t\t\telement = document.querySelector(element);\n\t\t\t}\n\t\t\tif (element instanceof HTMLCanvasElement ||\n\t\t\t\telement instanceof HTMLImageElement ||\n\t\t\t\telement instanceof HTMLVideoElement) {\n\t\t\t\tthis.source = element;\n\t\t\t\tthis.sourceType = TextureSourceType.Element;\n\t\t\t\tif (element instanceof HTMLVideoElement) {\n\t\t\t\t\tconst video = element as HTMLVideoElement;\n\t\t\t\t\tvideo.addEventListener('loadeddata', (event) => {\n\t\t\t\t\t\tthis.update(gl, options);\n\t\t\t\t\t\tthis.setFiltering(gl, options);\n\t\t\t\t\t\tresolve(this);\n\t\t\t\t\t});\n\t\t\t\t\tvideo.addEventListener('error', (error) => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t});\n\t\t\t\t\tvideo.load();\n\t\t\t\t} else if (element instanceof HTMLImageElement) {\n\t\t\t\t\telement.addEventListener('load', () => {\n\t\t\t\t\t\tthis.update(gl, options);\n\t\t\t\t\t\tthis.setFiltering(gl, options);\n\t\t\t\t\t\tresolve(this);\n\t\t\t\t\t});\n\t\t\t\t\telement.addEventListener('error', (error) => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tthis.update(gl, options);\n\t\t\t\t\tthis.setFiltering(gl, options);\n\t\t\t\t\tresolve(this);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tlet message = `the 'element' parameter (\\`element: ${JSON.stringify(originalElement)}\\`) must be a CSS selector string, or a <canvas>, <image> or <video> object`;\n\t\t\t\tLogger.log(`Texture '${this.key}': ${message}`, options);\n\t\t\t\treject(message);\n\t\t\t}\n\t\t});\n\t}\n\n\tsetData(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\twidth: number,\n\t\theight: number,\n\t\tdata: Uint8Array,\n\t\toptions: ITextureOptions = {}\n\t): Promise<Texture> {\n\t\tthis.width = width;\n\t\tthis.height = height;\n\t\tthis.options = Object.assign(this.options, options);\n\t\tthis.source = data;\n\t\tthis.sourceType = TextureSourceType.Data;\n\t\tthis.update(gl, options);\n\t\tthis.setFiltering(gl, options);\n\t\treturn Promise.resolve(this);\n\t}\n\n\t// Uploads current image or buffer to the GPU (can be used to update animated textures on the fly)\n\tupdate(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\toptions: ITextureOptions\n\t): void {\n\t\tif (!this.valid) {\n\t\t\treturn;\n\t\t}\n\t\tgl.activeTexture(gl.TEXTURE0 + this.index);\n\t\tgl.bindTexture(gl.TEXTURE_2D, this.texture);\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, (options.UNPACK_FLIP_Y_WEBGL === false ? 0 : 1));\n\t\tgl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, options.UNPACK_PREMULTIPLY_ALPHA_WEBGL || 0);\n\t\tif (this.sourceType === TextureSourceType.Element) {\n\t\t\tif (this.source instanceof HTMLImageElement && this.source.naturalWidth && this.source.naturalHeight) {\n\t\t\t\tthis.width = this.source.naturalWidth;\n\t\t\t\tthis.height = this.source.naturalHeight;\n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, this.source);\n\t\t\t} else if (this.source instanceof HTMLVideoElement && this.source.videoWidth && this.source.videoHeight) {\n\t\t\t\tthis.width = this.source.videoWidth;\n\t\t\t\tthis.height = this.source.videoHeight;\n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, this.source);\n\t\t\t} else if (this.source instanceof HTMLCanvasElement) {\n\t\t\t\tthis.width = this.source.width;\n\t\t\t\tthis.height = this.source.height;\n\t\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, this.source);\n\t\t\t}\n\t\t} else if (this.sourceType === TextureSourceType.Data) {\n\t\t\tconst imageBuffer: ArrayBufferView = this.source as ArrayBufferView;\n\t\t\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, imageBuffer);\n\t\t}\n\t\tthis.trigger('loaded', this);\n\t}\n\n\ttryUpdate(gl: WebGLRenderingContext | WebGL2RenderingContext): boolean {\n\t\tlet dirty = false;\n\t\tif (this.animated) {\n\t\t\tdirty = true;\n\t\t\tthis.update(gl, this.options);\n\t\t}\n\t\treturn dirty;\n\t}\n\n\tdestroy(gl: WebGLRenderingContext | WebGL2RenderingContext): void {\n\t\tif (!this.valid) {\n\t\t\treturn;\n\t\t}\n\t\tgl.deleteTexture(this.texture);\n\t\tthis.texture = null;\n\t\tdelete this.source;\n\t\tthis.source = null;\n\t\tthis.valid = false;\n\t}\n\n\tsetFiltering(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\toptions: ITextureOptions\n\t): void {\n\t\tif (!this.valid) {\n\t\t\treturn;\n\t\t}\n\t\tconst powerOf2 = Texture.isPowerOf2(this.width) && Texture.isPowerOf2(this.height);\n\t\tlet filtering = options.filtering || TextureFilteringType.MipMap;\n\t\tlet wrapS = options.TEXTURE_WRAP_S || (options.repeat ? gl.REPEAT : gl.CLAMP_TO_EDGE);\n\t\tlet wrapT = options.TEXTURE_WRAP_T || (options.repeat ? gl.REPEAT : gl.CLAMP_TO_EDGE);\n\t\tif (!powerOf2) {\n\t\t\tfiltering = filtering === TextureFilteringType.MipMap ? TextureFilteringType.Linear : filtering;\n\t\t\twrapS = wrapT = gl.CLAMP_TO_EDGE;\n\t\t\tif (options.repeat || options.TEXTURE_WRAP_S || options.TEXTURE_WRAP_T) {\n\t\t\t\tLogger.warn(`GlslCanvas: cannot repeat texture ${options.url} cause is not power of 2.`);\n\t\t\t}\n\t\t}\n\t\tthis.powerOf2 = powerOf2;\n\t\tthis.filtering = filtering;\n\t\t// this.bindTexture();\n\t\t// WebGL has strict requirements on non-power-of-2 textures:\n\t\t// No mipmaps and must clamp to edge\n\t\t// For power-of-2 textures, the following presets are available:\n\t\t// mipmap: linear blend from nearest mip\n\t\t// linear: linear blend from original image (no mips)\n\t\t// nearest: nearest pixel from original image (no mips, 'blocky' look)\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, wrapS);\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, wrapT);\n\t\tif (this.filtering === TextureFilteringType.MipMap) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR); // TODO: use trilinear filtering by defualt instead?\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\t\t\tgl.generateMipmap(gl.TEXTURE_2D);\n\t\t} else if (this.filtering === TextureFilteringType.Nearest) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n\t\t} else if (this.filtering === TextureFilteringType.Linear) {\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\n\t\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\t\t}\n\t}\n}\n\nexport default class Textures extends IterableStringMap<Texture> {\n\n\tcount: number = 0;\n\tdirty: boolean = false;\n\tanimated: boolean = false;\n\n\tclean() {\n\t\tfor (const key in this.values) {\n\t\t\tthis.values[key].dirty = false;\n\t\t}\n\t\tthis.dirty = false;\n\t}\n\n\tcreateOrUpdate(\n\t\tgl: WebGLRenderingContext | WebGL2RenderingContext,\n\t\tkey: string,\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t\tindex: number = 0,\n\t\toptions: ITextureOptions = {},\n\t\tworkpath: string,\n\t): Promise<Texture> {\n\t\tlet texture;\n\t\tconst textureOptions = Texture.getTextureOptions(urlElementOrData, options);\n\t\ttexture = this.get(key);\n\t\tif (!texture) {\n\t\t\ttexture = new Texture(gl, key, index + this.count, textureOptions, workpath);\n\t\t\tthis.count++;\n\t\t\tthis.set(key, texture);\n\t\t}\n\t\tif (textureOptions !== undefined) {\n\t\t\treturn texture.load(gl, textureOptions).then(\n\t\t\t\t(texture) => {\n\t\t\t\t\tif (texture.source instanceof HTMLVideoElement) {\n\t\t\t\t\t\tconst video = texture.source as HTMLVideoElement;\n\t\t\t\t\t\t// Logger.log('video', video);\n\t\t\t\t\t\tvideo.addEventListener('play', () => {\n\t\t\t\t\t\t\t// Logger.log('play', texture.key);\n\t\t\t\t\t\t\ttexture.animated = true;\n\t\t\t\t\t\t\tthis.animated = true;\n\t\t\t\t\t\t});\n\t\t\t\t\t\tvideo.addEventListener('pause', () => {\n\t\t\t\t\t\t\t// Logger.log('pause', texture.key);\n\t\t\t\t\t\t\ttexture.animated = false;\n\t\t\t\t\t\t\tthis.animated = this.reduce((flag: boolean, texture: Texture) => {\n\t\t\t\t\t\t\t\treturn flag || texture.animated;\n\t\t\t\t\t\t\t}, false);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tvideo.addEventListener('seeked', () => {\n\t\t\t\t\t\t\t// Logger.log('seeked');\n\t\t\t\t\t\t\ttexture.update(gl, texture.options);\n\t\t\t\t\t\t\tthis.dirty = true;\n\t\t\t\t\t\t});\n\t\t\t\t\t\t// Logger.log('video');\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tvideo.addEventListener('canplaythrough', () => {\n\t\t\t\t\t\t\t// !!!\n\t\t\t\t\t\t\tthis.intervalID = setInterval(() => {\n\t\t\t\t\t\t\t\tthis.update(gl, options);\n\t\t\t\t\t\t\t}, 15);\n\t\t\t\t\t\t}, true);\n\t\t\t\t\t\tvideo.addEventListener('ended', () => {\n\t\t\t\t\t\t\tvideo.currentTime = 0;\n\t\t\t\t\t\t\tvideo.play();\n\t\t\t\t\t\t}, true);\n\t\t\t\t\t\t*/\n\t\t\t\t\t}\n\t\t\t\t\treturn texture;\n\t\t\t\t}\n\t\t\t);\n\t\t} else {\n\t\t\treturn Promise.resolve(texture);\n\t\t}\n\t}\n}\n","import Logger from '../logger/logger';\n\nexport class Listener {\n\tevent: string;\n\tcallback: Function;\n\n\tconstructor(\n\t\tevent: string,\n\t\tcallback: Function\n\t) {\n\t\tthis.event = event;\n\t\tthis.callback = callback;\n\t}\n}\n\nexport default class Subscriber {\n\tprivate listeners: Set<Listener> = new Set<Listener>();\n\n\tlogListeners() {\n\t\tthis.listeners.forEach(x => Logger.log(x));\n\t}\n\n\tsubscribe(listener: Listener) {\n\t\tthis.listeners.add(listener);\n\t}\n\n\tunsubscribe(listener: Listener) {\n\t\tthis.listeners.delete(listener);\n\t}\n\n\tunsubscribeAll() {\n\t\tthis.listeners.clear();\n\t}\n\n\ton(event: string, callback: Function) {\n\t\tthis.listeners.add(new Listener(event, callback));\n\t\treturn this;\n\t}\n\n\toff(event: string, callback?: Function) {\n\t\tif (callback) {\n\t\t\tthis.listeners.delete(new Listener(event, callback));\n\t\t} else {\n\t\t\tthis.listeners.forEach(x => {\n\t\t\t\tif (x.event === event) {\n\t\t\t\t\tthis.listeners.delete(x);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\treturn this;\n\t}\n\n\ttrigger(event: string, ...data: any[]) {\n\t\tthis.listeners.forEach(x => {\n\t\t\tif (x.event === event && typeof x.callback === 'function') {\n\t\t\t\tx.callback(...data);\n\t\t\t}\n\t\t});\n\t\treturn this;\n\t}\n\n}\n","\nimport IterableStringMap from '../core/iterable';\nimport Logger from '../logger/logger';\nimport { Texture } from '../textures/textures';\n\nexport enum UniformMethod {\n\tUnknown = 0,\n\tUniform1i = 'uniform1i', // (intUniformLoc,   v);                 // for int\n\t// Uniform1i  = 'uniform1i', // (boolUniformLoc,   v);                // for bool\n\t// Uniform1i  = 'uniform1i', // (sampler2DUniformLoc,   v);           // for sampler2D\n\t// Uniform1i  = 'uniform1i', // (samplerCubeUniformLoc,   v);         // for samplerCube\n\tUniform2i = 'uniform2i', // (ivec2UniformLoc, v0, v1);            // for ivec2\n\tUniform3i = 'uniform3i', // (ivec3UniformLoc, v0, v1, v2);        // for ivec3\n\tUniform4i = 'uniform4i', // (ivec4UniformLoc, v0, v1, v2, v4);    // for ivec4\n\tUniform1f = 'uniform1f', // (floatUniformLoc, v);                 // for float\n\tUniform2f = 'uniform2f', // (vec2UniformLoc,  v0, v1);            // for vec2\n\tUniform3f = 'uniform3f', // (vec3UniformLoc,  v0, v1, v2);        // for vec3\n\tUniform4f = 'uniform4f', // (vec4UniformLoc,  v0, v1, v2, v4);    // for vec4\n\t//\n\tUniform1iv = 'uniform1iv', // (intUniformLoc, [v]);                 // for int or int array\n\t// Uniform1iv = 'uniform1iv', // (boolUniformLoc, [v]);                // for bool or bool array\n\t// Uniform1iv = 'uniform1iv', // (sampler2DUniformLoc, [v]);           // for sampler2D or sampler2D array\n\t// Uniform1iv = 'uniform1iv', // (samplerCubeUniformLoc, [v]);         // for samplerCube or samplerCube array\n\tUniform2iv = 'uniform2iv', // (ivec2UniformLoc, [v0, v1]);          // for ivec2 or ivec2 array\n\tUniform3iv = 'uniform3iv', // (ivec3UniformLoc, [v0, v1, v2]);      // for ivec3 or ivec3 array\n\tUniform4iv = 'uniform4iv', // (ivec4UniformLoc, [v0, v1, v2, v4]);  // for ivec4 or ivec4 array\n\t//\n\tUniform1fv = 'uniform1fv', // (floatUniformLoc, [v]);               // for float or float array\n\tUniform2fv = 'uniform2fv', // (vec2UniformLoc,  [v0, v1]);          // for vec2 or vec2 array\n\tUniform3fv = 'uniform3fv', // (vec3UniformLoc,  [v0, v1, v2]);      // for vec3 or vec3 array\n\tUniform4fv = 'uniform4fv', // (vec4UniformLoc,  [v0, v1, v2, v4]);  // for vec4 or vec4 array\n\t//\n\tUniformMatrix2fv = 'uniformMatrix2fv', // (mat2UniformLoc, false, [  4x element array ])  // for mat2 or mat2 array\n\tUniformMatrix3fv = 'uniformMatrix3fv', // (mat3UniformLoc, false, [  9x element array ])  // for mat3 or mat3 array\n\tUniformMatrix4fv = 'uniformMatrix4fv', // (mat4UniformLoc, false, [ 16x element array ])  // for mat4 or mat4 array\n}\n\nexport enum UniformType {\n\tUnknown = 0,\n\tFloat,\n\tInt,\n\tBool,\n\tSampler2D,\n\tSamplerCube,\n\tMatrix2fv,\n\tMatrix3fv,\n\tMatrix4fv,\n}\n\nexport const METHODS_INT = [UniformMethod.Uniform1i, UniformMethod.Uniform2i, UniformMethod.Uniform3i, UniformMethod.Uniform4i];\nexport const METHODS_FLOAT = [UniformMethod.Uniform1f, UniformMethod.Uniform2f, UniformMethod.Uniform3f, UniformMethod.Uniform4f];\nexport const METHODS_INTV = [UniformMethod.Uniform1iv, UniformMethod.Uniform2iv, UniformMethod.Uniform3iv, UniformMethod.Uniform4iv];\nexport const METHODS_FLOATV = [UniformMethod.Uniform1fv, UniformMethod.Uniform2fv, UniformMethod.Uniform3fv, UniformMethod.Uniform4fv];\n\nexport interface IUniformOption { [key: string]: any[]; }\n\nexport class Uniform {\n\tmethod: UniformMethod;\n\ttype: UniformType;\n\tkey: string;\n\tvalues: any[];\n\tlocation?: WebGLUniformLocation;\n\tdirty?: boolean = true;\n\tapply?: Function;\n\n\tconstructor(options?: Uniform) {\n\t\tif (options) {\n\t\t\tObject.assign(this, options);\n\t\t}\n\t\tthis.apply = (gl: WebGLRenderingContext | WebGL2RenderingContext, program: WebGLProgram) => {\n\t\t\tif (this.dirty) {\n\t\t\t\tgl.useProgram(program);\n\t\t\t\tconst location = gl.getUniformLocation(program, this.key);\n\t\t\t\t// Logger.log(this.key, this.method, this.values);\n\t\t\t\t// (gl as any)[this.method].apply(gl, [location].concat(this.values));\n\t\t\t\t(gl as any)[this.method].apply(gl, [location].concat(this.values));\n\t\t\t}\n\t\t}\n\t}\n\n}\n\nexport class UniformTexture extends Uniform {\n\n\ttexture: Texture;\n\n\tconstructor(options?: Uniform) {\n\t\tsuper(options);\n\t}\n\n}\n\nexport default class Uniforms extends IterableStringMap<Uniform> {\n\n\tdirty: boolean = false;\n\n\t/*\n\t// slow\n\tstatic isDifferent(a: any, b: any): boolean {\n        return JSON.stringify(a) !== JSON.stringify(b);\n    }\n\t*/\n\n\tstatic isDifferent(a: any[], b: any[]) {\n\t\treturn a.length !== b.length ||\n\t\t\ta.reduce((f: boolean, v: any, i: number) => {\n\t\t\t\treturn f || v !== b[i];\n\t\t\t}, false);\n\t}\n\n\tstatic isArrayOfInteger(array: any[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: any) => {\n\t\t\treturn flag && Number.isInteger(value);\n\t\t}, true);\n\t}\n\n\tstatic isArrayOfNumber(array: any[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: any) => {\n\t\t\treturn flag && typeof value === 'number';\n\t\t}, true);\n\t}\n\n\tstatic isArrayOfBoolean(array: any[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: any) => {\n\t\t\treturn flag && typeof value === 'boolean';\n\t\t}, true);\n\t}\n\n\tstatic isArrayOfTexture(array: any[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: any) => {\n\t\t\treturn flag && Texture.isTexture(value);\n\t\t}, true);\n\t}\n\n\tstatic isArrayOfSampler2D(array: Uniform[]): boolean {\n\t\treturn array.reduce((flag: boolean, value: Uniform) => {\n\t\t\treturn flag && value.type === UniformType.Sampler2D;\n\t\t}, true);\n\t}\n\n\tprivate static getType_(\n\t\tvalues: any[],\n\t): UniformType {\n\t\tlet type = UniformType.Unknown;\n\t\tconst isVector = values.length === 1 && Array.isArray(values[0]);\n\t\tconst subject = isVector ? values[0] : values;\n\t\tif (Uniforms.isArrayOfNumber(subject)) {\n\t\t\ttype = UniformType.Float;\n\t\t} else if (Uniforms.isArrayOfBoolean(subject)) {\n\t\t\ttype = UniformType.Bool;\n\t\t} else if (Uniforms.isArrayOfTexture(subject)) {\n\t\t\ttype = UniformType.Sampler2D;\n\t\t}\n\t\treturn type;\n\t}\n\n\tprivate static getMethod_(\n\t\ttype: UniformType,\n\t\tvalues: any[],\n\t): UniformMethod {\n\t\tlet method = UniformMethod.Unknown;\n\t\tconst isVector = values.length === 1 && Array.isArray(values[0]);\n\t\tconst subject = isVector ? values[0] : values;\n\t\tconst length = subject.length;\n\t\tconst i = length - 1;\n\t\tswitch (type) {\n\t\t\tcase UniformType.Float:\n\t\t\t\tif (isVector) {\n\t\t\t\t\tmethod = i < METHODS_FLOATV.length ? METHODS_FLOATV[i] : UniformMethod.Unknown;\n\t\t\t\t} else {\n\t\t\t\t\tmethod = i < METHODS_FLOAT.length ? METHODS_FLOAT[i] : UniformMethod.Uniform1fv;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase UniformType.Int:\n\t\t\tcase UniformType.Bool:\n\t\t\t\tif (isVector) {\n\t\t\t\t\tmethod = i < METHODS_INTV.length ? METHODS_INTV[i] : UniformMethod.Unknown;\n\t\t\t\t} else {\n\t\t\t\t\tmethod = i < METHODS_INT.length ? METHODS_INT[i] : UniformMethod.Uniform1iv;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase UniformType.Sampler2D:\n\t\t\t\tif (isVector) {\n\t\t\t\t\tmethod = UniformMethod.Uniform1iv;\n\t\t\t\t} else {\n\t\t\t\t\tmethod = length === 1 ? UniformMethod.Uniform1i : UniformMethod.Uniform1iv;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\t\treturn method;\n\t}\n\n\tstatic parseUniform(\n\t\tkey: string,\n\t\tvalues: any[],\n\t\ttype: UniformType = null\n\t): Uniform | Uniform[] {\n\t\tlet uniform: Uniform;\n\t\ttype = type || Uniforms.getType_(values);\n\t\tconst method = Uniforms.getMethod_(type, values);\n\t\tif (type !== UniformType.Unknown && method !== UniformMethod.Unknown) {\n\t\t\t// Logger.log('Uniforms.parseUniform', key, UniformType[type], method, values);\n\t\t\tif (type === UniformType.Sampler2D && method === UniformMethod.Uniform1iv) {\n\t\t\t\treturn values[0].map((texture: any, index: number) => {\n\t\t\t\t\treturn new Uniform({\n\t\t\t\t\t\tmethod: method,\n\t\t\t\t\t\ttype: type,\n\t\t\t\t\t\tkey: `${key}[${index}]`, // `${key.split('[')[0]}[${index}]`,\n\t\t\t\t\t\tvalues: [texture]\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tuniform = new Uniform({\n\t\t\t\t\tmethod: method,\n\t\t\t\t\ttype: type,\n\t\t\t\t\tkey: key,\n\t\t\t\t\tvalues: values\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tLogger.error('Uniforms.parseUniform.Unknown', key, values);\n\t\t}\n\t\t// return this.parseUniform__bak(key, values);\n\t\treturn uniform;\n\t}\n\n\tcreate(method: UniformMethod, type: UniformType, key: string, values: any[]): Uniform {\n\t\tconst uniform = new Uniform({\n\t\t\tmethod: method,\n\t\t\ttype: type,\n\t\t\tkey: key,\n\t\t\tvalues: values,\n\t\t});\n\t\tthis.set(key, uniform);\n\t\tthis.dirty = true;\n\t\treturn uniform;\n\t}\n\n\tcreateTexture(key: string, index: number): UniformTexture {\n\t\tlet uniform;\n\t\tif (key.indexOf(']') !== -1) {\n\t\t\tuniform = new UniformTexture({\n\t\t\t\tmethod: UniformMethod.Uniform1iv,\n\t\t\t\ttype: UniformType.Sampler2D,\n\t\t\t\tkey: key,\n\t\t\t\tvalues: [[index]],\n\t\t\t});\n\t\t} else {\n\t\t\tuniform = new UniformTexture({\n\t\t\t\tmethod: UniformMethod.Uniform1i,\n\t\t\t\ttype: UniformType.Sampler2D,\n\t\t\t\tkey: key,\n\t\t\t\tvalues: [index],\n\t\t\t});\n\t\t}\n\t\tthis.set(key, uniform);\n\t\tthis.dirty = true;\n\t\treturn uniform;\n\t}\n\n\tupdate(method: UniformMethod, type: UniformType, key: string, values: any[]) {\n\t\tconst uniform = this.get(key);\n\t\tif (uniform &&\n\t\t\t(uniform.method !== method ||\n\t\t\t\tuniform.type !== type ||\n\t\t\t\tUniforms.isDifferent(uniform.values, values)\n\t\t\t)) {\n\t\t\tuniform.method = method;\n\t\t\tuniform.type = type;\n\t\t\tuniform.values = values;\n\t\t\tuniform.dirty = true;\n\t\t\tthis.dirty = true;\n\t\t}\n\t}\n\n\tcreateOrUpdate(method: UniformMethod, type: UniformType, key: string, values: any[]) {\n\t\tif (this.has(key)) {\n\t\t\tthis.update(method, type, key, values);\n\t\t} else {\n\t\t\tthis.create(method, type, key, values);\n\t\t}\n\t}\n\n\tapply(gl: WebGLRenderingContext | WebGL2RenderingContext, program: WebGLProgram) {\n\t\tfor (const key in this.values) {\n\t\t\t// if (typeof this.values[key].apply === 'function') {\n\t\t\tthis.values[key].apply(gl, program);\n\t\t\t// }\n\t\t}\n\t\t// this.forEach(uniform => uniform.apply(gl, program));\n\t}\n\n\tclean() {\n\t\tfor (const key in this.values) {\n\t\t\tthis.values[key].dirty = false;\n\t\t}\n\t\tthis.dirty = false;\n\t}\n\n}\n","export default class CanvasTimer {\n\n\tstart: number;\n\tprevious: number;\n\tdelay: number = 0.0;\n\tcurrent: number = 0.0;\n\tdelta: number = 0.0;\n\tpaused: boolean = false;\n\n\tconstructor() {\n\t\tthis.start = this.previous = this.now();\n\t}\n\n\tnow() {\n\t\treturn performance.now();\n\t}\n\n\tplay() {\n\t\tif (this.previous) {\n\t\t\tconst now = this.now();\n\t\t\tthis.delay += (now - this.previous);\n\t\t\tthis.previous = now;\n\t\t}\n\t\t// Logger.log(this.delay);\n\t\tthis.paused = false;\n\t}\n\n\tpause() {\n\t\tthis.paused = true;\n\t}\n\n\tnext(): CanvasTimer {\n\t\tconst now = this.now();\n\t\tthis.delta = now - this.previous;\n\t\tthis.current = now - this.start - this.delay;\n\t\tthis.previous = now;\n\t\treturn this;\n\t}\n\n}\n","// import '@babel/polyfill';\nimport 'promise-polyfill';\nimport Buffers, { IOBuffer } from '../buffers/buffers';\nimport Context, { ContextDefaultFragment, ContextVertexBuffers, IContextOptions } from '../context/context';\nimport Common from '../core/common';\nimport Subscriber from '../core/subscriber';\nimport Logger from '../logger/logger';\nimport Textures, { ITextureData, ITextureInput, ITextureOptions, Texture } from '../textures/textures';\nimport Uniforms, { IUniformOption, Uniform, UniformMethod, UniformType } from '../uniforms/uniforms';\nimport CanvasTimer from './canvas-timer';\n\nexport interface IPoint {\n\tx: number,\n\ty: number,\n}\n\nexport interface ICanvasOptions extends IContextOptions {\n\tvertexString?: string;\n\tfragmentString?: string;\n\tbackgroundColor?: string;\n\tworkpath?: string;\n\tonError?: Function;\n\textensions?: string[];\n}\n\nexport default class Canvas extends Subscriber {\n\toptions: ICanvasOptions;\n\tcanvas: HTMLCanvasElement;\n\tgl: WebGLRenderingContext | WebGL2RenderingContext;\n\tprogram: WebGLProgram;\n\ttimer: CanvasTimer;\n\tvertexBuffers: ContextVertexBuffers;\n\trect: ClientRect | DOMRect;\n\tmouse: IPoint = { x: 0, y: 0 };\n\tuniforms: Uniforms = new Uniforms();\n\tbuffers: Buffers = new Buffers();\n\ttextures: Textures = new Textures();\n\ttextureList: ITextureInput[] = [];\n\n\tvertexString: string;\n\tfragmentString: string;\n\twidth: number;\n\theight: number;\n\tdevicePixelRatio: number;\n\n\tvalid: boolean = false;\n\tanimated: boolean = false;\n\tdirty: boolean = true;\n\tvisible: boolean = false;\n\n\trafId: number;\n\n\tconstructor(\n\t\tcanvas: HTMLCanvasElement,\n\t\toptions: ICanvasOptions = {\n\t\t\t// alpha: true,\n\t\t\t// antialias: true,\n\t\t\t// premultipliedAlpha: true\n\t\t}\n\t) {\n\t\tsuper();\n\t\tif (!canvas) {\n\t\t\treturn;\n\t\t}\n\t\tthis.options = options;\n\t\tthis.canvas = canvas;\n\t\tthis.width = 0; // canvas.clientWidth;\n\t\tthis.height = 0; // canvas.clientHeight;\n\t\tthis.rect = canvas.getBoundingClientRect();\n\t\tthis.devicePixelRatio = window.devicePixelRatio || 1;\n\t\tcanvas.style.backgroundColor = options.backgroundColor || 'rgba(0,0,0,0)';\n\t\tthis.getShaders_().then((success) => {\n\t\t\t/*\n\t\t\tconst v = this.vertexString = options.vertexString || this.vertexString;\n\t\t\tconst f = this.fragmentString = options.fragmentString || this.fragmentString;\n\t\t\tthis.vertexString = Context.getVertex(v, f);\n\t\t\tthis.fragmentString = Context.getFragment(v, f);\n\t\t\tconst gl = Context.tryInferContext(v, f, canvas, options, options.onError);\n\t\t\tif (!gl) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.gl = gl;\n\t\t\t*/\n\t\t\tthis.load().then(success => {\n\t\t\t\tif (!this.program) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.addListeners_();\n\t\t\t\tthis.onLoop();\n\t\t\t});\n\t\t}, (error) => {\n\t\t\tLogger.log('GlslCanvas.getShaders_.error', error);\n\t\t});\n\t\tCanvas.items.push(this);\n\t}\n\n\tstatic logger: Logger = Logger;\n\tstatic items: Canvas[] = [];\n\n\tstatic version(): string {\n\t\treturn '0.1.6';\n\t}\n\n\tstatic of(canvas: HTMLCanvasElement, options?: ICanvasOptions): Canvas {\n\t\treturn Canvas.items.find(x => x.canvas === canvas) || new Canvas(canvas, options);\n\t}\n\n\tstatic loadAll(): Canvas[] {\n\t\tconst canvases: HTMLCanvasElement[] = <HTMLCanvasElement[]>[].slice.call(document.getElementsByClassName('glsl-canvas')).filter((x: HTMLElement) => x instanceof HTMLCanvasElement);\n\t\treturn canvases.map(x => Canvas.of(x));\n\t}\n\n\tprivate getShaders_(): Promise<string[]> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst canvas = this.canvas;\n\t\t\tconst urls: any = {};\n\t\t\tif (canvas.hasAttribute('data-vertex-url')) {\n\t\t\t\turls.vertex = canvas.getAttribute('data-vertex-url');\n\t\t\t}\n\t\t\tif (canvas.hasAttribute('data-fragment-url')) {\n\t\t\t\turls.fragment = canvas.getAttribute('data-fragment-url');\n\t\t\t}\n\t\t\tif (canvas.hasAttribute('data-vertex')) {\n\t\t\t\tthis.vertexString = canvas.getAttribute('data-vertex');\n\t\t\t}\n\t\t\tif (canvas.hasAttribute('data-fragment')) {\n\t\t\t\tthis.fragmentString = canvas.getAttribute('data-fragment');\n\t\t\t}\n\t\t\tif (Object.keys(urls).length) {\n\t\t\t\tPromise.all(Object.keys(urls).map((key, i) => {\n\t\t\t\t\tconst url: string = urls[key];\n\t\t\t\t\treturn Common.fetch(url)\n\t\t\t\t\t\t// .then((response) => response.text())\n\t\t\t\t\t\t.then((body) => {\n\t\t\t\t\t\t\tif (key === 'vertex') {\n\t\t\t\t\t\t\t\treturn this.vertexString = body;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\treturn this.fragmentString = body;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t})).then(shaders => {\n\t\t\t\t\tresolve([this.vertexString, this.fragmentString]);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tresolve([this.vertexString, this.fragmentString]);\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate addListeners_(): void {\n        /*\n        const resize = (e: Event) => {\n            this.rect = this.canvas.getBoundingClientRect();\n            this.trigger('resize', e);\n        };\n        */\n\t\tthis.onScroll = this.onScroll.bind(this);\n\t\tthis.onClick = this.onClick.bind(this);\n\t\tthis.onMove = this.onMove.bind(this);\n\t\tthis.onMousemove = this.onMousemove.bind(this);\n\t\tthis.onMouseover = this.onMouseover.bind(this);\n\t\tthis.onMouseout = this.onMouseout.bind(this);\n\t\tthis.onTouchmove = this.onTouchmove.bind(this);\n\t\tthis.onTouchend = this.onTouchend.bind(this);\n\t\tthis.onTouchstart = this.onTouchstart.bind(this);\n\t\tthis.onLoop = this.onLoop.bind(this);\n\t\t// window.addEventListener('resize', this.onResize);\n\t\twindow.addEventListener('scroll', this.onScroll);\n\t\tdocument.addEventListener('mousemove', this.onMousemove, false);\n\t\tdocument.addEventListener('touchmove', this.onTouchmove);\n\t\tthis.addCanvasListeners_();\n\t}\n\n\tprivate addCanvasListeners_() {\n\t\tif (this.canvas.hasAttribute('controls')) {\n\t\t\tthis.canvas.addEventListener('click', this.onClick);\n\t\t\tthis.canvas.addEventListener('mouseover', this.onMouseover);\n\t\t\tthis.canvas.addEventListener('mouseout', this.onMouseout);\n\t\t\tthis.canvas.addEventListener('touchstart', this.onTouchstart);\n\t\t\tif (!this.canvas.hasAttribute('data-autoplay')) {\n\t\t\t\tthis.pause();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate removeCanvasListeners_() {\n\t\tif (this.canvas.hasAttribute('controls')) {\n\t\t\tthis.canvas.removeEventListener('click', this.onClick);\n\t\t\tthis.canvas.removeEventListener('mouseover', this.onMouseover);\n\t\t\tthis.canvas.removeEventListener('mouseout', this.onMouseout);\n\t\t\tthis.canvas.removeEventListener('touchstart', this.onTouchstart);\n\t\t}\n\t}\n\n\tprivate removeListeners_() {\n\t\twindow.cancelAnimationFrame(this.rafId);\n\t\t// window.removeEventListener('resize', this.onResize);\n\t\twindow.removeEventListener('scroll', this.onScroll);\n\t\tdocument.removeEventListener('mousemove', this.onMousemove);\n\t\tdocument.removeEventListener('touchmove', this.onTouchmove);\n\t\tthis.removeCanvasListeners_();\n\t}\n\n\tonScroll(e: Event) {\n\t\tthis.rect = this.canvas.getBoundingClientRect();\n\t}\n\n\tonClick(e: MouseEvent) {\n\t\tthis.toggle();\n\t\tthis.trigger('click', e);\n\t}\n\n\tonMove(mx: number, my: number) {\n\t\t/*\n\t\tconst rect = this.rect, gap = 20;\n\t\tconst x = Math.max(-gap, Math.min(rect.width + gap, (mx - rect.left) * this.devicePixelRatio));\n\t\tconst y = Math.max(-gap, Math.min(rect.height + gap, (this.canvas.height - (my - rect.top) * this.devicePixelRatio)));\n\t\t*/\n\t\tconst rect = this.rect;\n\t\tconst x = (mx - rect.left) * this.devicePixelRatio;\n\t\tconst y = (rect.height - (my - rect.top)) * this.devicePixelRatio;\n\t\tif (x !== this.mouse.x ||\n\t\t\ty !== this.mouse.y) {\n\t\t\tthis.mouse.x = x;\n\t\t\tthis.mouse.y = y;\n\t\t\tthis.trigger('move', this.mouse);\n\t\t}\n\t}\n\n\tonMousemove(e: MouseEvent) {\n\t\tthis.onMove(e.clientX || e.pageX, e.clientY || e.pageY);\n\t}\n\n\tonMouseover(e: MouseEvent) {\n\t\tthis.play();\n\t\tthis.trigger('over', e);\n\t}\n\n\tonMouseout(e: MouseEvent) {\n\t\tthis.pause();\n\t\tthis.trigger('out', e);\n\t}\n\n\tonTouchmove(e: TouchEvent) {\n\t\tconst touch = [].slice.call(e.touches).reduce((p: IPoint, touch: Touch) => {\n\t\t\tp = p || { x: 0, y: 0 };\n\t\t\tp.x += touch.clientX;\n\t\t\tp.y += touch.clientY;\n\t\t\treturn p;\n\t\t}, null);\n\t\tif (touch) {\n\t\t\tthis.onMove(touch.x / e.touches.length, touch.y / e.touches.length);\n\t\t}\n\t}\n\n\tonTouchend(e: TouchEvent) {\n\t\tthis.pause();\n\t\tthis.trigger('out', e);\n\t\tdocument.removeEventListener('touchend', this.onTouchend);\n\t}\n\n\tonTouchstart(e: TouchEvent) {\n\t\tthis.play();\n\t\tthis.trigger('over', e);\n\t\tdocument.addEventListener('touchend', this.onTouchend);\n\t\tdocument.removeEventListener('mousemove', this.onMousemove);\n\t\tif (this.canvas.hasAttribute('controls')) {\n\t\t\tthis.canvas.removeEventListener('mouseover', this.onMouseover);\n\t\t\tthis.canvas.removeEventListener('mouseout', this.onMouseout);\n\t\t}\n\t}\n\n\tonLoop(time?: number) {\n\t\tthis.checkRender();\n\t\tthis.rafId = window.requestAnimationFrame(this.onLoop);\n\t}\n\n\tprivate setUniform_(\n\t\tkey: string,\n\t\tvalues: any[],\n\t\toptions: ITextureOptions = {},\n\t\ttype: UniformType = null\n\t): void {\n\t\tconst uniform: Uniform | Uniform[] = Uniforms.parseUniform(key, values, type);\n\t\tif (Array.isArray(uniform)) {\n\t\t\tif (Uniforms.isArrayOfSampler2D(uniform)) {\n\t\t\t\tuniform.forEach((x) => this.loadTexture(x.key, x.values[0], options));\n\t\t\t} else {\n\t\t\t\tuniform.forEach((x) => this.uniforms.set(x.key, x.values[0]));\n\t\t\t}\n\t\t} else if (uniform) {\n\t\t\tswitch (uniform.type) {\n\t\t\t\tcase UniformType.Sampler2D:\n\t\t\t\t\tthis.loadTexture(key, values[0], options);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthis.uniforms.set(key, uniform);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate parseTextures_(fragmentString: string): boolean {\n\t\t// const regexp = /uniform\\s*sampler2D\\s*([\\w]*);(\\s*\\/\\/\\s*([\\w|\\:\\/\\/|\\.|\\-|\\_]*)|\\s*)/gm;\n\t\tconst regexp = /uniform\\s*sampler2D\\s*([\\w]*);(\\s*\\/\\/\\s*([\\w|\\:\\/\\/|\\.|\\-|\\_|\\?|\\&|\\=]*)|\\s*)/gm;\n\t\t// const regexp = /uniform\\s*sampler2D\\s*([\\w]*);(\\s*\\/\\/\\s*([\\w|\\://|\\.|\\-|\\_]*)|\\s*)((\\s*\\:\\s)(\\{(\\s*\\w*\\:\\s*['|\"]{0,1}\\w*['|\"]{0,1}\\s*[,]{0,1})+\\}))*/gm;\n\t\tlet matches;\n\t\twhile ((matches = regexp.exec(fragmentString)) !== null) {\n\t\t\tconst key = matches[1];\n\t\t\tconst url = matches[3];\n\t\t\tif (Texture.isTextureUrl(url)) {\n\t\t\t\tthis.textureList.push({ key, url });\n\t\t\t\t/*\n\t\t\t\tif (matches[3]) {\n\t\t\t\t\tconst ext = matches[3].split('?')[0].split('.').pop().toLowerCase();\n\t\t\t\t\tconst url = matches[3];\n\t\t\t\t\tif (url && TextureExtensions.indexOf(ext) !== -1) {\n\t\t\t\t\t\t// let options;\n\t\t\t\t\t\t// if (matches[6]) {\n\t\t\t\t\t\t// \ttry {\n\t\t\t\t\t\t// \t\toptions = new Function(`return ${matches[6]};`)();\n\t\t\t\t\t\t// \t} catch (e) {\n\t\t\t\t\t\t// \t\t// console.log('wrong texture options');\n\t\t\t\t\t\t// \t}\n\t\t\t\t\t\t// }\n\t\t\t\t\t\t// console.log(options, matches[6]);\n\t\t\t\t\t\t// this.textureList.push({ key, url, options });\n\t\t\t\t\t\tthis.textureList.push({ key, url });\n\t\t\t\t\t}\n\t\t\t\t*/\n\t\t\t} else if (!this.buffers.has(key)) {\n\t\t\t\t// create empty texture\n\t\t\t\tthis.textureList.push({ key, url: null });\n\t\t\t}\n\t\t}\n\t\tif (this.canvas.hasAttribute('data-textures')) {\n\t\t\tconst urls = this.canvas.getAttribute('data-textures').split(',');\n\t\t\turls.forEach((url: string, i: number) => {\n\t\t\t\tconst key = 'u_texture' + i;\n\t\t\t\tthis.textureList.push({ key, url });\n\t\t\t});\n\t\t}\n\t\treturn this.textureList.length > 0;\n\t}\n\n\tprivate createUniforms_(): void {\n\t\tconst gl = this.gl;\n\t\tconst fragmentString = this.fragmentString;\n\t\tconst BW = gl.drawingBufferWidth;\n\t\tconst BH = gl.drawingBufferHeight;\n\t\tconst timer = this.timer = new CanvasTimer();\n\t\tconst hasDelta = (fragmentString.match(/u_delta/g) || []).length > 1;\n\t\tconst hasTime = (fragmentString.match(/u_time/g) || []).length > 1;\n\t\tconst hasDate = (fragmentString.match(/u_date/g) || []).length > 1;\n\t\tconst hasMouse = (fragmentString.match(/u_mouse/g) || []).length > 1;\n\t\tconst hasTextures = this.parseTextures_(fragmentString);\n\t\tthis.animated = hasTime || hasDate || hasMouse;\n\t\tif (this.animated) {\n\t\t\tthis.canvas.classList.add('animated');\n\t\t} else {\n\t\t\tthis.canvas.classList.remove('animated');\n\t\t}\n\t\tthis.uniforms.create(UniformMethod.Uniform2f, UniformType.Float, 'u_resolution', [BW, BH]);\n\t\tif (hasDelta) {\n\t\t\tthis.uniforms.create(UniformMethod.Uniform1f, UniformType.Float, 'u_delta', [timer.delta / 1000.0]);\n\t\t}\n\t\tif (hasTime) {\n\t\t\tthis.uniforms.create(UniformMethod.Uniform1f, UniformType.Float, 'u_time', [timer.current / 1000.0]);\n\t\t}\n\t\tif (hasDate) {\n\t\t\tconst date = new Date();\n\t\t\tthis.uniforms.create(UniformMethod.Uniform4f, UniformType.Float, 'u_date', [date.getFullYear(), date.getMonth(), date.getDate(), date.getHours() * 3600 + date.getMinutes() * 60 + date.getSeconds() + date.getMilliseconds() * 0.001]);\n\t\t}\n\t\tif (hasMouse) {\n\t\t\tthis.uniforms.create(UniformMethod.Uniform2f, UniformType.Float, 'u_mouse', [0, 0]);\n\t\t}\n\t\tfor (const key in this.buffers.values) {\n\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\tthis.uniforms.create(UniformMethod.Uniform1i, UniformType.Sampler2D, buffer.key, [buffer.input.index]);\n\t\t}\n\t\tif (hasTextures) {\n\t\t\tthis.textureList.filter(x => x.url).forEach(x => {\n\t\t\t\tthis.setTexture(x.key, x.url, x.options);\n\t\t\t});\n\t\t\tthis.textureList = [];\n\t\t}\n\t}\n\n\tprivate updateUniforms_(): void {\n\t\tconst gl = this.gl;\n\t\tconst BW = gl.drawingBufferWidth;\n\t\tconst BH = gl.drawingBufferHeight;\n\t\tif (!this.timer) {\n\t\t\treturn;\n\t\t}\n\t\tconst timer = this.timer.next();\n\t\tthis.uniforms.update(UniformMethod.Uniform2f, UniformType.Float, 'u_resolution', [BW, BH]);\n\t\tif (this.uniforms.has('u_delta')) {\n\t\t\tthis.uniforms.update(UniformMethod.Uniform1f, UniformType.Float, 'u_delta', [timer.delta / 1000.0]);\n\t\t}\n\t\tif (this.uniforms.has('u_time')) {\n\t\t\tthis.uniforms.update(UniformMethod.Uniform1f, UniformType.Float, 'u_time', [timer.current / 1000.0]);\n\t\t}\n\t\tif (this.uniforms.has('u_date')) {\n\t\t\tconst date = new Date();\n\t\t\tthis.uniforms.update(UniformMethod.Uniform4f, UniformType.Float, 'u_date', [date.getFullYear(), date.getMonth(), date.getDate(), date.getHours() * 3600 + date.getMinutes() * 60 + date.getSeconds() + date.getMilliseconds() * 0.001]);\n\t\t}\n\t\tif (this.uniforms.has('u_mouse')) {\n\t\t\tconst mouse = this.mouse;\n\t\t\tthis.uniforms.update(UniformMethod.Uniform2f, UniformType.Float, 'u_mouse', [mouse.x, mouse.y]);\n            /*\n            const rect = this.rect;\n            if (mouse.x >= rect.left && mouse.x <= rect.right &&\n                mouse.y >= rect.top && mouse.y <= rect.bottom) {\n                const MX = (mouse.x - rect.left) * this.devicePixelRatio;\n                const MY = (this.canvas.height - (mouse.y - rect.top) * this.devicePixelRatio);\n                this.uniforms.update(UniformMethod.Uniform2f, UniformType.Float, 'u_mouse', [MX, MY]);\n            }\n            */\n\t\t}\n\t\tfor (const key in this.buffers.values) {\n\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\tthis.uniforms.update(UniformMethod.Uniform1i, UniformType.Sampler2D, buffer.key, [buffer.input.index]);\n\t\t}\n\t\tfor (const key in this.textures.values) {\n\t\t\tconst texture: Texture = this.textures.values[key];\n\t\t\ttexture.tryUpdate(gl);\n\t\t\tthis.uniforms.update(UniformMethod.Uniform1i, UniformType.Sampler2D, texture.key, [texture.index]);\n\t\t}\n\t}\n\n\tprivate isVisible_(): boolean {\n\t\tconst rect = this.rect;\n\t\treturn (rect.top + rect.height) > 0 && rect.top < (window.innerHeight || document.documentElement.clientHeight);\n\t}\n\n\tprivate isAnimated_(): boolean {\n\t\treturn (this.animated || this.textures.animated) && !this.timer.paused;\n\t}\n\n\tprivate isDirty_(): boolean {\n\t\treturn this.dirty || this.uniforms.dirty || this.textures.dirty;\n\t}\n\n\t// check size change at start of requestFrame\n\tprivate sizeDidChanged_(): boolean {\n\t\tconst gl = this.gl;\n\t\tconst W = Math.ceil(this.canvas.clientWidth),\n\t\t\tH = Math.ceil(this.canvas.clientHeight);\n\t\tif (this.width !== W ||\n\t\t\tthis.height !== H) {\n\t\t\tthis.width = W;\n\t\t\tthis.height = H;\n\t\t\t// Lookup the size the browser is displaying the canvas in CSS pixels\n\t\t\t// and compute a size needed to make our drawingbuffer match it in\n\t\t\t// device pixels.\n\t\t\tconst BW = Math.ceil(W * this.devicePixelRatio);\n\t\t\tconst BH = Math.ceil(H * this.devicePixelRatio);\n\t\t\tthis.canvas.width = BW;\n\t\t\tthis.canvas.height = BH;\n            /*\n            if (gl.canvas.width !== BW ||\n                gl.canvas.height !== BH) {\n                gl.canvas.width = BW;\n                gl.canvas.height = BH;\n                // Set the viewport to match\n                // gl.viewport(0, 0, BW, BH);\n            }\n            */\n\t\t\tfor (const key in this.buffers.values) {\n\t\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\t\tbuffer.resize(gl, BW, BH);\n\t\t\t}\n\t\t\tthis.rect = this.canvas.getBoundingClientRect();\n\t\t\tthis.trigger('resize');\n\t\t\t// gl.useProgram(this.program);\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tload(\n\t\tfragmentString?: string,\n\t\tvertexString?: string\n\t): Promise<boolean> {\n\t\treturn Promise.all([\n\t\t\tContext.getIncludes(fragmentString || this.fragmentString),\n\t\t\tContext.getIncludes(vertexString || this.vertexString)\n\t\t]).then(array => {\n\t\t\tthis.fragmentString = array[0];\n\t\t\tthis.vertexString = array[1];\n\t\t\treturn this.createContext_();\n\t\t});\n\t}\n\n\tgetContext_(): WebGLRenderingContext | WebGL2RenderingContext {\n\t\tconst vertexString = this.vertexString;\n\t\tconst fragmentString = this.fragmentString;\n\t\tthis.vertexString = Context.getVertex(vertexString, fragmentString);\n\t\tthis.fragmentString = Context.getFragment(vertexString, fragmentString);\n\t\tif (Context.versionDiffers(this.gl, vertexString, fragmentString)) {\n\t\t\tthis.destroyContext_();\n\t\t\tthis.swapCanvas_();\n\t\t\tthis.uniforms = new Uniforms();\n\t\t\tthis.buffers = new Buffers();\n\t\t\tthis.textures = new Textures();\n\t\t\tthis.textureList = [];\n\t\t}\n\t\tif (!this.gl) {\n\t\t\tconst gl = Context.tryInferContext(vertexString, fragmentString, this.canvas, this.options, this.options.extensions, this.options.onError);\n\t\t\tif (!gl) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\tthis.gl = gl;\n\t\t}\n\t\treturn this.gl;\n\t}\n\n\tcreateContext_(): boolean {\n\t\tconst gl = this.getContext_();\n\t\tif (!gl) {\n\t\t\treturn false;\n\t\t}\n\t\tlet vertexShader, fragmentShader;\n\t\ttry {\n\t\t\tvertexShader = Context.createShader(gl, this.vertexString, gl.VERTEX_SHADER);\n\t\t\tfragmentShader = Context.createShader(gl, this.fragmentString, gl.FRAGMENT_SHADER);\n\t\t\t// If Fragment shader fails load a empty one to sign the error\n\t\t\tif (!fragmentShader) {\n\t\t\t\tfragmentShader = Context.createShader(gl, ContextDefaultFragment, gl.FRAGMENT_SHADER);\n\t\t\t\tthis.valid = false;\n\t\t\t} else {\n\t\t\t\tthis.valid = true;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t// !!!\n\t\t\t// console.error(e);\n\t\t\tthis.trigger('error', e);\n\t\t\treturn false;\n\t\t}\n\t\t// Create and use program\n\t\tconst program = Context.createProgram(gl, [vertexShader, fragmentShader]); //, [0,1],['a_texcoord','a_position']);\n\t\tgl.useProgram(program);\n\t\t// Delete shaders\n\t\t// gl.detachShader(program, vertexShader);\n\t\t// gl.detachShader(program, fragmentShader);\n\t\tgl.deleteShader(vertexShader);\n\t\tgl.deleteShader(fragmentShader);\n\t\tthis.program = program;\n\t\tif (this.valid) {\n\t\t\ttry {\n\t\t\t\tthis.buffers = Buffers.getBuffers(gl, this.fragmentString, this.vertexString);\n\t\t\t} catch (e) {\n\t\t\t\t// console.error('load', e);\n\t\t\t\tthis.valid = false;\n\t\t\t\tthis.trigger('error', e);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tthis.vertexBuffers = Context.createVertexBuffers(gl, program);\n\t\t\tthis.createUniforms_();\n\t\t}\n\t\t// Trigger event\n\t\tthis.trigger('load', this);\n\t\treturn this.valid;\n\t}\n\n\ttest(\n\t\tfragmentString?: string,\n\t\tvertexString?: string\n\t): Promise<any> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst vertex = this.vertexString;\n\t\t\tconst fragment = this.fragmentString;\n\t\t\tconst paused = this.timer.paused;\n\t\t\t// Thanks to @thespite for the help here\n\t\t\t// https://www.khronos.org/registry/webgl/extensions/EXT_disjoint_timer_query/\n\t\t\tconst extension = this.gl.getExtension('EXT_disjoint_timer_query');\n\t\t\tconst query = extension.createQueryEXT();\n\t\t\tlet wasValid = this.valid;\n\t\t\tif (fragmentString || vertexString) {\n\t\t\t\tthis.load(fragmentString, vertexString);\n\t\t\t\twasValid = this.valid;\n\t\t\t\tthis.render();\n\t\t\t}\n\t\t\tthis.timer.paused = true;\n\t\t\textension.beginQueryEXT(extension.TIME_ELAPSED_EXT, query);\n\t\t\tthis.render();\n\t\t\textension.endQueryEXT(extension.TIME_ELAPSED_EXT);\n\t\t\tconst waitForTest = () => {\n\t\t\t\tthis.render();\n\t\t\t\tconst available = extension.getQueryObjectEXT(query, extension.QUERY_RESULT_AVAILABLE_EXT);\n\t\t\t\tconst disjoint = this.gl.getParameter(extension.GPU_DISJOINT_EXT);\n\t\t\t\tif (available && !disjoint) {\n\t\t\t\t\tconst result = {\n\t\t\t\t\t\twasValid: wasValid,\n\t\t\t\t\t\tfragment: fragmentString || this.fragmentString,\n\t\t\t\t\t\tvertex: vertexString || this.vertexString,\n\t\t\t\t\t\ttimeElapsedMs: extension.getQueryObjectEXT(query, extension.QUERY_RESULT_EXT) / 1000000.0\n\t\t\t\t\t};\n\t\t\t\t\tthis.timer.paused = paused;\n\t\t\t\t\tif (fragmentString || vertexString) {\n\t\t\t\t\t\tthis.load(fragment, vertex);\n\t\t\t\t\t}\n\t\t\t\t\tresolve(result);\n\t\t\t\t} else {\n\t\t\t\t\twindow.requestAnimationFrame(waitForTest);\n\t\t\t\t}\n\t\t\t}\n\t\t\twaitForTest();\n\t\t});\n\t}\n\n\tdestroyContext_(): void {\n\t\tconst gl = this.gl;\n\t\tgl.useProgram(null);\n\t\tif (this.program) {\n\t\t\tgl.deleteProgram(this.program);\n\t\t}\n\t\tfor (const key in this.buffers.values) {\n\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\tbuffer.destroy(gl);\n\t\t}\n\t\tfor (const key in this.textures.values) {\n\t\t\tconst texture: Texture = this.textures.values[key];\n\t\t\ttexture.destroy(gl);\n\t\t}\n\t\tthis.buffers = null;\n\t\tthis.textures = null;\n\t\tthis.uniforms = null;\n\t\tthis.program = null;\n\t\tthis.gl = null;\n\t}\n\n\tswapCanvas_(): void {\n\t\tconst canvas = this.canvas;\n\t\tconst canvas_ = canvas.cloneNode() as HTMLCanvasElement;\n\t\tcanvas.parentNode.replaceChild(canvas_, canvas);\n\t\tthis.canvas = canvas_;\n\t\tthis.addCanvasListeners_();\n\t}\n\n\tdestroy(): void {\n\t\tthis.removeListeners_();\n\t\tthis.destroyContext_();\n\t\tthis.animated = false;\n\t\tthis.valid = false;\n\t\tCanvas.items.splice(Canvas.items.indexOf(this), 1);\n\t}\n\n\tloadTexture(\n\t\tkey: string,\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t\toptions: ITextureOptions = {}\n\t) {\n\t\tif (this.valid) {\n\t\t\t// Logger.log('GlslCanvas.loadTexture', key, urlElementOrData);\n\t\t\tthis.textures.createOrUpdate(this.gl, key, urlElementOrData, this.buffers.count, options, this.options.workpath).then(\n\t\t\t\ttexture => {\n\t\t\t\t\tconst index = texture.index;\n\t\t\t\t\tconst uniform = this.uniforms.createTexture(key, index);\n\t\t\t\t\tuniform.texture = texture;\n\t\t\t\t\tconst keyResolution = key.indexOf('[') !== -1 ? key.replace('[', 'Resolution[') : key + 'Resolution';\n\t\t\t\t\t// const uniformResolution = ;\n\t\t\t\t\tthis.uniforms.create(UniformMethod.Uniform2f, UniformType.Float, keyResolution, [texture.width, texture.height]);\n\t\t\t\t\t// Logger.log('loadTexture', key, url, index, texture.width, texture.height);\n\t\t\t\t\treturn texture;\n\t\t\t\t},\n\t\t\t\terror => {\n\t\t\t\t\tconst message = Array.isArray(error.path) ? error.path.map((x: any) => x.error ? x.error.message : '').join(', ') : error.message;\n\t\t\t\t\tLogger.log('GlslCanvas.loadTexture.error', key, urlElementOrData, message);\n\t\t\t\t\tthis.trigger('textureError', { key, urlElementOrData, message });\n\t\t\t\t});\n\t\t} else {\n\t\t\tthis.textureList.push({ key, url: urlElementOrData, options });\n\t\t}\n\t}\n\n\tsetTexture(\n\t\tkey: string,\n\t\turlElementOrData: string | HTMLCanvasElement | HTMLImageElement | HTMLVideoElement | Element | ITextureData,\n\t\toptions: ITextureOptions = {}\n\t): void {\n\t\treturn this.setUniform_(key, [urlElementOrData], options);\n\t}\n\n\tsetUniform(key: string, ...values: any[]): void {\n\t\treturn this.setUniform_(key, values);\n\t}\n\n\tsetUniformOfInt(key: string, values: any[]): void {\n\t\treturn this.setUniform_(key, values, null, UniformType.Int);\n\t}\n\n\tsetUniforms(values: IUniformOption): void {\n\t\tfor (const key in values) {\n\t\t\tthis.setUniform(key, values[key]);\n\t\t}\n\t}\n\n\tpause(): void {\n\t\tif (this.valid) {\n\t\t\tthis.timer.pause();\n\t\t\tthis.canvas.classList.add('paused');\n\t\t\tthis.trigger('pause');\n\t\t}\n\t}\n\n\tplay(): void {\n\t\tif (this.valid) {\n\t\t\tthis.timer.play();\n\t\t\tthis.canvas.classList.remove('paused');\n\t\t\tthis.trigger('play');\n\t\t}\n\t}\n\n\ttoggle(): void {\n\t\tif (this.valid) {\n\t\t\tif (this.timer.paused) {\n\t\t\t\tthis.play();\n\t\t\t} else {\n\t\t\t\tthis.pause();\n\t\t\t}\n\t\t}\n\t}\n\n\tcheckRender(): void {\n\t\tif (this.isVisible_() && (this.sizeDidChanged_() || this.isAnimated_() || this.isDirty_())) {\n\t\t\tthis.render();\n\t\t\tthis.canvas.classList.add('playing');\n\t\t} else {\n\t\t\tthis.canvas.classList.remove('playing');\n\t\t}\n\t}\n\n\trender(): void {\n\t\tconst gl = this.gl;\n\t\tif (!gl) {\n\t\t\treturn;\n\t\t}\n\t\tconst BW = gl.drawingBufferWidth;\n\t\tconst BH = gl.drawingBufferHeight;\n\t\tthis.updateUniforms_();\n\t\tfor (const key in this.buffers.values) {\n\t\t\tconst buffer: IOBuffer = this.buffers.values[key];\n\t\t\tthis.uniforms.apply(gl, buffer.program);\n\t\t\tbuffer.render(gl, BW, BH);\n\t\t}\n\t\tgl.useProgram(this.program);\n\t\tthis.uniforms.apply(gl, this.program);\n\t\tgl.viewport(0, 0, BW, BH);\n\t\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\n\t\tgl.drawArrays(gl.TRIANGLES, 0, 6);\n\t\tthis.uniforms.clean();\n\t\tthis.textures.clean();\n\t\tthis.dirty = false;\n\t\tthis.trigger('render', this);\n\t}\n\n}\n\nif (document) {\n\tdocument.addEventListener(\"DOMContentLoaded\", () => {\n\t\tCanvas.loadAll();\n\t});\n}\n"]}